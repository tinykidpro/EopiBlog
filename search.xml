<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hướng dẫn dùng Github cho SysAdmin</title>
      <link href="/2019/12/05/github/"/>
      <url>/2019/12/05/github/</url>
      
        <content type="html"><![CDATA[<h2 id="Git-va-Github-cho-sysadmin"><a href="#Git-va-Github-cho-sysadmin" class="headerlink" title="Git và Github cho sysadmin"></a>Git và Github cho sysadmin</h2><h3 id="Muc-luc"><a href="#Muc-luc" class="headerlink" title="Mục lục"></a>Mục lục</h3><p><a href="#Modau">I. Mở đầu</a></p><p><a href="#ngonngumarkdown">II. Ngôn ngữ Markdown</a></p><ul><li><a href="#thetieude">1. Thẻ tiêu đề</a></li><li><a href="#chenlinkchenanh">2. Chèn link, chèn ảnh</a></li><li><a href="#kytuindaminnghieng">3. Ký tự in đậm, in nghiêng</a></li><li><a href="#trichdanbochu">4. Trích dẫn, bo chữ</a></li><li><a href="#gachdaudong">5. Gạch đầu dòng</a></li><li><a href="#taobang">6. Tạo bảng</a></li><li><a href="#meo">Mẹo</a></li></ul><p><a href="#cacthaotacvoigitvagithub">III. Các thao tác với git và github</a></p><ul><li><p><a href="#repo">0. Repo</a></p></li><li><p><a href="#caidat">1. Cài đặt</a></p><ul><li><a href="#linux">1.1. Linux</a></li><li><a href="#windows">1.2. Windows</a></li></ul></li><li><p><a href="#thaotacvoirepo">2. Thao tác với Repo</a></p><ul><li><a href="#21trenlinux">2.1. Trên Linux</a><ul><li><a href="#211taomoi">2.1.1. Tạo mới</a></li><li><a href="#212clone">2.1.2. Clone</a></li><li><a href="#213addcommitpush">2.1.3. Add, commit, push</a></li><li><a href="#214pull">2.1.4. Pull</a></li></ul></li><li><a href="#22trenwindows">2.2. Trên Windows</a><ul><li><a href="#221taomotrepomoi">2.2.1. Tạo một repo mới</a></li><li><a href="#222clone">2.2.2. Clone</a></li><li><a href="#223">2.2.3. Add, commit, push, pull </a></li></ul></li></ul></li><li><p><a href="#3">3. Thao tác với tổ chức trong Github</a></p></li><li><p><a href="#4">4. Thao tác với nhánh (branch)</a></p></li><li><p><a href="#5">5. Issues</a></p></li></ul><p><a href="#Tongket">Tổng kết</a></p><p>===========================</p><p><a name="Modau"></a></p><h2 id="I-Mo-dau"><a href="#I-Mo-dau" class="headerlink" title="I. Mở đầu"></a>I. Mở đầu</h2><p><code>Git</code> là một phần mềm dùng để quản lý phiên bản của mã nguồn tương tự như <code>SVN</code> nhưng có nhiều ưu điểm hơn, <code>Git</code> đang được sủ dụng rộng rãi hiện nay.<br>Tuy nhiên trong bài viết này, tôi sẽ nói về git một cách “cá nhân” hơn, mang tính chia sẻ những cái tôi hay làm và hướng tới những người là sysadmin. Mong nhận được ý kiến đóng góp của các bạn.</p><h4 id="Mot-so-khai-niem-can-lam-ro"><a href="#Mot-so-khai-niem-can-lam-ro" class="headerlink" title="Một số khái niệm cần làm rõ"></a>Một số khái niệm cần làm rõ</h4><p><strong><code>Git</code> và <code>Github</code> khác nhau như thế nào?</strong></p><p>Lấy ví dụ, bạn có một đoạn script dài 20 dòng, hôm sau bạn tối ưu nó đi, chỉ còn 15 dòng, một ngày khác bạn sửa ở script đó một vài chỗ. Git ghi lại những thời điểm thay đổi đó của bạn và source code của bạn tại thời điểm đó.</p><p>Github là một trang web, cho phép bạn lưu source code của mình lên đó. Sự kết hợp hoàn hảo giữa Git và Github mang lại một sự thuận tiện không hề nhỏ cho người dùng. Bạn có thể thay đổi đoạn code của mình mọi lúc mọi nơi mà không sợ bị ghi đè lên hay bị mất dữ liệu do hỏng hóc vì dữ liệu của bạn được lưu cả trên trang web Github và máy cá nhân. Bạn cũng có thể khôi phục được code của mình về một thời điểm bất kỳ nào đó.</p><p>Github có bản free và mất phí. Với Github free thì source code của bạn sẽ công khai, có nghĩa là ai cũng có thể xem code của bạn. Nó phù hợp với các phần mềm nguồn mở, và cũng có thể trở thành một blog cá nhân của chính các bạn như các trang blogspot, wordpress,…</p><p>Muốn có thể tạo một kho code bí mật của riêng mình thì bạn phải trả phí.</p><p>Đối với cá nhân tôi thì github free là quá đủ cho mục đích lưu trữ và chia sẻ thông tin.</p><p><strong>Cần phải làm gì để có thể sử dụng <code>Github</code>?</strong></p><ul><li>B1: Đăng ký một tài khoản tại <a href="https://github.com" target="_blank" rel="noopener">github</a> và đăng nhập</li></ul><p>Tôi chắc chắn rằng một khi bạn đã đọc đến đây thì bạn đã biết thực hiện bước trên như thế nào :)</p><ul><li>B2: Học cách sử dụng ngôn ngữ <code>Markdown</code></li></ul><p>Bạn có thể bỏ qua bước này nếu bạn đã biết hoặc các bạn xác định không sử dụng nó để viết.</p><p>Theo cá nhân tôi thì các bạn nên viết bằng Markdown trong Github vì nó sẽ mang lại sự tường minh cho bài viết của bạn.</p><p>Bạn chỉ cần bỏ ra khoảng 2h là đã có thể sử dụng ngôn ngữ này như ý muốn.</p><ul><li>B3: Tạo một repo đầu tiên và gõ Hello world bằng Markdown</li></ul><p>Sau đó tạo các repo tùy mục đích, clone nó về client và code.</p><p>Bước này tôi sẽ hướng dẫn chi tiết hơn ở phần sau.</p><p><a name="ngonngumarkdown"></a></p><h2 id="II-Ngon-ngu-Markdown"><a href="#II-Ngon-ngu-Markdown" class="headerlink" title="II. Ngôn ngữ Markdown"></a>II. Ngôn ngữ Markdown</h2><p>Ngôn ngữ này khá đơn giản, bạn có thể đọc tại <a href="http://daringfireball.net/projects/markdown/syntax" target="_blank" rel="noopener">đây</a> để biết cách sử dụng.</p><p>Nhưng với tôi, tôi không dùng hết từng ấy thứ cho nên tôi chỉ nhớ một số cái tôi hay dùng, cách tôi dùng như sau:</p><p>Tạo một file có tên bất kỳ với đuôi .md. Có thể dùng <code>notepad</code>, <code>notepad++</code>, <code>vi</code>, <code>nano</code>,… hay bất cứ thứ gì mà bạn muốn.</p><p>Một số phương pháp tôi hay sử dụng để viết:</p><p><a name="thetieude"></a></p><h3 id="1-The-tieu-de"><a href="#1-The-tieu-de" class="headerlink" title="1. Thẻ tiêu đề"></a>1. Thẻ tiêu đề</h3><p>Markdown sử dụng kí tự # để bắt đầu cho các thẻ tiêu đề, có thể dùng từ 1 đến 6 ký tự # liên tiếp. Mức độ riêu đề giảm dần từ 1 đến 6</p><p>Tùy mục đích và ý thích bạn có thể sử dụng cách này để thể hiện các chỉ mục khác nhau.</p><p>Ví dụ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># 1.Tiêu đề cấp 1</span></pre></td></tr></table></figure><h1 id="1-Tieu-de-cap-1"><a href="#1-Tieu-de-cap-1" class="headerlink" title="1.Tiêu đề cấp 1"></a>1.Tiêu đề cấp 1</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">## 2.Tiêu đề cấp 2</span></pre></td></tr></table></figure><h2 id="2-Tieu-de-cap-2"><a href="#2-Tieu-de-cap-2" class="headerlink" title="2.Tiêu đề cấp 2"></a>2.Tiêu đề cấp 2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">###### 6.Tiêu đề cấp 6</span></pre></td></tr></table></figure><h6 id="6-Tieu-de-cap-6"><a href="#6-Tieu-de-cap-6" class="headerlink" title="6.Tiêu đề cấp 6"></a>6.Tiêu đề cấp 6</h6><p><a name="chenlinkchenanh"></a></p><h3 id="2-Chen-link-chen-anh"><a href="#2-Chen-link-chen-anh" class="headerlink" title="2. Chèn link, chèn ảnh"></a>2. Chèn link, chèn ảnh</h3><p>Để chèn hyperlink bạn chỉ cần paste luôn linh đó vào file .md</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com</span></pre></td></tr></table></figure><p><a href="https://github.com" target="_blank" rel="noopener">https://github.com</a></p><p>Hoặc bạn cũng có thể sử dụng cú pháp sau để thu ngắn đường dẫn của link</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">[Github](https:&#x2F;&#x2F;github.com)</span></pre></td></tr></table></figure><p>Kết quả là:</p><p><a href="https://github.com" target="_blank" rel="noopener">Github</a></p><p>Để chèn ảnh thì bạn hãy sử dụng cú pháp sau:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;link_anh_cua_ban&quot;&gt;</span></pre></td></tr></table></figure><p>Tôi thường sử dụng công cụ <a href="https://app.prntscr.com/en/index.html" target="_blank" rel="noopener">Lightshot</a> để chụp ảnh màn hình và up hình đó lên trang <a href="http://i.imgur.com/" target="_blank" rel="noopener">http://i.imgur.com/</a> để lấy đường dẫn ảnh đưa vào Github</p><p>Hai công cụ này khá dễ sử dụng, bạn chỉ cần chụp màn hình bằng Lightshot ấn Ctrl + C để copy và Ctrl + V để paste vào trình duyệt tại trang web <a href="http://i.imgur.com/" target="_blank" rel="noopener">http://i.imgur.com/</a></p><p><a name="kytuindaminnghieng"></a></p><h3 id="3-Ky-tu-in-dam-in-nghieng"><a href="#3-Ky-tu-in-dam-in-nghieng" class="headerlink" title="3. Ký tự in đậm, in nghiêng"></a>3. Ký tự in đậm, in nghiêng</h3><ul><li>Để in đậm một đoạn text  bạn chỉ cần làm như sau:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">**từ cần in đậm**</span></pre></td></tr></table></figure><p><strong>từ cần in đậm</strong></p><ul><li>Để in nghiên một đoạn text  bạn chỉ cần làm như sau:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">*từ cần in nghiêng*</span></pre></td></tr></table></figure><p><em>từ cần in nghiêng</em></p><p><a name="trichdanbochu"></a></p><h3 id="4-Trich-dan-bo-chu"><a href="#4-Trich-dan-bo-chu" class="headerlink" title="4. Trích dẫn, bo chữ"></a>4. Trích dẫn, bo chữ</h3><p>Để bo một đoạn text thì bạn chỉ cần sử dụng cú pháp sau:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#96;đoạn cần bo&#96;</span></pre></td></tr></table></figure><p>Kết quả là: <code>đoạn cần bo</code></p><p>Để làm nổi bật một đoạn, chẳng hạn như một đoạn shell hay file cấu hình bạn có thể sử dụng cú pháp như ví dụ sau:</p><pre><code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">   auto eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   iface eth0 inet static</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   ipaddress 10.10.10.10</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">netmask 255.255.255.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">gateway 10.10.10.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">dns-nameservers 8.8.8.8</span></pre></td></tr></table></figure></code></pre><p>Kết quả như sau:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">auto eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">iface eth0 inet static</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ipaddress 10.10.10.10</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">netmask 255.255.255.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">gateway 10.10.10.1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">dns-nameservers 8.8.8.8</span></pre></td></tr></table></figure><p><a name="gachdaudong"></a></p><h3 id="5-Gach-dau-dong"><a href="#5-Gach-dau-dong" class="headerlink" title="5. Gạch đầu dòng"></a>5. Gạch đầu dòng</h3><p>Để sử dụng gạch đầu dòng bạn chỉ cần sử dụng cú pháp sau:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">- Gạch đầu dòng thứ nhất</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  - Thụt với đầu dòng 1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  - Thụt với đầu dòng 1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">- Gạch đầu dòng thứ hai</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  - Thụt với đầu dòng 2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  - Thụt với đầu dòng 2</span></pre></td></tr></table></figure><ul><li><p>Gạch đầu dòng thứ nhất</p><ul><li><p>Thụt với đầu dòng 1</p></li><li><p>Thụt với đầu dòng 1</p></li></ul></li><li><p>Gạch đầu dòng thứ hai</p><ul><li><p>Thụt với đầu dòng 2</p></li><li><p>Thụt với đầu dòng 2</p></li></ul></li></ul><p><a name="taobang"></a></p><h3 id="6-Tao-bang"><a href="#6-Tao-bang" class="headerlink" title="6. Tạo bảng"></a>6. Tạo bảng</h3><p>Bạn có thể sử dụng cú pháp sau để tạo bảng:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">| Cột 1 Hàng 1 | Cột 2 | Cột 3| Cột 4 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">|--------------|-------|------|-------|</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">| Hàng 2 | 2 x 1 | 2 x 2 | 2 x 3 | 2 x 4 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">| Hàng 3 | 3 x 1 | 3 x 2 | 3 x 3 | 3 x 4 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">| Hàng 4 | 4 x 1 | 4 x 2 | 4 x 3 | 4 x 4 |</span></pre></td></tr></table></figure><p>Kết quả:</p><table><thead><tr><th>Cột 1 Hàng 1</th><th>Cột 2</th><th>Cột 3</th><th>Cột 4</th></tr></thead><tbody><tr><td>Hàng 2</td><td>2 x 1</td><td>2 x 2</td><td>2 x 3</td></tr><tr><td>Hàng 3</td><td>3 x 1</td><td>3 x 2</td><td>3 x 3</td></tr><tr><td>Hàng 4</td><td>4 x 1</td><td>4 x 2</td><td>4 x 3</td></tr></tbody></table><p><a name="meo"></a><br>###<em>Mẹo:</em></p><ul><li><p>Sử dụng trang <a href="http://markdownlivepreview.com/" target="_blank" rel="noopener">http://markdownlivepreview.com/</a> paste vào đó đoạn markdown bạn viết và xem trước để chỉnh sửa cho phù hợp.</p></li><li><p>Bạn cũng có thể sử dụng những đoạn markdown của người khác đã viết trước để tham khảo.</p></li></ul><p>Như vậy bạn đã có thể trình bày github của mình một cách sáng sủa bằng markdown.</p><p><a name="cacthaotacvoigitvagithub"></a></p><h2 id="III-Cac-thao-tac-voi-Git-va-Github"><a href="#III-Cac-thao-tac-voi-Git-va-Github" class="headerlink" title="III. Các thao tác với Git và Github"></a>III. Các thao tác với Git và Github</h2><p><a name="repo"></a></p><h3 id="0-Repo"><a href="#0-Repo" class="headerlink" title="0. Repo"></a>0. Repo</h3><p>Git là một công cụ để quản lý mã nguồn, nhưng tôi không phải là một coder nên tôi sẽ không sử dụng Git theo cách mà các coder hay sử dụng.<br>Tôi sử dụng git và github để lưu trữ các file cấu hình của mình, các script, viết các bài hướng dẫn, các bản nháp,…<br>Các repo là những nơi tôi phân loại, lưu trữ những thứ bên trên và nó được lưu cả ở máy trạm và ở server github.<br>Để làm việc với repo thì bạn phải hiểu về nó. Một số điều bạn cần biết là: </p><p><strong>Ba trạng thái của một repo:</strong></p><p><img alt="github" data-src="https://camo.githubusercontent.com/7267ce98820c8a0bc451c38809d7d58b84be5785/687474703a2f2f692e696d6775722e636f6d2f716b6d644a53522e706e67" class="lazyload"></p><p>Như hình trên bạn có thể thấy có 3 điểm cần lưu ý:</p><ul><li><p>Working dir: đây là nơi bạn thực hiện các thao tác chỉnh sửa với file mã nguồn của mình, nó có thể là eclipse, netbean, notepad++,…</p></li><li><p>Stagging area: những sự thay đổi của bạn với file mã nguồn được lưu lại, giống như bạn ấn Save trong một file notepad.</p></li><li><p>Git directory: nơi lưu trữ mã nguồn của bạn (ở đây là github)</p></li></ul><p>Tương ứng với 3 vị trí này ta có các hành động:</p><ul><li><p>Add: lưu file thay đổi (mang tính cục bộ) - tương ứng với câu lệnh <code>git add</code></p></li><li><p>Commit: Ghi lại trạng thái thay đổi tại máy local (ví dụ như bạn có thể ấn Save nhiều lần với file README.md nhưng chỉ khi commit thì trạng thái của lần ấn Save cuối cùng trước đó mới được lưu lại) - tương ứng với câu lệnh <code>git commit</code></p></li><li><p>Push: Đẩy những thay đổi từ máy trạm lên server - tương đương lệnh <code>git push</code></p></li><li><p>Pull: đồng bộ trạng thái từ server về máy trạm - tương đương lệnh <code>git pull</code></p></li></ul><p><a name="caidat"></a></p><h3 id="1-Cai-dat"><a href="#1-Cai-dat" class="headerlink" title="1. Cài đặt"></a>1. Cài đặt</h3><p><a name="linux"></a></p><h4 id="1-1-Linux"><a href="#1-1-Linux" class="headerlink" title="1.1. Linux"></a>1.1. Linux</h4><p>Với OS là Ubuntu:</p><blockquote><p>apt-get install git</p></blockquote><p>Với OS là Fedora, Centos</p><blockquote><p>yum instal git</p></blockquote><p>Các thiết lập ban đầu:</p><ul><li>Bạn cần thiết lập tên và email của mình để mỗi khi commit lên server sẽ nhận biết được ai commit lên vì một repo có thể có nhiều người tham gia.</li></ul><blockquote><p>git config –global user.name “Duc NC”</p></blockquote><blockquote><p>git config –global user.email <a href="mailto:nguyencongduc3112@gmail.com" target="_blank" rel="noopener">nguyencongduc3112@gmail.com</a></p></blockquote><ul><li>Lựa chọn trình soạn thảo mặc định, có thể là vi, vim, nano,…</li></ul><blockquote><p>git config –global core.editor vi</p></blockquote><ul><li>Liệt kê các thiết lập:</li></ul><blockquote><p>git config –list</p></blockquote><p><strong>Liên kết với tài khoản github bằng SSH</strong></p><blockquote><p>ssh-keygen -t rsa</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): [Press enter]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): [Press enter]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Enter same passphrase again: [Press enter]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span></pre></td></tr></table></figure><p>Nếu bạn nhập passphrase thì hãy nhớ pass này!</p><p>Kết quả:</p><blockquote><p>ls ~/.ssh/</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">id_rsa       id_rsa.pub   known_hosts</span></pre></td></tr></table></figure><blockquote><p>ssh-agent -s</p></blockquote><blockquote><p>ssh-add ~/.ssh/id_rsa</p></blockquote><blockquote><p>cat ~/.ssh/id_rsa.pub</p></blockquote><p>copy đoạn mã này</p><p>Truy cập đường dẫn sau <a href="https://github.com/settings/ssh" target="_blank" rel="noopener">https://github.com/settings/ssh</a> (đảm bảo bạn đã đăng nhập vào github), chọn Add SSH key, đặt tên cho key này tại <code>Title</code> và paste nội dung vừa copy vào ô <code>Key</code></p><p><img alt="github" data-src="https://camo.githubusercontent.com/c35e7a87819596bebc9e28e8d16c654af2c28df7/687474703a2f2f692e696d6775722e636f6d2f7a757861765a352e706e67" class="lazyload"></p><p>Lúc này bạn đã có thể commit lên github tại máy local mà không cần nhập username và password.</p><p><a name="windows"></a></p><h4 id="1-2-Windows"><a href="#1-2-Windows" class="headerlink" title="1.2. Windows"></a>1.2. Windows</h4><p>Download tại địa chỉ: <a href="https://windows.github.com/" target="_blank" rel="noopener">https://windows.github.com/</a></p><p>Cài đặt bình thường, yêu cầu phải có .NET 4.5</p><p>Giao diện của chương trình:</p><p><img alt="github" data-src="https://camo.githubusercontent.com/58b5fedd92a98e6f20a1d29b6a13e29f23d28edc/687474703a2f2f692e696d6775722e636f6d2f45627836644a442e706e67" class="lazyload"></p><p>Thêm tài khoản Github:</p><ul><li><p>Click vào tool and options (hình bánh răng cạnh biểu tượng Sync) chọn options, Add account. Khai báo username và password trên github.</p></li><li><p>Tại mục Configure git thêm Tên và email của mình</p></li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/ed31aeacc9af0413fd01a1dd09d5f799504c2181/687474703a2f2f692e696d6775722e636f6d2f44534c503630692e706e67" class="lazyload"></p><p>Click Update</p><p><a name="thaotacvoirepo"></a></p><h3 id="2-Thao-tac-voi-Repo"><a href="#2-Thao-tac-voi-Repo" class="headerlink" title="2. Thao tác với Repo"></a>2. Thao tác với Repo</h3><p><a name="21trenlinux"></a></p><h4 id="2-1-Tren-Linux"><a href="#2-1-Tren-Linux" class="headerlink" title="2.1. Trên Linux"></a>2.1. Trên Linux</h4><p><a name="211taomoi"></a></p><h5 id="2-1-1-Tao-moi"><a href="#2-1-1-Tao-moi" class="headerlink" title="2.1.1. Tạo mới"></a>2.1.1. Tạo mới</h5><p>Tạo một repo mới trên trang github.com</p><p><img alt="github" data-src="https://camo.githubusercontent.com/9aa3b64890ea8ff7e8520d6857db5fd71c839319/687474703a2f2f692e696d6775722e636f6d2f616c5246574b6c2e706e67" class="lazyload"></p><p><img alt="github" data-src="https://camo.githubusercontent.com/33ade8c1712f9e55e9f9a91ee454b365204fb68c/687474703a2f2f692e696d6775722e636f6d2f4d4a5a6a594d6d2e706e67" class="lazyload"></p><p><a name="212clone"></a></p><h5 id="2-1-2-Clone"><a href="#2-1-2-Clone" class="headerlink" title="2.1.2. Clone"></a>2.1.2. Clone</h5><p>Clone repo đó về bằng một trong các cách sau:</p><p><strong>Linux</strong></p><p><strong><em>SSH:</em></strong><br><code>git clone git@github.com:ducnc92/demo1.git</code></p><p>hoặc: <code>git clone git@github.com:ducnc92/demo1.git /opt/demo</code> để clone vào thư mục /opt/demo</p><p>đối với phương pháp này các bạn cần nhập passphrase của ~/.ssh/id_rsa (có thể không cần nếu bạn không đặt passphrase)</p><p><strong><em>HTTPS:</em></strong><br><code>git clone https://github.com/ducnc92/demo1.git</code></p><p>hoặc: <code>git clone https://github.com/ducnc92/demo1.git /opt/demo</code> để clone vào thư mục /opt/demo</p><p>Để lấy các link SSH, HTTPS này ta làm như sau: Click vào các hyperlink HTTPS hoặc SSH rồi click Copy to clipboard.</p><p><img alt="github" data-src="https://camo.githubusercontent.com/e26cdd17e33c7669d443d46461973359c0173b48/687474703a2f2f692e696d6775722e636f6d2f31446f7a41567a2e706e67" class="lazyload"></p><p>Ở đây tôi sử dụng lệnh <code>git clone git@github.com:ducnc92/demo1.git</code></p><p>Lúc này trong thư mục hiện tại sẽ có thêm thư mục demo1 chứa các file trong repo trên github.</p><p>Chuyển vào thư mục này:</p><blockquote><p>cd demo1/</p></blockquote><blockquote><p>ls</p></blockquote><p>Lúc này sẽ thấy trong thư mục này có file <code>README.md</code>. Để sửa file này ta có thể sử dụng bất cứ trình soạn thảo nào, chẳng hạn vi, nano, gedit,…</p><blockquote><p>vi README.md</p></blockquote><p>Thêm vào nội dung như sau:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Xin chao!</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Toi la Ducnc.</span></pre></td></tr></table></figure><p>Tạo một thư mục mới, chẳng hạn tên là script để chứa các script của tôi.</p><blockquote><p>mkdir script</p></blockquote><p>Tạo một script mới trong thư mục đó.</p><blockquote><p>vi script/script1.sh</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Hello Python Vietnam"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">sleep 10</span></pre></td></tr></table></figure><p>bằng cách tương tự các bạn có thể tạo thêm nhiều thư mục, file hướng dẫn, cấu hình, script,… tùy ý</p><p><a name="213addcommitpush"></a></p><h5 id="2-1-3-Add-commit-push"><a href="#2-1-3-Add-commit-push" class="headerlink" title="2.1.3. Add, commit, push"></a>2.1.3. Add, commit, push</h5><p>Để thực hiện hành động <code>add</code> ta sử dụng lệnh sau</p><blockquote><p>git add README.md<br>để <code>add</code> file README.md</p></blockquote><p>hoặc <code>git add *</code> để add tất cả các file hiện có.</p><p>Để thự hiện hành động commit file README.md ta thực hiện lệnh</p><blockquote><p>git commit README.md</p></blockquote><p>hoặc <code>git commit *</code> để commit tất cả.</p><p>ta nên thêm tham số -m để ghi lại một comment cho hành động đó</p><blockquote><p>git commit README.md -m “ducnc sua doi” </p></blockquote><p>Lúc này các thay đổi của bạn đã được lưu lại trên máy cục bộ. Để đồng bộ lên server Github ta thực hiện lệnh:</p><blockquote><p>git push origin master</p></blockquote><p>=&gt; nhập passphrase (nếu bạn đặt passphrase ở mục 1.1.) với phương pháp clone ssh hoặc nhập username, password nếu clone bằng https</p><p><img alt="github" data-src="https://camo.githubusercontent.com/6e4b8ef711b58d97bdd5658915ded7a9801d53d0/687474703a2f2f692e696d6775722e636f6d2f564f50537a42542e706e67" class="lazyload"></p><p>Lúc này trở lại trang github.com và xem <code>repo script</code> lúc đầu sẽ thấy các commit của ta đã được đẩy lên.</p><p><img alt="github" data-src="https://camo.githubusercontent.com/33b4a7756dfe36d6526aaee859681f701735355a/687474703a2f2f692e696d6775722e636f6d2f544e417a79356d2e706e67" class="lazyload"></p><p>Một cách khác nếu bạn không muốn thực hiện clone về máy như bước trên thì bạn có thể làm như sau:</p><ul><li><p>Tạo một repo mới trên github.com mà không tạo file README.md (giả sử ở đây là repo demo2)</p></li><li><p>Tại máy local tạo một thư mục để chứa repo mới này. Ví dụ:</p></li></ul><blockquote><p>mkdir /opt/demo2</p></blockquote><blockquote><p>cd /opt/demo2</p></blockquote><ul><li>Thực hiện tạo các file, thư mục như ý muốn. Sau đó thực hiện add, commit, push tương tự như trên<br>Nhưng ở đây cần thêm lệnh <code>git remote add origin $git-url</code> trước khi push. Tham khảo ví dụ sau:</li></ul><blockquote><p>vi README.md</p></blockquote><blockquote><p>git add README.md</p></blockquote><blockquote><p>git commit README.md</p></blockquote><p>hoặc <code>git commit README.md -m noi dung</code></p><blockquote><p>git remote add origin <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:ducnc92/demo2.git</p></blockquote><blockquote><p>git push origin master</p></blockquote><p>Sau đó nhập passphrase(nếu cần) hoặc username + password (nếu sử dụng SSH)</p><p><a name="214pull"></a></p><h5 id="2-1-4-Pull"><a href="#2-1-4-Pull" class="headerlink" title="2.1.4. Pull"></a>2.1.4. Pull</h5><p>Giả sử trên server github của bạn có những thay đổi mà máy local chưa cập nhật những thay đổi đó. Bạn thực hiện lệnh sau:</p><blockquote><p>cd cd /opt/demo1/</p></blockquote><blockquote><p>git pull</p></blockquote><p><a name="22trenwindows"></a></p><h4 id="2-2-Tren-Windows"><a href="#2-2-Tren-Windows" class="headerlink" title="2.2. Trên Windows"></a>2.2. Trên Windows</h4><p><a name="221taomotrepomoi"></a></p><h5 id="2-2-1-Tao-mot-repo-moi"><a href="#2-2-1-Tao-mot-repo-moi" class="headerlink" title="2.2.1. Tạo một repo mới"></a>2.2.1. Tạo một repo mới</h5><p>Tạo repo trên github.com tự như mục 2.1.1.</p><p>Tạo repo bằng phần mềm Github</p><ul><li>Click vào dấu cộng, chọn tab Create, đặt tên và chọn đường dẫn cho repo mới</li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/0736481c445eccf6136f085a8e9677ca7c7b22c7/687474703a2f2f692e696d6775722e636f6d2f4d5872705a5a752e706e67" class="lazyload"></p><ul><li>Tuy nhiên repo mới sinh ra mới chỉ có ở máy trạm, tại mục <code>Other</code>. Chọn chuột phải vào repo đó và chọn <code>Open in Explorer</code> để sửa nội dung của repo này.</li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/c75286677894c52c2857c226af9b286d853b1ca2/687474703a2f2f692e696d6775722e636f6d2f7634446b6469772e706e67" class="lazyload"></p><ul><li>Sau khi chỉnh sửa xong, để đẩy repo đó lên github.com ta click vào <code>Publish this repository</code> và thực hiện như hình sau. Chú ý cần chọn Organization đặt repo này.</li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/0272461f8ac66b6f5947009492a133e37b16c629/687474703a2f2f692e696d6775722e636f6d2f366b586544664c2e706e67" class="lazyload"></p><p><a name="222clone"></a></p><h5 id="2-2-2-Clone"><a href="#2-2-2-Clone" class="headerlink" title="2.2.2. Clone"></a>2.2.2. Clone</h5><p>Click vào dấu cộng, chọn tab Clone, lựa chọn tổ chức mong muốn và chọn repo cần clone</p><p><img alt="github" data-src="https://camo.githubusercontent.com/c4302bda4555680018816b67ebecc331b8246578/687474703a2f2f692e696d6775722e636f6d2f596c72544f7a512e706e67" class="lazyload"></p><p>Để chỉnh sửa nội dung của repo này ta chọn chuột phải vào nó và chọn <code>Open in Explorer</code></p><p><img alt="github" data-src="https://camo.githubusercontent.com/d34cb73bfee2fd0331365cf459ff1dc613c311b1/687474703a2f2f692e696d6775722e636f6d2f5878384a4f52352e706e67" class="lazyload"></p><p>Lúc đó chương trình Windows Explorer sẽ mở ra thư mục chứa repo của github, bạn có thể chỉnh sửa các file trong này, tạo xóa thư mục,… một cách bình thường.</p><p><a name="223"></a></p><h5 id="2-2-3-Add-commit-push-pull"><a href="#2-2-3-Add-commit-push-pull" class="headerlink" title="2.2.3. Add, commit, push, pull"></a>2.2.3. Add, commit, push, pull</h5><p>Trở lại với chương trình Github ta sẽ thấy dòng <code>uncommited changes</code> tại repo ta vừa sửa. Bạn hãy điền vào đó comment và ấn <code>commit to master</code></p><p><img alt="github" data-src="https://camo.githubusercontent.com/bc970eda541312a96a103ce1a39af1df91bc1047/687474703a2f2f692e696d6775722e636f6d2f4e57583452494d2e706e67" class="lazyload"></p><p>Lúc này sự thay đổi của bạn với mã nguồn đã được ghi lại trên máy local, để đồng bộ nó lên server github bạn hãy ấn vào biểu tượng <code>Sync</code> ở góc trên cùng bên phải.</p><p>Sau khi đồng bộ xong, quay trở lại repo trên trang github.com.</p><p><img alt="github" data-src="https://camo.githubusercontent.com/7301174016243200830794d998faeb9fd1e7af2e/687474703a2f2f692e696d6775722e636f6d2f7846636e6d73492e706e67" class="lazyload"></p><p>Để đồng bộ những thay đổi trên github.com về máy local (pull) ta cũng click vào biểu tượng <code>Sync</code> như bên trên.</p><p><a name="3"></a></p><h3 id="3-Thao-tac-voi-to-chuc-trong-Github"><a href="#3-Thao-tac-voi-to-chuc-trong-Github" class="headerlink" title="3. Thao tác với tổ chức trong Github"></a>3. Thao tác với tổ chức trong Github</h3><p>Để tạo một nhóm cho nhiều người cùng làm việc ta làm như sau:</p><ul><li><p>Truy cập URL: <a href="https://github.com/settings/organizations" target="_blank" rel="noopener">https://github.com/settings/organizations</a>, chọn New Organizations</p></li><li><p>Đặt tên và email cho tổ chức</p></li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/dba455a769d2a5c16e65978fb6b67089c61f433f/687474703a2f2f692e696d6775722e636f6d2f497648656357652e706e67" class="lazyload"></p><p>Tại mục <code>Choose the organization’s plan</code> chọn Open Source để miễn phí, nhưng lúc này các Repo trong tổ chức sẽ là public.</p><ul><li>Mời các thành viên cho tổ chức</li></ul><p><img alt="github" data-src="https://camo.githubusercontent.com/938a1967fd1c18ac6b9eb7ff2efaeef8c59366e7/687474703a2f2f692e696d6775722e636f6d2f78563343756b632e706e67" class="lazyload"></p><p>Lúc này vào trang cá nhân của bạn sẽ thấy tại mục Organizations có tổ chức mới vừa tạo. Để cấu hình tổ chức này ta click thẳng vào nó.</p><p>Ở đây tôi sẽ tạo một team mới như hình sau:</p><p><img alt="github" data-src="https://camo.githubusercontent.com/22088fab52bd8e29fe1a9ef5f6d7285d237fe6ee/687474703a2f2f692e696d6775722e636f6d2f376b574c4e59452e706e67" class="lazyload"></p><p><img alt="github" data-src="https://camo.githubusercontent.com/daf9deade83a8e0aefcfba21fd00f187d4550c63/687474703a2f2f692e696d6775722e636f6d2f7a4f336b767a5a2e706e67" class="lazyload"></p><p>Các member của team này có quyền write với các repo của team.</p><p>Với 3 mức: Read Access, Write Access, Admin Access Github cho phép chúng ta phân quyền tới các thành viên của nhóm.</p><p>Để mời một người dùng khác vào team, ta click vào team đó và search tên của người dùng cần tìm</p><p><img alt="github" data-src="https://camo.githubusercontent.com/73070ffe87ce06e0ee497cbd9a8b48ce14aa05bc/687474703a2f2f692e696d6775722e636f6d2f557365703947502e706e67" class="lazyload"></p><p>Sau đó hệ thống sẽ yêu cầu bạn nhập password để xác thực, nếu thành công, một email xác nhận sẽ được gửi đến người được mời và người này sẽ xác nhận có tham gia vào tổ chức hay không.</p><p>Để tạo một repo cho tổ chức, ta chỉ cần click vào tổ chức đó, sau đó chọn <code>Create new Repostory</code>. Các hành động clone, add, commit,… làm như bình thường.</p><p><a name="4"></a></p><h3 id="4-Thao-tac-voi-nhanh-branch"><a href="#4-Thao-tac-voi-nhanh-branch" class="headerlink" title="4. Thao tác với nhánh (branch)"></a>4. Thao tác với nhánh (branch)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Sẽ cập nhật và bổ sung sau</span></pre></td></tr></table></figure><p><a name="5"></a></p><h3 id="5-Issues"><a href="#5-Issues" class="headerlink" title="5. Issues"></a>5. Issues</h3><p>Giả sử bạn đang theo dõi repo của tôi và thấy có một số chỗ cần sửa đổi, bạn có thể comment ý kiến của mình vào Repo đó. Sau đó người quản trị sẽ xem xét, thay đổi và trả lời bạn.</p><p>Để làm việc này bạn cần vào repo đó, click vào <code>Issue</code>. Ví dụ như hình sau:</p><p><img alt="github" data-src="https://camo.githubusercontent.com/df3b1d430aa429eaccf74a4717483cd8ffe4125f/687474703a2f2f692e696d6775722e636f6d2f4a4769587437362e706e67" class="lazyload"></p><p>Sau đó chọn <code>New issue</code> (màu xanh) để tạo một issue mới.</p><p><img alt="github" data-src="https://camo.githubusercontent.com/14f3b5497be1a1ff7ca164be1bde725471f92349/687474703a2f2f692e696d6775722e636f6d2f52546838516a562e706e67" class="lazyload"></p><p>Lúc này tại Repo của người quản trị sẽ thấy một Issue mới, người quản trị có thể click vào Issue này để xem, sau đó xem xét sửa đổi, comment lại. Khi sửa đổi hoàn tất thì sẽ đóng issue đó lại.</p><p><img alt="github" data-src="https://camo.githubusercontent.com/3decfc9c6b0ed86b28263af42353d3a1d4cf0e6c/687474703a2f2f692e696d6775722e636f6d2f6a38696f5a67412e706e67" class="lazyload"></p><p><img alt="github" data-src="https://camo.githubusercontent.com/1b4d3b1d674b3e80fc5063f3904e6b3645c60804/687474703a2f2f692e696d6775722e636f6d2f664a726f4d74652e706e67" class="lazyload"></p><p>Bằng cách tạo issue, bạn có thể đăng các câu hỏi, thắc mắc của mình cho chủ của repo đó.</p><p><a name="Tongket"></a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> Github </tag>
            
            <tag> Sysadmin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8. Thao tác với container</title>
      <link href="/2019/12/05/docker8/"/>
      <url>/2019/12/05/docker8/</url>
      
        <content type="html"><![CDATA[<h1 id="Thuc-hanh-container"><a href="#Thuc-hanh-container" class="headerlink" title="Thực hành container"></a>Thực hành container</h1><p>Liệt kê số lượng container đang chạy (run) trên host:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker ps</span></pre></td></tr></table></figure><p>Thêm tham số <code>-a</code> để liệt kê tất cả các container đang có trên host (bao gồm cả đang chạy và dừng):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker ps -a</span></pre></td></tr></table></figure><p>Tạo một container từ image, nếu image không có sẵn trên local host thì docker sẽ tìm trên <code>docker hub</code> image phiên bản <code>latest</code> để tải về và chạy:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run ubuntu</span></pre></td></tr></table></figure><ul><li>Thay <code>ubuntu</code> bằng image mà bạn muốn tạo ra container.</li></ul><p>Ví dụ:</p><p><img alt="docker_run" data-src="https://tutorials.ubuntu.com/bundled/src/codelabs/tutorial-windows-ubuntu-hyperv-containers/img/d924bbd7a96719c.png" class="lazyload"></p><p>Đặt tên cho một container khi khởi tạo, thêm tham số <code>--name</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run --name ubuntu_test ubuntu</span></pre></td></tr></table></figure><p>Tạo một docker và sử dụng terminal của docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -it --name ubuntu_test1 ubuntu /bin/bash</span></pre></td></tr></table></figure><p><strong>Note</strong>: Chỉ sử dụng tham số <code>-it</code> thì khi thoát terminal của docker bằng <code>exit</code>, docker sẽ bị dừng.</p><p>Chỉ định chạy một docker dưới nền như một deamon. </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d ubuntu /bin/bash</span></pre></td></tr></table></figure><p>Vào terminal của một container đang chạy</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it ubuntu_test1 /bin/bash</span></pre></td></tr></table></figure><ul><li>Thay <code>ubuntu_test1</code> bằng tên của container</li><li>Chỉ vào terminal của một container khi kiểm tra trạng thái của container bằng lệnh <code>docker ps -a</code> mà container đang ở trạng thái <code>Up</code></li></ul><p>Thoát ra khỏi một container khi đang sử dụng terminal bằng cách:</p><ul><li>Gõ <code>exit</code></li><li>Nhấn tổ hợp phím <code>Ctl+P</code> và <code>Ctl+Q</code></li></ul><p>Xem thông tin chi tiết về một container bằng lệnh:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker inspect ubuntu_test1</span></pre></td></tr></table></figure><ul><li>thay <code>ubuntu_test1</code> bằng tên hoặc ID của container bạn muốn xem.</li></ul><p>Xóa một container ở trạng thái <code>Exited</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rm ubuntu_test</span></pre></td></tr></table></figure><p>Xóa một container ở trạng thái <code>Up</code> thì thêm tham số <code>-f</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rm -f ubuntu_test1</span></pre></td></tr></table></figure><ul><li>Lệnh xóa tất cả các container trên host: <code>docker rm -f $(docker ps -aq)</code></li></ul><p>Commit một container thành image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker commit ubuntu_test1 tannt/ubuntu:latest</span></pre></td></tr></table></figure><ul><li><code>ubuntu_test1</code> là tên của container có trên host</li><li><code>tannt/ubuntu:latest</code> là chỉ định tên của image (kèm repository) là <code>tannt/ubuntu</code> có phiên bản <code>latest</code> </li></ul><p>Khởi động/dừng một container</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker [restart|start|stop] ubuntu_test1</span></pre></td></tr></table></figure><p>Cách tra cứu cú pháp các command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker [<span class="built_in">command</span>] --<span class="built_in">help</span></span></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>7. Thao tác với images</title>
      <link href="/2019/12/05/docker7/"/>
      <url>/2019/12/05/docker7/</url>
      
        <content type="html"><![CDATA[<h1 id="Thuc-hanh-image"><a href="#Thuc-hanh-image" class="headerlink" title="Thực hành image"></a>Thực hành image</h1><p>Tìm kiếm một image từ docker hub, ví dụ tìm kiếm image về apache:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker search apache</span></pre></td></tr></table></figure><ul><li>Thay <code>apache</code> bằng tên image bạn muốn tìm</li></ul><p>Tải một image về máy:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull httpd</span></pre></td></tr></table></figure><ul><li>thay <code>httpd</code> bằng tên image bạn muốn tải về local</li></ul><p>Liệt kê tất cả các image đang có trên local:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker images</span></pre></td></tr></table></figure><p>Xem chi tiết thông tin về image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker image inspect httpd</span></pre></td></tr></table></figure><p>Xem lịch sử các commit của image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> httpd</span></pre></td></tr></table></figure><ul><li>thay <code>httpd</code> bằng tên hoặc ID của image bạn muốn xem thông tin. </li></ul><p>Xóa một image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rmi httpd</span></pre></td></tr></table></figure><ul><li>thay <code>httpd</code> bằng tên hoặc ID image bạn muốn xóa</li><li>Xóa tất cả các image bằng lệnh <code>docker rmi -f $(docker images -qa)</code></li><li>Khi <code>image</code> đang được sử dụng để <code>run</code> một <code>container</code> thì muốn xóa, bạn cần thêm tham số <code>-f</code></li></ul><p>Đổi lại <code>tag</code> của một image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker tag httpd httpd:1.0</span></pre></td></tr></table></figure><ul><li><code>httpd</code> là image đang có. <code>httpd:1.0</code> là tên mới của image có phiên bản <code>1.0</code>, nếu không điền thì được mặc định là <code>latest</code></li><li>có thể chỉ định thêm <code>repository</code> sẽ upload image, tôi sử dụng <code>repository</code> là <code>tannt</code>: <code>docker tag httpd tannt/httpd:1.0</code></li></ul><p>Cách tra cứu cú pháp các command về image:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker [<span class="built_in">command</span>] --<span class="built_in">help</span></span></pre></td></tr></table></figure><p>Ví dụ:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker image --<span class="built_in">help</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">docker image pull --<span class="built_in">help</span></span></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6. Viết docker-compose để khởi chạy multi container</title>
      <link href="/2019/12/05/docker6/"/>
      <url>/2019/12/05/docker6/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h1><ul><li><p>Compose là công cụ giúp định nghĩa và khởi chạy multi-container Docker applications.</p></li><li><p>Chỉ với một câu lệnh, ta có thể dễ dàng create và start toàn bộ các services phục vụ cho việc chạy ứng dụng.</p></li><li><p>Việc sử dụng Docker Compose được tóm lược trong 3 bước cơ bản sau:</p><ul><li>Khai báo app’s environment với Dockerfile.</li><li>Khai báo các services cần thiết để chạy app trong docker-compose.yml.</li><li>Run docker-compose up và Compose sẽ start và run app.</li></ul></li></ul><h1 id="1-Cai-dat"><a href="#1-Cai-dat" class="headerlink" title="1. Cài đặt"></a>1. Cài đặt</h1><ul><li>Install using pip<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ pip install docker-compose</span></pre></td></tr></table></figure></li></ul><p>Hoặc bạn có thể sử dụng cách khác: </p><ul><li>Install as a container<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ curl -L https://github.com/docker/compose/releases/download/1.11.2/run.sh &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span></pre></td></tr></table></figure></li></ul><h1 id="2-Vi-du-chay-wordpress"><a href="#2-Vi-du-chay-wordpress" class="headerlink" title="2. Ví dụ chạy wordpress."></a>2. Ví dụ chạy wordpress.</h1><p>Chúng ta sẽ tạo ra 2 containers, 1 containers chứa mã nguồn wordpress và 1 containers chưa cơ sở dữ liệu mysql. Bằng cách định nghĩa trong file compose. Chỉ với 1 dòng lệnh khởi tạo, docker sẽ lập tức tạo ra 2 containers và sẵn sàng cho chúng ta dựng lên wordpress, một cách nhanh chóng.</p><ul><li><p>Đoạn mã compose: Viết theo cú pháp <strong>YAML</strong>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">version: <span class="string">'2'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">services:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   db:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">     image: mysql:5.7</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">     volumes:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">       - ./data:/var/lib/mysql</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">     restart: always</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">     environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">       MYSQL_ROOT_PASSWORD: wordpress</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       MYSQL_DATABASE: wordpress</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">       MYSQL_USER: wordpress</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       MYSQL_PASSWORD: wordpress</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   wordpress:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">     depends_on:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">       - db</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">     image: wordpress:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">     ports:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">       - <span class="string">"8000:80"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">     restart: always</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">     environment:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">       WORDPRESS_DB_HOST: db:3306</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">       WORDPRESS_DB_PASSWORD: wordpress</span></pre></td></tr></table></figure></li><li><p><code>version: &#39;2&#39;</code>: Chỉ ra phiên bản docker-compose sẽ sử dụng.</p></li><li><p><code>services:</code>: Trong mục services, chỉ ra những services (containers) mà ta sẽ cài đặt. Ở đây, tạo sẽ tạo ra services tương ứng với 2 containers là db và wordpress.</p></li><li><p>Trong services db: </p><ul><li>image: chỉ ra image sẽ được sử dụng để create containers. Ngoài ra, bạn có thể viết dockerfile và khai báo lệnh <code>build</code> để containers sẽ được create từ dockerfile.</li><li>volumes: mount thư mục data trên host (cùng thư mục cha chứa file docker-compose) với thư mục /var/lib/mysql trong container.</li><li>restart: always: Tự động khởi chạy khi container bị shutdown.</li><li>environment: Khai báo các biến môi trường cho container. Cụ thể là thông tin cơ sở dữ liệu.</li></ul></li><li><p>Trong services wordpress:</p><ul><li>depends_on: db: Chỉ ra sự phụ thuộc của services wordpress với services db. Tức là services db phải chạy và tạo ra trước, thì services wordpress mới chạy.</li><li>ports: Forwards the exposed port 80 của container sang port 8000 trên host machine.</li><li>environment: Khai báo các biến môi trường. Sau khi tạo ra db ở container trên, thì sẽ lấy thông tin đấy để cung cấp cho container wordpress (chứa source code).</li></ul></li><li><p>Khởi chạy</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:/opt/<span class="built_in">test</span>/data<span class="comment"># docker-compose up</span></span></pre></td></tr></table></figure></li><li><p>Kết quả</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:/opt/<span class="built_in">test</span>/data<span class="comment"># docker-compose ps</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">      Name                    Command               State          Ports         </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">--------------------------------------------------------------------------------</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">test_db_1          docker-entrypoint.sh mysqld      Up      3306/tcp             </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">test_wordpress_1   docker-entrypoint.sh apach ...   Up      0.0.0.0:8080-&gt;80/tcp </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">root@adk:/opt/<span class="built_in">test</span>/data<span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:/opt/<span class="built_in">test</span>/data<span class="comment"># docker ps -a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">54cfd8a41b73        wordpress:latest    <span class="string">"docker-entrypoint..."</span>   7 minutes ago       Up 7 minutes        0.0.0.0:8080-&gt;80/tcp     test_wordpress_1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">68460ffee3c4        mysql:5.7           <span class="string">"docker-entrypoint..."</span>   7 minutes ago       Up 7 minutes        3306/tcp                 test_db_1</span></pre></td></tr></table></figure><h1 id="3-Mot-vai-chu-y"><a href="#3-Mot-vai-chu-y" class="headerlink" title="3. Một vài chú ý:"></a>3. Một vài chú ý:</h1><ul><li>dockerfile dùng để build các image.</li><li>docker-compose dùng để build và run các container.</li><li>docker-compose viết theo cú pháp <strong>YAML</strong>, các lệnh khai báo trong docker-compose gần tương tự với thao tác chạy container <code>docker run</code>.</li><li>docker-compose cung chấp chức năng <code>Horizontally scaled</code>, cho phép ta tạo ra nhiều container giống nhau một cách nhanh chóng. Bằng cách sử dụng lệnh<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker-compose scale name_service=5</span></pre></td></tr></table></figure></li></ul><p>Trong đó, <strong>name_service</strong> là tên services cần tạo container. <strong>5</strong> là số container sẽ được tạo ra.</p><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul><li><a href="https://viblo.asia/euclid/posts/DXOkRZYwkdZ" target="_blank" rel="noopener">https://viblo.asia/euclid/posts/DXOkRZYwkdZ</a></li><li><a href="https://docs.docker.com/compose/wordpress/#define-the-project" target="_blank" rel="noopener">https://docs.docker.com/compose/wordpress/#define-the-project</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5. Network trong docker</title>
      <link href="/2019/12/05/docker5/"/>
      <url>/2019/12/05/docker5/</url>
      
        <content type="html"><![CDATA[<h1 id="Network-trong-Docker"><a href="#Network-trong-Docker" class="headerlink" title="Network trong Docker."></a>Network trong Docker.</h1><p><img alt data-src="https://camo.githubusercontent.com/d2c856d1986260ace4a29c8478e17bba09dacc13/687474703a2f2f692e696d6775722e636f6d2f614e534a3639792e706e67" class="lazyload"></p><p>Khi chúng ta cài đặt Docker, những thiết lập sau sẽ được thực hiện:</p><ul><li>Virtual bridge docker0 sẽ được tạo ra</li><li>Docker tìm một subnet chưa được dùng trên host và gán một địa chỉ cho docker0</li></ul><p>Sau đó, khi chúng ta khởi động một container (với bridge network), một veth (Virtual Ethernet) sẽ được tạo ra nối 1 đầu với docker0 và một đầu sẽ được nối với interface eth0 trên container.</p><h1 id="1-Default-network"><a href="#1-Default-network" class="headerlink" title="1. Default network"></a>1. Default network</h1><p>Mặc định khi cài đặt xong, Docker sẽ tạo ra 3 card mạng mặc định là:</p><ul><li><p>bridge</p></li><li><p>host</p></li><li><p>only.</p></li><li><p>Tương ứng với các nền tảo ảo hóa khác, ta có các chế độ card mạng của docker so với các nền tảng đấy là:</p></li></ul><table><thead><tr><th>General Virtualization Term</th><th>Docker Network Driver</th></tr></thead><tbody><tr><td>NAT Network</td><td>bridge</td></tr><tr><td>Bridged</td><td>macvlan, ipvlan (experimental since Docker 1.11)</td></tr><tr><td>Private / Host-only</td><td>bridge</td></tr><tr><td>Overlay Network / VXLAN</td><td>overlay</td></tr></tbody></table><p>Để xem chi tiết, ta có thể dùng lệnh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network ls</span></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:/<span class="comment"># docker network ls</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">1d8aa8d520a2        bridge              bridge              <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">a8ddedeecca8        host                host                <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">ad1c5f949ef2        none                null                <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">root@adk:/<span class="comment">#</span></span></pre></td></tr></table></figure><p>Mặc định khi tạo container mà ta không chỉ định dùng network nào, thì docker sẽ dùng dải bridge.</p><h2 id="1-1-None-network"><a href="#1-1-None-network" class="headerlink" title="1.1 None network"></a>1.1 None network</h2><p>Các container thiết lập network này sẽ không được cấu hình mạng. </p><h2 id="1-2-Bridge"><a href="#1-2-Bridge" class="headerlink" title="1.2 Bridge"></a>1.2 Bridge</h2><p>Docker sẽ tạo ra một switch ảo. Khi container được tạo ra, interface của container sẽ gắn vào switch ảo này và kết nối với interface của host.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:~<span class="comment"># docker network inspect bridge</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Name"</span>: <span class="string">"bridge"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Id"</span>: <span class="string">"1d8aa8d520a2775b5f02279e2ff057e2d781a67e116e603d367edab58211a5d9"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Created"</span>: <span class="string">"2017-03-14T09:35:39.561628223+07:00"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"IPAM"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"Options"</span>: null,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"Config"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.17.0.0/16"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.17.0.1"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            ]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Attachable"</span>: <span class="literal">false</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Containers"</span>: &#123;&#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Options"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.bridge.default_bridge"</span>: <span class="string">"true"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.bridge.enable_icc"</span>: <span class="string">"true"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.bridge.enable_ip_masquerade"</span>: <span class="string">"true"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.bridge.host_binding_ipv4"</span>: <span class="string">"0.0.0.0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.bridge.name"</span>: <span class="string">"docker0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            <span class="string">"com.docker.network.driver.mtu"</span>: <span class="string">"1500"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">root@adk:~<span class="comment">#</span></span></pre></td></tr></table></figure><h2 id="1-3-Host"><a href="#1-3-Host" class="headerlink" title="1.3 Host"></a>1.3 Host</h2><p>Containers sẽ dùng mạng trực tiếp của máy host. Network configuration bên trong container đồng nhất với host.</p><h2 id="2-User-defined-networks"><a href="#2-User-defined-networks" class="headerlink" title="2. User-defined networks"></a>2. User-defined networks</h2><p>Ngoài việc sử dụng các network mặc định do docker cung cấp. Ta có thể tự định nghĩa ra các dải network phù hợp<br>với công việc của mình.</p><p>Để tạo network, ta dùng lệnh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --subnet 192.168.1.0/24 bridgexxx</span></pre></td></tr></table></figure><p>Trong đó:</p><ul><li><strong>–driver bridge</strong>: Chỉ định dải mạng mới được tạo ra sẽ thuộc kiểu nào: bridge, host, hay none.</li><li><strong>–subnet</strong>: Chỉ định địa địa chỉ mạng.</li><li><strong>bridgexxx</strong>: Tên của dải mạng mới.</li></ul><p>Khi chạy container chỉ định sử dụng 1 dải mạng đặc biệt, ta dùng lệnh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run --network=bridgexxx -itd --name=container3 busybox</span></pre></td></tr></table></figure><p>Trong đó:</p><ul><li><strong>–network=bridgexxx:</strong> Chỉ định ra dải mạng bridgexxx sẽ kết nối với container.</li></ul><p>Container mà bạn chạy trên network này đều phải thuộc về cùng một Docker host. Mỗi container trong network có thể communicate với các containers khác trong cùng network.</p><h2 id="3-An-overlay-network-with-Docker-Engine-swarm-mode"><a href="#3-An-overlay-network-with-Docker-Engine-swarm-mode" class="headerlink" title="3. An overlay network with Docker Engine swarm mode"></a>3. An overlay network with Docker Engine swarm mode</h2><ul><li>Overlay network là mạng có thể kết nối nhiều container trên các <strong>Docker Engine</strong> lại với nhau, trong môi trường cluster.</li><li>Swarm tạo ra overlay network chỉ available với các nodes bên trong swarm. Khi bạn tạo ra một service sử dụng overlay network, manager node sẽ tự động kế thừa overlay network tới các nodes chạy các service tasks.</li></ul><p>Ví dụ sau sẽ hướng dẫn cách tạo ra một network và sử dụng nó cho một service từ một manager node bên trong swarm:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create an overlay network `my-multi-host-network`.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">$ docker network create \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  --driver overlay \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  --subnet 10.0.9.0/24 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  my-multi-host-network</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">400g6bwzd68jizzdx5pgyoe95</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create an nginx service and extend the my-multi-host-network to nodes where</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># the service's tasks run.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">$ $ docker service create --replicas 2 --network my-multi-host-network --name my-web nginx</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">716thylsndqma81j6kkkb5aus</span></pre></td></tr></table></figure><h1 id="4-“Noi-chuyen”-giua-cac-container-voi-nhau"><a href="#4-“Noi-chuyen”-giua-cac-container-voi-nhau" class="headerlink" title="4. “Nói chuyện” giữa các container với nhau."></a>4. “Nói chuyện” giữa các container với nhau.</h1><ul><li>Trên cùng một host, các container chỉ cần dùng bridge network để nói chuyện được với nhau. Tuy nhiên, các container được cấp ip động nên nó có thể thay đổi, dẫn đến nhiều khó khăn. Vì vậy, thay vì dùng địa chỉ ip, ta có thể dùng name của các container để “liên lạc” giữa các container với nhau.</li><li>Trong trường hợp sử dụng default bridge network thì ta khai báo thêm lệnh <code>--link=name_container</code>.</li><li>Trong trường hợp sử dụng user-defined bridge network thì ta không cần phải link nữa.</li></ul><h2 id="4-1-Truong-hop-su-dung-default-bridge-network-de-ket-noi-cac-container"><a href="#4-1-Truong-hop-su-dung-default-bridge-network-de-ket-noi-cac-container" class="headerlink" title="4.1 Trường hợp sử dụng default bridge network để kết nối các container"></a>4.1 Trường hợp sử dụng default bridge network để kết nối các container</h2><ul><li>Giả sử ta có mô hình: <code>web - db</code></li><li>container web phải link được với container db. </li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -itd --name=db -e MYSQL_ROOT_PASSWORD=pass mysql:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker run -itd --name=web --link=db nginx:latest</span></pre></td></tr></table></figure><ul><li>Kiểm tra: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it web sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping redis</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">PING redis (172.17.0.3): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.17.0.3: icmp_seq=0 ttl=64 time=0.245 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping db</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">PING db (172.17.0.2): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.17.0.2: icmp_seq=0 ttl=64 time=0.126 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr></table></figure></li></ul><h2 id="4-2-Truong-hop-su-dung-user-defined-bridge-network-de-ket-noi-cac-container"><a href="#4-2-Truong-hop-su-dung-user-defined-bridge-network-de-ket-noi-cac-container" class="headerlink" title="4.2 Trường hợp sử dụng user-defined bridge network để kết nối các container"></a>4.2 Trường hợp sử dụng user-defined bridge network để kết nối các container</h2><ul><li>Bạn không cần thực hiện thao tác link qua link lại giữa các container nữa.</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network create my-net</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker network ls</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                DRIVER</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">716f591e185a        bridge              bridge              </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">4b0041303d6d        host                host                </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">7239bb9e0255        my-net              bridge              </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">016cf6ec1791        none                null</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">docker run -itd --name=web1 --net my-net nginx:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">docker run -itd --name=db1 --net my-net -e MYSQL_ROOT_PASSWORD=pass mysql:latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it web1 sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping db1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">PING db1 (172.18.0.4): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.18.0.4: icmp_seq=0 ttl=64 time=0.161 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping redis1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">PING redis1 (172.18.0.3): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.18.0.3: icmp_seq=0 ttl=64 time=0.168 ms</span></pre></td></tr></table></figure><h2 id="5-DNS-server"><a href="#5-DNS-server" class="headerlink" title="5. DNS server."></a>5. DNS server.</h2><h3 id="5-1-Default-bridge-network"><a href="#5-1-Default-bridge-network" class="headerlink" title="5.1 Default bridge network"></a>5.1 Default bridge network</h3><ul><li>Khi container được chạy với network default bridge thì container sẽ sao chép nội dung file <code>/etc/resolv.conf</code> của host vào trong container. Do đó, dns-server được cấu hình trên máy host như thế nào, thì trên container tương tự như vậy.</li><li>Kiểm tra trên container:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@292a65a743ac:/<span class="comment"># mount | grep /etc</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">/dev/disk/by-uuid/d9ed83b8-98cb-428a-9ad0-e7bf8ae36117 on /etc/resolv.conf <span class="built_in">type</span> ext4 (rw,relatime,errors=remount-ro,data=ordered)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">/dev/disk/by-uuid/d9ed83b8-98cb-428a-9ad0-e7bf8ae36117 on /etc/hostname <span class="built_in">type</span> ext4 (rw,relatime,errors=remount-ro,data=ordered)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">/dev/disk/by-uuid/d9ed83b8-98cb-428a-9ad0-e7bf8ae36117 on /etc/hosts <span class="built_in">type</span> ext4 (rw,relatime,errors=remount-ro,data=ordered)</span></pre></td></tr></table></figure></li></ul><p>=&gt; Ta thấy các file trên container được mount từ các file trên máy host.</p><ul><li>Kiểm tra nội dung file <code>resolv.conf</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@292a65a743ac:/<span class="comment"># cat /etc/resolv.conf </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">nameserver 8.8.4.4</span></pre></td></tr></table></figure></li></ul><p>=&gt; Tương tự trên máy host.</p><h3 id="5-2-User-defined-networks"><a href="#5-2-User-defined-networks" class="headerlink" title="5.2 User-defined networks"></a>5.2 User-defined networks</h3><ul><li><p>Docker sẽ sử dụng <code>built-in dns</code> riêng cho các container cùng 1 network.</p></li><li><p>Nội dung file <code>/etc/resolv.conf</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@07c8c10a7a81:/<span class="comment"># cat /etc/resolv.conf </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">nameserver 127.0.0.11</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">options ndots:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">root@07c8c10a7a81:/<span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Docker chưa cung cấp công cụ để xem thông tin các record của built-in dns này.</p></li></ul><h3 id="5-3-Chi-dinh-su-dung-dns-server-rieng"><a href="#5-3-Chi-dinh-su-dung-dns-server-rieng" class="headerlink" title="5.3 Chỉ định sử dụng dns-server riêng"></a>5.3 Chỉ định sử dụng dns-server riêng</h3><ul><li>Dùng cờ <code>--dns</code>: để khai báo dns-server sẽ sử dụng trong container:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker2:/opt<span class="comment"># docker run -it --name hcm --dns=10.10.10.1 ubuntu /bin/bash</span></span></pre></td></tr></table></figure><h2 id="6-MacVlan"><a href="#6-MacVlan" class="headerlink" title="6. MacVlan."></a>6. MacVlan.</h2><p>Macvlan cho phép cấu hình sub-interfaces (hay còn gọi là slave devices) trên một Ethernet interface vật lý (còn gọi là upper device), mỗi sub-interfaces này có địa chỉ MAC riêng và do đó có địa chỉ IP riêng. Các ứng dụng, VM và các containers có thể kết nối với một sub-interface nhất định để kết nối trực tiếp với mạng vật lý, sử dụng địa chỉ MAC và địa chỉ IP riêng của chúng.</p><p><img alt data-src="https://raw.githubusercontent.com/hocchudong/ghichep-docker/master/hinhanh/macvlan.png" class="lazyload"></p><h4 id="LAB-macvlan-che-do-bridge"><a href="#LAB-macvlan-che-do-bridge" class="headerlink" title="LAB macvlan chế độ bridge"></a>LAB macvlan chế độ bridge</h4><p>Trong khi macvlan có 4 chế độ (VEPA, bridge, private, passthrough), thì Docker macvlan driver chỉ hỗ trợ macvlan bridge mode.</p><ul><li>Mô hình:</li></ul><p><img alt data-src="https://raw.githubusercontent.com/hocchudong/ghichep-docker/master/hinhanh/lab_macvlan.png" class="lazyload"></p><ul><li><p>Kiểm tra card mạng máy host</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># ifconfig -a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker0   Link encap:Ethernet  HWaddr 02:42:b5:a4:86:55  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">          inet addr:172.17.0.1  Bcast:0.0.0.0  Mask:255.255.0.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:0 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">eth0      Link encap:Ethernet  HWaddr 52:54:00:f6:70:7a  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">          inet addr:172.16.69.234  Bcast:172.16.69.255  Mask:255.255.255.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">          inet6 addr: fe80::5054:ff:fef6:707a/64 Scope:Link</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">          RX packets:754142 errors:0 dropped:4 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">          TX packets:225721 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:1000 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">          RX bytes:87515346 (87.5 MB)  TX bytes:34434449 (34.4 MB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">lo        Link encap:Local Loopback  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">          inet6 addr: ::1/128 Scope:Host</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">          RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:0 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">          RX bytes:576 (576.0 B)  TX bytes:576 (576.0 B)</span></pre></td></tr></table></figure></li><li><p>Tạo card mạng macvlan chế độ bridge</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker network create -d macvlan --subnet 172.16.69.0/24 --gateway 172.16.69.1 --ip-range=172.16.69.240/28 -o parent=eth0 macvlan0</span></span></pre></td></tr></table></figure><p>Trong đó:</p><ul><li>subnet và gateway: chỉ ra dải địa chỉ mạng thật.</li><li>ip-range: Chỉ ra dải địa chỉ sẽ được cấp cho container.</li></ul></li><li><p>Kiểm tra card mạng vừa tạo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker network ls</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">89aacb502e1e        bridge              bridge              <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">d1b81f6ed217        docker_gwbridge     bridge              <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">e1ea5196a974        host                host                <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">re92zy5a0lvn        ingress             overlay             swarm</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">bf347a55a5a4        macvlan0            macvlan             <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">120c2a080b4f        none                null                <span class="built_in">local</span></span></pre></td></tr></table></figure></li><li><p>Tạo container1 và gắn vào card mạng vừa tạo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker run -it --net macvlan0 --name alpine1 alpine /bin/sh</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">24: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    link/ether 02:42:ac:10:45:f0 brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    inet 172.16.69.240/24 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::42:acff:fe10:45f0/64 scope link tentative </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Kiểm tra ping gateway và ping ra ngoài internet</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 172.16.69.1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">PING 172.16.69.1 (172.16.69.1): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.1: seq=0 ttl=64 time=0.856 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.1: seq=1 ttl=64 time=0.580 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">--- 172.16.69.1 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 0.580/0.718/0.856 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 8.8.8.8</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">64 bytes from 8.8.8.8: seq=0 ttl=45 time=40.851 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">--- 8.8.8.8 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 40.851/40.851/40.851 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># exit</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Tạo container2 và gắn vào card mạng vừa tạo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker run -it --net macvlan0 --name alpine2 alpine /bin/sh</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ip a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">25: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    link/ether 02:42:ac:10:45:f1 brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    inet 172.16.69.241/24 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::42:acff:fe10:45f1/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Ping container1, google</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 172.16.69.240</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">PING 172.16.69.240 (172.16.69.240): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.240: seq=0 ttl=64 time=0.349 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.240: seq=1 ttl=64 time=0.139 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.240: seq=2 ttl=64 time=0.090 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">64 bytes from 172.16.69.240: seq=3 ttl=64 time=0.282 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">--- 172.16.69.240 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 0.090/0.215/0.349 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 8.8.8.8</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">64 bytes from 8.8.8.8: seq=0 ttl=45 time=32.703 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">64 bytes from 8.8.8.8: seq=1 ttl=45 time=32.804 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">64 bytes from 8.8.8.8: seq=2 ttl=45 time=32.803 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">64 bytes from 8.8.8.8: seq=3 ttl=45 time=32.768 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">--- 8.8.8.8 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 32.703/32.769/32.804 ms</span></pre></td></tr></table></figure></li></ul><h4 id="LAB-macvlan-che-do-bridge-tinh-nang-vlan"><a href="#LAB-macvlan-che-do-bridge-tinh-nang-vlan" class="headerlink" title="LAB macvlan chế độ bridge tính năng vlan"></a>LAB macvlan chế độ bridge tính năng vlan</h4><ul><li><p>Tính năng vlan sẽ phân chia các containers nằm trên từng vlan khác nhau. Giúp chúng ta dễ dàng quản lý các container.</p></li><li><p>Định dạng của vlan sub-interface là <code>interface_name.vlan_tag</code>. Ví dụ: <strong>eth0.50</strong></p></li><li><p>Mô hình:</p></li></ul><p><img alt data-src="https://raw.githubusercontent.com/hocchudong/ghichep-docker/master/hinhanh/macvlan-vlan.png" class="lazyload"></p><ul><li><p>Tạo network với <code>vlan tag</code> là <code>50</code> dựa trên interface <code>eth0</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network  create  -d macvlan \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    --subnet=192.168.50.0/24 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    --gateway=192.168.50.1 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    -o parent=eth0.50 macvlan50</span></pre></td></tr></table></figure></li><li><p>Tạo 2 containers dùng card mạng này: </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan50 -it --name macvlan_test5 --rm alpine /bin/sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan50 -it --name macvlan_test6 --rm alpine /bin/sh</span></pre></td></tr></table></figure></li><li><p>Tạo network với <code>vlan tag</code> là <code>60</code> dựa trên interface <code>eth0</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker network  create  -d macvlan \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    --subnet=192.168.60.0/24 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    --gateway=192.168.60.1 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    -o parent=eth0.60 -o \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    --macvlan_mode=bridge macvlan60</span></pre></td></tr></table></figure></li><li><p>Tạo 2 containers:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan60 -it --name macvlan_test7 --rm alpine /bin/sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan60 -it --name macvlan_test8 --rm alpine /bin/sh</span></pre></td></tr></table></figure></li></ul><h5 id="Kiem-tra"><a href="#Kiem-tra" class="headerlink" title="Kiểm tra"></a>Kiểm tra</h5><ul><li><p>Sau khi tạo 2 macvlan, ta thấy xuất hiện 2 sub-interface tương ứng là: <code>eth0.50@eth0</code> và <code>eth0.60@eth0</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># ip a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    link/ether 52:54:00:f6:70:7a brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    inet 172.16.69.234/24 brd 172.16.69.255 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::5054:ff:fef6:707a/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    link/ether 02:42:b5:a4:86:55 brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    inet 172.17.0.1/16 scope global docker0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">33: eth0.50@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    link/ether 52:54:00:f6:70:7a brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::5054:ff:fef6:707a/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">36: eth0.60@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    link/ether 52:54:00:f6:70:7a brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::5054:ff:fef6:707a/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr></table></figure></li><li><p>Trên containers <code>macvlan_test5</code> ping đến containers <code>macvlan_test6</code>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ip a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">34: eth0@if33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    link/ether 02:42:c0:a8:32:02 brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    inet 192.168.50.2/24 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::42:c0ff:fea8:3202/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 192.168.50.3</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">PING 192.168.50.3 (192.168.50.3): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.50.3: seq=0 ttl=64 time=0.357 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.50.3: seq=1 ttl=64 time=0.107 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">--- 192.168.50.3 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 0.107/0.232/0.357 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Trên containers <code>macvlan_test5</code> ping đến containers <code>macvlan_test7</code>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 192.168.60.2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">PING 192.168.60.2 (192.168.60.2): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">--- 192.168.60.2 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">21 packets transmitted, 0 packets received, 100% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><h4 id="Tao-multi-subnet-tren-cung-1-sub-interface"><a href="#Tao-multi-subnet-tren-cung-1-sub-interface" class="headerlink" title="Tạo multi-subnet trên cùng 1 sub-interface:"></a>Tạo multi-subnet trên cùng 1 sub-interface:</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">### Create multiple bridge subnets with a gateway of x.x.x.1:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker network  create  -d macvlan \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  --subnet=192.168.164.0/24 --subnet=192.168.166.0/24 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  --gateway=192.168.164.1  --gateway=192.168.166.1 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   -o parent=eth0.166 \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   -o macvlan_mode=bridge macvlan64</span></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan64 --name=macnet54_test --ip=192.168.164.10 -itd alpine /bin/sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan64 --name=macnet55_test --ip=192.168.166.10 -itd alpine /bin/sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan64 --ip=192.168.164.11 -it --rm alpine /bin/sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">docker run --net=macvlan64 --ip=192.168.166.11 -it --rm alpine /bin/sh</span></pre></td></tr></table></figure><ul><li>Khi tạo containers phải chỉ định rõ là sử dụng subnet nào.</li><li><strong>Mặc dù cùng 1 sub-interface nhưng các containers chỉ có thể nói chuyện với nhau nếu nó nằm cùng 1 subnet.</strong></li></ul><h2 id="7-Ipvlan"><a href="#7-Ipvlan" class="headerlink" title="7. Ipvlan"></a>7. Ipvlan</h2><p>Ipvlan khá giống so với macvlan, tuy nhiên nó có điểm khác so với macvlan là không gán địa chỉ MAC riêng cho các sub-interfaces. Các sub-interfaces chia sẻ chung địa chỉ MAC với parent interfaces (card vật lý trên đó tạo các sub-interfaces), nhưng có địa chỉ IP riêng.</p><p><img alt data-src="https://raw.githubusercontent.com/hocchudong/ghichep-docker/master/hinhanh/ipvlan.png" class="lazyload"></p><ul><li><p>Ipvlan L2: Ipvlan L2 hay Layer 2 mode tương tự với chế độ macvlan bridge mode.</p></li><li><p>Ipvlan L3: Ipvlan L2 được coi coi như bridge hay switch giữa các sub-interfaces và parent interface. Tương tự như vậy, Ipvlan L3 hay Layer 3 mode được coi như thiết bị lớp 3 (như router) giữa các sub-interfaces và parent interfaces.</p></li><li><p>Thông tin về macvlan và ipvlan sẽ cập nhật bài viết sau.</p></li><li><p><strong>Lab ipvlan mode 2 khá tương tự với phần macvlan chế độ bridge nên tôi sẽ không đề cập tại đây</strong><br>s</p></li><li><p>Để sử dụng được chế độ ipvlan, các bạn phải kích hoạt tính năng <strong>Experimental</strong> và nên update lên kernel mới nhất:</p><ul><li><p>Tạo file <code>/etc/docker/daemon.json</code> với nội dung:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"experimental"</span>: <span class="literal">true</span> &#125;</span></pre></td></tr></table></figure></li><li><p>Khởi động lại docker: <code>service docker restart</code></p><ul><li>Kiểm tra: Nếu trả về true là ok.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ docker version -f <span class="string">'&#123;&#123;.Server.Experimental&#125;&#125;'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="literal">true</span></span></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h4 id="Lab-ipvlan-L3-Multi-Subnet-Ipvlan-L3-Network"><a href="#Lab-ipvlan-L3-Multi-Subnet-Ipvlan-L3-Network" class="headerlink" title="Lab ipvlan L3: Multi-Subnet Ipvlan L3 Network"></a>Lab ipvlan L3: Multi-Subnet Ipvlan L3 Network</h4><ul><li>Mô hình</li></ul><p><img alt data-src="https://raw.githubusercontent.com/hocchudong/ghichep-docker/master/hinhanh/ipvlan_l3.png" class="lazyload"></p><ul><li><p>Kiểm tra card mạng máy host</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># ifconfig -a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">docker0   Link encap:Ethernet  HWaddr 02:42:b5:a4:86:55  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">          inet addr:172.17.0.1  Bcast:0.0.0.0  Mask:255.255.0.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:0 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">eth0      Link encap:Ethernet  HWaddr 52:54:00:f6:70:7a  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">          inet addr:172.16.69.234  Bcast:172.16.69.255  Mask:255.255.255.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">          inet6 addr: fe80::5054:ff:fef6:707a/64 Scope:Link</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">          RX packets:754142 errors:0 dropped:4 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">          TX packets:225721 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:1000 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">          RX bytes:87515346 (87.5 MB)  TX bytes:34434449 (34.4 MB)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">lo        Link encap:Local Loopback  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">          inet6 addr: ::1/128 Scope:Host</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">          RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">          collisions:0 txqueuelen:0 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">          RX bytes:576 (576.0 B)  TX bytes:576 (576.0 B)</span></pre></td></tr></table></figure></li><li><p>Tạo network</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker network create -d ipvlan --subnet=192.168.100.0/24 --gateway=192.168.100.1 --subnet=192.168.200.0/24 --gateway=192.168.200.1 -o parent=eth0 -o ipvlan_mode=l3 ipvlan</span></span></pre></td></tr></table></figure></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker network ls</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">20504846ae2b        bridge              bridge              <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">e1ea5196a974        host                host                <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">0f6b33a6df54        ipvlan              ipvlan              <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">120c2a080b4f        none                null                <span class="built_in">local</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment">#</span></span></pre></td></tr></table></figure><ul><li>tạo container1 với subnet 192.168.100.0/24<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker run -it --name ipvlan_c1 --net=ipvlan --ip=192.168.100.2 alpine /bin/sh</span></span></pre></td></tr></table></figure></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">31: eth0@if2: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    link/ether 52:54:00:f6:70:7a brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    inet 192.168.100.2/24 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::5054:ff:fef6:707a/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure><p><strong>=&gt; cùng mac với máy host</strong></p><ul><li>tạo container2 với subnet 192.168.200.0/24<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@docker4:~<span class="comment"># docker run -it --name ipvlan_c2 --net=ipvlan --ip=192.168.200.2 alpine /bin/sh</span></span></pre></td></tr></table></figure></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ip a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    inet 127.0.0.1/8 scope host lo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    inet6 ::1/128 scope host </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">32: eth0@if2: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UNKNOWN </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    link/ether 52:54:00:f6:70:7a brd ff:ff:ff:ff:ff:ff</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    inet 192.168.200.2/24 scope global eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    inet6 fe80::5054:ff:fef6:707a/64 scope link </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       valid_lft forever preferred_lft forever</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure><p><strong>=&gt; cùng mac với máy host</strong></p><ul><li>Trên container2 ping container1<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping 192.168.100.2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">PING 192.168.100.2 (192.168.100.2): 56 data bytes</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=0 ttl=64 time=0.399 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=1 ttl=64 time=0.095 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=2 ttl=64 time=0.091 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=3 ttl=64 time=0.104 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=4 ttl=64 time=0.100 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">64 bytes from 192.168.100.2: seq=5 ttl=64 time=0.292 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">^C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">--- 192.168.100.2 ping statistics ---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">6 packets transmitted, 6 packets received, 0% packet loss</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">round-trip min/avg/max = 0.091/0.180/0.399 ms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://gist.github.com/nerdalert/c0363c15d20986633fda" target="_blank" rel="noopener">https://gist.github.com/nerdalert/c0363c15d20986633fda</a></li><li><a href="http://www.dasblinkenlichten.com/docker-networking-101-host-mode/" target="_blank" rel="noopener">http://www.dasblinkenlichten.com/docker-networking-101-host-mode/</a></li><li><a href="https://viblo.asia/euclid/posts/XqakEmmbkWK" target="_blank" rel="noopener">https://viblo.asia/euclid/posts/XqakEmmbkWK</a></li><li><a href="https://docs.docker.com/engine/userguide/networking/#the-dockergwbridge-network" target="_blank" rel="noopener">https://docs.docker.com/engine/userguide/networking/#the-dockergwbridge-network</a></li><li><a href="https://kipalog.com/posts/Cach-lien-ket-cac-container-lai-voi-nhau-trong-docker" target="_blank" rel="noopener">https://kipalog.com/posts/Cach-lien-ket-cac-container-lai-voi-nhau-trong-docker</a></li><li><a href="https://docs.docker.com/engine/userguide/networking/get-started-macvlan/" target="_blank" rel="noopener">https://docs.docker.com/engine/userguide/networking/get-started-macvlan/</a></li><li><a href="https://www.slideshare.net/bbsali0/docker-networking-with-new-ipvlan-and-macvlan-drivers" target="_blank" rel="noopener">https://www.slideshare.net/bbsali0/docker-networking-with-new-ipvlan-and-macvlan-drivers</a></li><li><a href="https://hicu.be/docker-networking-macvlan-bridge-mode-configuration" target="_blank" rel="noopener">https://hicu.be/docker-networking-macvlan-bridge-mode-configuration</a></li><li><a href="https://hicu.be/docker-container-network-types" target="_blank" rel="noopener">https://hicu.be/docker-container-network-types</a></li><li><a href="https://sreeninet.wordpress.com/2016/05/29/docker-macvlan-and-ipvlan-network-plugins/" target="_blank" rel="noopener">https://sreeninet.wordpress.com/2016/05/29/docker-macvlan-and-ipvlan-network-plugins/</a></li><li><a href="https://sreeninet.wordpress.com/2016/05/29/macvlan-and-ipvlan/" target="_blank" rel="noopener">https://sreeninet.wordpress.com/2016/05/29/macvlan-and-ipvlan/</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4. Viết dockerfile để build image</title>
      <link href="/2019/12/05/docker4/"/>
      <url>/2019/12/05/docker4/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Ghi-chep-ve-Dockerfile"><a href="#1-Ghi-chep-ve-Dockerfile" class="headerlink" title="1. Ghi chép về Dockerfile"></a>1. Ghi chép về Dockerfile</h1><ul><li>Dockerfile có thể hình dung như một script dùng để build các image trong container.</li><li>Dockerfile bao gồm các câu lệnh liên tiếp nhau được thực hiện tự động trên một image gốc để tạo ra một image mới. Dockerfile giúp đơn giản hóa tiến trình từ lúc bắt đầu đến khi kết thúc.</li><li>Trong <code>Dockerfile</code> có các câu lệnh chính sau:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">CMD</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">....còn nữa</span></pre></td></tr></table></figure></li></ul><h1 id="2-Dockerfile-Systax"><a href="#2-Dockerfile-Systax" class="headerlink" title="2. Dockerfile Systax"></a>2. Dockerfile Systax</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Comment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">INSTRUCTION arguments</span></pre></td></tr></table></figure><ul><li>Các INSTRUCTION là các chỉ thị, được docker quy định. Khi khai báo, các bạn phải viết chữ in hoa.</li><li>Các arguments là đoạn nội dung mà chỉ thị sẽ làm gì.</li><li>Ví dụ:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Comment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN <span class="built_in">echo</span> <span class="string">'we are running some # of cool things'</span></span></pre></td></tr></table></figure></li><li>Chúng ta sẽ đi tìm hiểu các INSTRUCTION</li></ul><h1 id="3-Dockerfile-Commands"><a href="#3-Dockerfile-Commands" class="headerlink" title="3. Dockerfile Commands"></a>3. Dockerfile Commands</h1><h2 id="3-1-FROM"><a href="#3-1-FROM" class="headerlink" title="3.1 FROM"></a>3.1 FROM</h2><ul><li>Dùng để chỉ ra image được build từ đâu (từ image gốc nào)<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">hoặc có thể chỉ rõ tag của image gốc</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu14.04:lastest</span></pre></td></tr></table></figure></li></ul><h2 id="3-2-RUN"><a href="#3-2-RUN" class="headerlink" title="3.2 RUN"></a>3.2 RUN</h2><ul><li>Dùng để chạy một lệnh nào đó khi build image, ví dụ về một <code>Dockerfile</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">RUN apt-get update</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN apt-get install curl -y</span></pre></td></tr></table></figure></li></ul><h2 id="3-3-CMD"><a href="#3-3-CMD" class="headerlink" title="3.3 CMD"></a>3.3 CMD</h2><ul><li>Lệnh CMD dùng để truyền một lệnh của Linux mỗi khi thực hiện khởi tạo một container từ image (image này được build từ <code>Dockerfile</code>)</li><li>Có các cách (trong docs nói có 3 cách) sử dụng lệnh CMD, ví dụ <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">#Cách 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN apt-get update</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">RUN apt-get install curl -y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">CMD [<span class="string">"curl"</span>, <span class="string">"ipinfo.io"</span>]</span></pre></td></tr></table></figure>hoặc<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">#Cách 2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">RUN apt-get update</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">RUN apt-get install wget -y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">CMD curl ifconfig.io</span></pre></td></tr></table></figure></li></ul><h2 id="3-4-LABEL"><a href="#3-4-LABEL" class="headerlink" title="3.4 LABEL"></a>3.4 LABEL</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">LABEL &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...</span></pre></td></tr></table></figure><p>Chỉ thị <strong>LABEL</strong> dùng để add các metadata vào image.</p><ul><li><p>Ví dụ: </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">LABEL <span class="string">"com.example.vendor"</span>=<span class="string">"ACME Incorporated"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">LABEL com.example.label-with-value=<span class="string">"foo"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">LABEL version=<span class="string">"1.0"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">LABEL description=<span class="string">"This text illustrates \</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="string">that label-values can span multiple lines."</span></span></pre></td></tr></table></figure></li><li><p>Để xem các <strong>label</strong> của images, dùng lệnh <code>docker inspect</code>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="string">"Labels"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"com.example.vendor"</span>: <span class="string">"ACME Incorporated"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"com.example.label-with-value"</span>: <span class="string">"foo"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"version"</span>: <span class="string">"1.0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"description"</span>: <span class="string">"This text illustrates that label-values can span multiple lines."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"multi.label1"</span>: <span class="string">"value1"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"multi.label2"</span>: <span class="string">"value2"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"other"</span>: <span class="string">"value3"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;,</span></pre></td></tr></table></figure></li></ul><h2 id="3-5-MAINTAINER"><a href="#3-5-MAINTAINER" class="headerlink" title="3.5 MAINTAINER"></a>3.5 MAINTAINER</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">MAINTAINER &lt;name&gt;</span></pre></td></tr></table></figure><p>Dùng để đặt tên giả của images.</p><p>Hoặc bạn có thể sử dụng</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">LABEL maintainer <span class="string">"SvenDowideit@home.org.au"</span></span></pre></td></tr></table></figure><h2 id="3-6-EXPOSE"><a href="#3-6-EXPOSE" class="headerlink" title="3.6 EXPOSE"></a>3.6 EXPOSE</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">EXPOSE &lt;port&gt; [&lt;port&gt;...]</span></pre></td></tr></table></figure><ul><li>Lệnh EXPOSE thông báo cho Docker rằng image sẽ lắng nghe trên các cổng được chỉ định khi chạy. Lưu ý là cái này chỉ<br>để khai báo, chứ ko có chức năng nat port từ máy host vào container. Muốn nat port, thì phải sử dụng cờ -p (nat một vài port) hoặc -P (nat tất<br>cả các port được khai báo trong EXPOSE) trong quá trình khởi tạo contrainer.</li></ul><h2 id="3-7-ENV"><a href="#3-7-ENV" class="headerlink" title="3.7 ENV"></a>3.7 ENV</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ENV &lt;key&gt; &lt;value&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ENV &lt;key&gt;=&lt;value&gt; ...</span></pre></td></tr></table></figure><ul><li><p>Khai báo cáo biến giá trị môi trường. Khi run container từ image, các biến môi trường này vẫn có hiệu lực.</p></li><li><p>Biến môi trường có thể được sử dụng trong các chỉ dẫn lệnh sau:</p><ul><li>ADD</li><li>COPY</li><li>ENV</li><li>EXPOSE</li><li>FROM</li><li>LABEL</li><li>STOPSIGNAL</li><li>USER</li><li>VOLUME</li><li>WORKDIR</li></ul></li><li><p>Ta có thể sử dụng các khai báo trong file <code>.dockerfileignore</code> để phớt lờ đi sự có mặt của các file đang có trong đường dẫn thực hiện build Docker. <code>.dockerfileignore</code> sử dụng <code>filepath.Math rules</code>. Ví dụ:</p><p><em>/temp</em> có nghĩa là loại trừ các file và đường dẫn bắt đầu bằng temp hoặc sub-directory của root. Ví dụ sau đều có thể hiểu là một:</p><pre><code>- /subdir/temp</code></pre><p>hoặc </p><pre><code>- /sbdir/temp.dump</code></pre><p>các file hoặc đường dẫn xuất hiện cụm từ <code>temp</code> đều được ignore.</p><pre><code>pattern:{ term }</code></pre><p>  term:</p><pre><code>&apos;*&apos;         matches any sequence of non-Separator characters&apos;?&apos;         matches any single non-Separator character&apos;[&apos; [ &apos;^&apos; ] { character-range } &apos;]&apos;            character class (must be non-empty)c           matches character c (c != &apos;*&apos;, &apos;?&apos;, &apos;\\&apos;, &apos;[&apos;)&apos;\\&apos; c      matches character c</code></pre><p>  character-range:</p><pre><code>c           matches character c (c != &apos;\\&apos;, &apos;-&apos;, &apos;]&apos;)&apos;\\&apos; c      matches character clo &apos;-&apos; hi   matches character c for lo &lt;= c &lt;= hi</code></pre><p>dòng bắt đầu bằng ! có thể hiểu là tạo ra một ngoại lệ trong file. Ví dụ:</p><pre><code>*.md!README.md</code></pre><p>có thể hiểu là tất cả các file .md <code>đều không được sử dụng ngoại trừ file README.md</code></p></li></ul><h2 id="3-8-ADD"><a href="#3-8-ADD" class="headerlink" title="3.8 ADD"></a>3.8 ADD</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ADD has two forms:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ADD &lt;src&gt;... &lt;dest&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ADD [<span class="string">"&lt;src&gt;"</span>,... <span class="string">"&lt;dest&gt;"</span>] (this form is required <span class="keyword">for</span> paths containing whitespace)</span></pre></td></tr></table></figure><ul><li>Chỉ thị ADD copy file, thư mục, remote files URL (src) và thêm chúng vào filesystem của image (dest)</li><li><strong>src</strong>: có thể khai báo nhiều file, thư mục, có thể sử dụng các ký hiệu như *,?,…</li><li><strong>dest</strong> phải là đường dẫn tuyệt đối hoặc có quan hệ với chỉ thị <strong>WORKDIR</strong></li></ul><p>Note: If your URL files are protected using authentication, you will need to use RUN wget, RUN curl or use another tool from within the container as the ADD instruction does not support authentication.</p><ul><li>Các quy định:<ul><li>The <src> path must be inside the context of the build: Có nghĩa là <src> phải nằm trong thư mục đang build (chứa dockerfiles).</li><li>If <src> is a directory, the entire contents of the directory are copied, including filesystem metadata. The directory itself is not copied, just its contents.</li><li>If multiple <src> resources are specified, either directly or due to the use of a wildcard, then <dest> must be a directory, and it must end with a slash /.</li><li>If <dest> does not end with a trailing slash, it will be considered a regular file and the contents of <src> will be written at <dest>.</li><li>If <dest> doesn’t exist, it is created along with all missing directories in its path.</li></ul></li></ul><h2 id="3-9-COPY"><a href="#3-9-COPY" class="headerlink" title="3.9 COPY"></a>3.9 COPY</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">COPY &lt;src&gt;... &lt;dest&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">COPY [<span class="string">"&lt;src&gt;"</span>,... <span class="string">"&lt;dest&gt;"</span>] (this form is required <span class="keyword">for</span> paths containing whitespace)</span></pre></td></tr></table></figure><ul><li>Chỉ thị COPY, copy file, thư mục (src) và thêm chúng vào filesystem của container (dest).</li><li>Các lưu ý tương tự chỉ thị ADD.</li></ul><h2 id="3-10-ENTRYPOINT"><a href="#3-10-ENTRYPOINT" class="headerlink" title="3.10 ENTRYPOINT"></a>3.10 ENTRYPOINT</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">"executable"</span>, <span class="string">"param1"</span>, <span class="string">"param2"</span>] (<span class="built_in">exec</span> form, preferred)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ENTRYPOINT <span class="built_in">command</span> param1 param2 (shell form)</span></pre></td></tr></table></figure><p>Hai cái CMD và ENTRYPOINT có tác dụng tương tự nhau. Nếu một Dockerfile có cả CMD và ENTRYPOINT thì CMD sẽ thành param cho script ENTRYPOINT.<br>Lý do người ta dùng ENTRYPOINT nhằm chuẩn bị các điều kiện setup như tạo user, mkdir, change owner… cần thiết để chạy service trong container. </p><h2 id="3-11-VOLUME"><a href="#3-11-VOLUME" class="headerlink" title="3.11 VOLUME"></a>3.11 VOLUME</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">VOLUME [<span class="string">"/data"</span>]</span></pre></td></tr></table></figure><ul><li>mount thư mục từ máy host và container. Tương tự <code>option -v</code> khi tạo container.</li><li>Thư mục chưa volumes là <code>/var/lib/docker/volumes/</code>. Ứng với mỗi container sẽ có các thư mục con nằm trong thư mục này. Tìm thư mục chưa Volumes của container <code>sad_euclid</code>: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@adk:/var/lib/docker/volumes<span class="comment"># docker inspect sad_euclid | grep /var/lib/docker/volumes</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="string">"Source"</span>: <span class="string">"/var/lib/docker/volumes/491a2a775a4cf02bbaca105ec25995008cc7adbc5511e054bb9c6a691a2681ee/_data"</span>,</span></pre></td></tr></table></figure></li></ul><h2 id="3-12-USER"><a href="#3-12-USER" class="headerlink" title="3.12 USER"></a>3.12 USER</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">USER daemon</span></pre></td></tr></table></figure><ul><li>Set username hoặc UID để chạy các lệnh RUN, CMD, ENTRYPOINT trong dockerfiles.</li></ul><h2 id="3-13-WORKDIR"><a href="#3-13-WORKDIR" class="headerlink" title="3.13 WORKDIR"></a>3.13 WORKDIR</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">WORKDIR /path/to/workdir</span></pre></td></tr></table></figure><ul><li>Chỉ thị WORKDIR dùng để đặt thư mục đang làm việc cho các chỉ thị khác như: RUN, CMD, ENTRYPOINT, COPY, ADD,…</li></ul><h2 id="3-14-ARG"><a href="#3-14-ARG" class="headerlink" title="3.14 ARG"></a>3.14 ARG</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ARG &lt;name&gt;[=&lt;default value&gt;]</span></pre></td></tr></table></figure><ul><li>Chỉ thị ARG dùng để định nghĩa các giá trị của biến được dùng trong quá trình build image (lệnh <code>docker build</code> –build-arg <varname>=<value>). </li><li>biến ARG sẽ không bền vững như khi sử dụng ENV.</li></ul><h2 id="3-15-STOPSIGNAL"><a href="#3-15-STOPSIGNAL" class="headerlink" title="3.15 STOPSIGNAL"></a>3.15 STOPSIGNAL</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">STOPSIGNAL signal</span></pre></td></tr></table></figure><ul><li>Gửi tín hiệu để container tắt đúng cách.</li></ul><h2 id="3-16-SHELL"><a href="#3-16-SHELL" class="headerlink" title="3.16 SHELL"></a>3.16 SHELL</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SHELL [<span class="string">"executable"</span>, <span class="string">"parameters"</span>]</span></pre></td></tr></table></figure><ul><li>Chỉ thị Shell cho phép các shell form khác có thể ghi đè shell mặc định.</li><li>Mặc định trên Linux là <code>[&quot;/bin/sh&quot;, &quot;-c&quot;]</code> và Windows là <code>[&quot;cmd&quot;, &quot;/S&quot;, &quot;/C&quot;]</code>.</li></ul><p>Ví dụ:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM microsoft/windowsservercore</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Executed as cmd /S /C echo default</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">RUN <span class="built_in">echo</span> default</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Executed as cmd /S /C powershell -command Write-Host default</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">RUN powershell -<span class="built_in">command</span> Write-Host default</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Executed as powershell -command Write-Host hello</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">SHELL [<span class="string">"powershell"</span>, <span class="string">"-command"</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">RUN Write-Host hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Executed as cmd /S /C echo hello</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">SHELL [<span class="string">"cmd"</span>, <span class="string">"/S"</span><span class="string">", "</span>/C<span class="string">"]</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="string">RUN echo hello</span></span></pre></td></tr></table></figure><h2 id="3-17-ONBUILD"><a href="#3-17-ONBUILD" class="headerlink" title="3.17 ONBUILD"></a>3.17 ONBUILD</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ONBUILD [INSTRUCTION]</span></pre></td></tr></table></figure><ul><li>Chỉ thị ONBUILD được khai báo trong base image. Và khi child image build image từ  base image thì lệnh ONBUILD mới được thực thi.</li><li>Ví dụ: <a href="http://container42.com/2014/02/06/docker-quicktip-3-onbuild/" target="_blank" rel="noopener">http://container42.com/2014/02/06/docker-quicktip-3-onbuild/</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3. Docker image</title>
      <link href="/2019/12/05/docker3/"/>
      <url>/2019/12/05/docker3/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker-Mirror-docker-images"><a href="#Docker-Mirror-docker-images" class="headerlink" title="Docker Mirror (docker images)"></a>Docker Mirror (docker images)</h1><h2 id="Mot-so-chu-y"><a href="#Mot-so-chu-y" class="headerlink" title="Một số chú ý"></a>Một số chú ý</h2><ul><li><p>Docker image: là template để tạo ra các container. Tức là các container được chạy từ các images này.</p></li><li><p>Có 02 cách để tạo ra các các mirror container</p><ul><li>Cách 1: Tạo một container, chạy các câu lệnh cần thiết và sử dụng lệnh <code>docker commit</code> để tạo ra image mới. Cách này thường không được khuyến cáo.</li><li>Cách 2: Viết một <code>Dockerfile</code> và thực thi nó để tạo ra một images. Thường mọi người dùng cách này để tạo ra image.</li></ul></li><li><p>Khi một container được tạo từ đầu, nó sẽ kéo các image (pull) từ <code>Docker Hub</code> (Docker registry mặc định) về và thực tạo container từ image đó. </p></li><li><p>Tất cả mọi người đều có thể tạo ra các images.</p></li><li><p>Docker hub có thành phần docker registry - được vận hành với công ty Docker, nơi đây chứa các images mà người dùng chia sẻ.</p></li><li><p>Các image là dạng file-chỉ-đọc (read only file). Khi tạo một container mới, trong mỗi container sẽ tạo thêm một lớp có-thể-ghi được gọi là container-layer. Các thay đổi trên container như thêm, sửa, xóa file… sẽ được ghi trên lớp này. Do vậy, từ một image ban đầu, ta có thể tạo ra nhiều máy con mà chỉ tốn rất ít dung lượng ổ đĩa.</p></li><li><p>Docker cung cấp 3 công cụ phân tán giúp chúng ta lưu trữ và quản lý các Docker image. Để tự dựng một private registry và lưu trữ các private image chúng ta có thể sử dụng một trong các công cụ sau:</p><ul><li>Docker Registry: một open source image distribution tool giúp lưu trữ và quản lý image</li><li>Docker Trusted Registry: một công cụ trả phí, nó khác với Docker Registry là có giao diện quản lý và cung cấp một số tính năng bảo mật (nghe bảo thế)</li><li>Docker Hub: đây là một dịch vụ khi mà bạn không muốn tự quản lý registry. Cung cấp public và private image repository. Mặc định Docker Client sẽ sử dụng Docker Hub nếu không có registry nào được cấu hình. Trên này có rất nhiều các image offcial của các phần mềm như nginx, mongodb, mysql, jenkins,..</li></ul></li><li><p>Quy tắt đặt tên images: <code>[REPOSITORY[:TAG]]</code></p><ul><li>Trong đó, TAG là phiên bản của images. Mặc định, khi không khai báo tag thì docker sẽ hiểu tag là <code>latest</code></li></ul></li></ul><h2 id="1-Mot-so-lenh-lam-viec-voi-images"><a href="#1-Mot-so-lenh-lam-viec-voi-images" class="headerlink" title="1. Một số lệnh làm việc với images"></a>1. Một số lệnh làm việc với images</h2><h3 id="1-1-Kiem-tra-hoat-dong-cua-docker"><a href="#1-1-Kiem-tra-hoat-dong-cua-docker" class="headerlink" title="1.1. Kiểm tra hoạt động của docker"></a>1.1. Kiểm tra hoạt động của docker</h3><ul><li><p>Sử dụng lệnh <code>docker run hello-world</code> để kiểm tra hoạt động của docker trên host.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run hello-world</span></pre></td></tr></table></figure></li><li><p>Lệnh trên sẽ gọi tới image tên là hello-world, đây là một image được lưu trên Docker Hub. Mục tiêu của image này là để kiểm tra hoạt động của docker được cài trên host đã ổn hay chưa.</p></li><li><p>Kết quả như sau chứng tỏ docker đã hoạt động ổn định</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker run hello-world</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Hello from Docker!</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">This message shows that your installation appears to be working correctly.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">....</span></pre></td></tr></table></figure></li></ul><h3 id="1-2-Tim-kiem-immages-tu-Docker-HUB"><a href="#1-2-Tim-kiem-immages-tu-Docker-HUB" class="headerlink" title="1.2. Tìm kiếm immages từ Docker HUB"></a>1.2. Tìm kiếm immages từ Docker HUB</h3><ul><li><p>Sử dụng lệnh <code>docker search</code> để tìm kiếm các images trên Docker HUB</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker search ubuntu</span></pre></td></tr></table></figure></li><li><p>Hoặc tìm chính xác phiên bản</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker search ubuntu:14.04</span></pre></td></tr></table></figure></li></ul><ul><li><p>Lệnh này sẽ thực hiện tìm kiếm images có tên là <code>ubuntu</code> từ internet, kết quả sẽ trả về các images có tên là <code>ubuntu</code></p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker search ubuntu</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">NAME                       DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ubuntu                     Ubuntu is a Debian-based Linux operating s...   5019      [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">ubuntu-upstart             Upstart is an event-based replacement <span class="keyword">for</span> ...   68        [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">rastasheep/ubuntu-sshd     Dockerized SSH service, built on top of of...   49                   [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">consol/ubuntu-xfce-vnc     Ubuntu container with <span class="string">"headless"</span> VNC sessi...   29                   [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">ubuntu-debootstrap         debootstrap --variant=minbase --components...   27        [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">torusware/speedus-ubuntu   Always updated official Ubuntu docker imag...   27                   [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">ioft/armhf-ubuntu          [ABR] Ubuntu Docker images <span class="keyword">for</span> the ARMv7(a...   19                   [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">nickistre/ubuntu-lamp      LAMP server on Ubuntu                           10                   [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">nuagebec/ubuntu            Simple always updated Ubuntu docker images...   9                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">nimmis/ubuntu              This is a docker images different LTS vers...   5                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">maxexcloo/ubuntu           Base image built on Ubuntu with init, Supe...   2                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">jordi/ubuntu               Ubuntu Base Image                               1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">darksheer/ubuntu           Base Ubuntu Image -- Updated hourly             1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">admiringworm/ubuntu        Base ubuntu images based on the official u...   1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">1and1internet/ubuntu-16    Ubuntu 16 Base Image                            1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">lynxtp/ubuntu              https://github.com/lynxtp/docker-ubuntu         0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">datenbetrieb/ubuntu        custom flavor of the official ubuntu base ...   0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">labengine/ubuntu           Images base ubuntu                              0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">webhippie/ubuntu           Docker images <span class="keyword">for</span> ubuntu                        0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">vcatechnology/ubuntu       A Ubuntu image that is updated daily            0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">esycat/ubuntu              Ubuntu LTS                                      0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">konstruktoid/ubuntu        Ubuntu base image                               0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">widerplan/ubuntu           Our basic Ubuntu images.                        0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">ustclug/ubuntu             ubuntu image <span class="keyword">for</span> docker with USTC mirror        0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">teamrock/ubuntu            TeamRock<span class="string">'s Ubuntu image configured with AW...   0                    [OK]</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="string">root@u14-vagrant:~#</span></span></pre></td></tr></table></figure></li><li><p>Trong đó:</p><ul><li>Cột <code>NAME</code> : tên của images</li><li>Cột <code>DESCRIPTION</code>: Mô tả ngắn gọn của images </li><li>Cột <code>OFFICIAL</code>: Là images chính thức do công ty Docker cung cấp. Trạng thái là OK.</li></ul></li></ul><ul><li><p>Kết quả của lệnh <code>docker search ubuntu:14.04</code></p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker search ubuntu:14.04</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">NAME                                                DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">saltstack/ubuntu-14.04-minimal                                                                      7                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">saltstack/ubuntu-14.04                                                                              5                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">simphonyproject/ubuntu-14.04-remote                 Ubuntu 14.04 with Remote Access Support (l...   1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">fernandoacorreia/ubuntu-14.04-oracle-java-1.7       Docker image with Ubuntu 14.04 and Oracle ...   1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">linuxmalaysia/docker-ubuntu-14.04-harden            Docker Ubuntu harden <span class="keyword">for</span> security with SSH...   1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">widerplan/ubuntu-14.04                              Basic Ubuntu 14.04 builds with a few utili...   1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">breezeight/<span class="built_in">test</span>-kitchen-ubuntu-14.04                Ubunti 14.04 with chef omnibus installed        1                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">stevendgonzales/ubuntu-14.04-salt-minion            Ubuntu 14.04 with Salt-MInion                   0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-bind9           Run DNS server using bind9 on Ubuntu 14.04      0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-apache2         Apache2 on Ubuntu 14.04                         0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">syseleven/ubuntu-14.04-puppet3                      ubuntu-14.04-puppet3                            0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-ruby            Ruby environment on Ubuntu 14.04                0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">thenewvu/ubuntu-14.04                               Ubuntu 14.04 + Nearby package repos             0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">simphonyproject/ubuntu-14.04-webapp                 Ubuntu 14.04 with backend framework suppor...   0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">libero18/ubuntu-14.04                                                                               0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-php5            PHP5 environment on Ubuntu 14.04                0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">salttest/ubuntu-14.04                                                                               0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-apt-cacher-ng   Run apt-cacher-ng on Ubuntu 14.04               0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-mysql           MySQL on Ubuntu 14.04                           0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">seresearch/opendavinci-ubuntu-14.04                 Docker image with all Ubuntu 14.04 depende...   0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">zanox/kitchen-ubuntu-14.04                          Docker image <span class="keyword">for</span> kitchen with ubuntu 14.04      0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">edentsai/ubuntu-14.04-openssh                       Official Ubuntu 14.04 LTS and OpenSSH serv...   0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">mba811/ubuntu-14.04                                 镜像ubuntu:14.04的容器                               0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">technopreneural/docker-ubuntu-14.04-puppetserver    Run puppetserver on Ubuntu 14.04                0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">simphonyproject/ubuntu-14.04-vncapp                 Ubuntu-14.04 with VNC application framework     0                    [OK]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Sau khi xác định được images muốn sử dụng, bạn sử dụng tiếp lệnh <code>docker pull</code> để kéo images từ internet về host cài docker của bạn. </p></li></ul><h3 id="1-3-Tai-images-tu-Docker-Hub-ve-host"><a href="#1-3-Tai-images-tu-Docker-Hub-ve-host" class="headerlink" title="1.3. Tải images từ Docker Hub về host"></a>1.3. Tải images từ Docker Hub về host</h3><ul><li><p>Ví dụ tải images có tên là <code>ubuntu</code> về host</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker pull ubuntu</span></pre></td></tr></table></figure>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">kết quả lệnh docker pull ubuntu</span></pre></td></tr></table></figure></li><li><p>Để tạo một container từ image <code>ubuntu</code>, sử dụng lệnh <code>docker run ubuntu</code></p></li></ul><h3 id="1-4-Kiem-tra-cac-images-ton-tai-tren-host"><a href="#1-4-Kiem-tra-cac-images-ton-tai-tren-host" class="headerlink" title="1.4. Kiểm tra các images tồn tại trên host."></a>1.4. Kiểm tra các images tồn tại trên host.</h3><ul><li><p>Sử dụng lệnh <code>docker images</code> để kiểm tra danh sách các images</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker images</span></pre></td></tr></table></figure></li><li><p>Kết quả: </p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker images</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ubuntu              latest              f753707788c5        4 weeks ago         127.2 MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">hello-world         latest              c54a2cc56cbb        4 months ago        1.848 kB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">training/webapp     latest              6fae60ef3446        18 months ago       348.8 MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><h3 id="1-5-Tao-container-tu-images"><a href="#1-5-Tao-container-tu-images" class="headerlink" title="1.5 Tạo container từ images"></a>1.5 Tạo container từ images</h3><ul><li><p>Trong các tài liệu thường hay sử dụng lệnh <code>docker run hello-world</code> để chạy một container, sau khi chạy xong container này nó sẽ thoát. Tuy nhiên, đa số chúng ta lại cần tương tác nhiều hơn nữa với container (thao tác nhiều hơn). </p></li><li><p>Để chạy container và tương tác với container ta sử dụng tùy chọn <code>-it</code> trong lệnh <code>docker run</code>. Ví dụ:</p></li></ul><pre><code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -it ubuntu</span></pre></td></tr></table></figure></code></pre><ul><li><p>Kết quả:</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker run -it ubuntu</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">root@4a7b498636b6:/<span class="comment"># cat /etc/*release</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">DISTRIB_ID=Ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">DISTRIB_RELEASE=16.04</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">DISTRIB_CODENAME=xenial</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">DISTRIB_DESCRIPTION=<span class="string">"Ubuntu 16.04.1 LTS"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">NAME=<span class="string">"Ubuntu"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">VERSION=<span class="string">"16.04.1 LTS (Xenial Xerus)"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">ID=ubuntu</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">ID_LIKE=debian</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">PRETTY_NAME=<span class="string">"Ubuntu 16.04.1 LTS"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">VERSION_ID=<span class="string">"16.04"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">HOME_URL=<span class="string">"http://www.ubuntu.com/"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">SUPPORT_URL=<span class="string">"http://help.ubuntu.com/"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">BUG_REPORT_URL=<span class="string">"http://bugs.launchpad.net/ubuntu/"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">UBUNTU_CODENAME=xenial</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">root@4a7b498636b6:/<span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Trong ví dụ trên, lệnh <code>docker run -it ubuntu</code> sẽ tạo một container từ image có tên là <code>ubuntu</code> và tương tác luôn với nó. Lệnh <code>cat /etc/*release</code> sẽ hiển thị phiên bản container ở trên. Số <code>4a7b498636b6</code> là ID của container </p></li><li><p>Có thể mở tab khác và sử dụng lệnh <code>docker events</code> để xem các thông tin về việc tạo container trong ví dụ trên (tab này cần được mở và chạy lệnh <code>docker events</code> trước khi thực hiện tạo container)</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">016-11-11T15:28:07.918591204+07:00 container start 4a7b498636b618728c7b00307708a0382bc0e6d7b28bba5534a91dfa30c46074 (image=ubuntu, name=goofy_hypatia)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">2016-11-11T15:28:07.921514758+07:00 container resize 4a7b498636b618728c7b00307708a0382bc0e6d7b28bba5534a91dfa30c46074 (height=32, image=ubuntu, name=goofy_hypatia, width=146)</span></pre></td></tr></table></figure></li></ul><ul><li><p>Để thoát nhưng vẫn đảm bảo container được hoạt động, sử dụng tổ hợp phím <code>CTL + p</code>, sau đó <code>CTL + q</code>. Còn nếu thoát và dừng container thì sử dụng <code>CTL + c</code></p></li><li><p>Sử dụng lệnh <code>docker attach ID_Container</code> để truy cập vào container sử dụng.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@u14-vagrant:~<span class="comment"># docker attach 4a7b498636b6</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">root@4a7b498636b6:/<span class="comment">#</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">root@4a7b498636b6:/<span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><h2 id="2-Push-Pull-images-using-Docker-Hub"><a href="#2-Push-Pull-images-using-Docker-Hub" class="headerlink" title="2. Push - Pull images using Docker Hub."></a>2. Push - Pull images using Docker Hub.</h2><ul><li><p>Để push 1 image vừa tạo lên hub để chia sẻ với mọi người, thì ta cần tạo 1 tài khoản docker hub và login vào bằng câu lệnh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker login</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don<span class="string">'t have a Docker ID, head over to https://hub.docker.com to create one.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="string">Username:cosy294</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="string">Password:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="string">Login Succeeded</span></span></pre></td></tr></table></figure></li><li><p>Sau khi login thành công ta tiến hành push image lên hub</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ docker push cosy294/<span class="built_in">test</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">The push refers to a repository [cosy294/<span class="built_in">test</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">255c5f0caf9a: Image successfully pushed</span></pre></td></tr></table></figure><p>Trong đó: cosy294/test là tên images.</p></li><li><p>Lưu ý: Nếu bạn muốn push images lên docker hub thì tên images phải có dạng: <code>cosy294/test</code>, trong đó <strong>cosy294</strong> là id dockerhub và <strong>test</strong> là tên repo.</p></li><li><p>Để Pull một image từ Docker Hub: <code>docker pull {image_name}</code></p></li></ul><h1 id="3-Create-and-use-Docker-Registry-Local-Images-Repo"><a href="#3-Create-and-use-Docker-Registry-Local-Images-Repo" class="headerlink" title="3. Create and use Docker Registry: Local Images Repo."></a>3. Create and use Docker Registry: Local Images Repo.</h1><ul><li><p>Tạo môi trường chứa image. Docker đã hỗ trợ chúng ta cài đặt các môi trường này duy nhất trong 1 container. Rất là đơn giản, chúng ta chạy lệnh sau.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --name registry registry:2</span></pre></td></tr></table></figure></li><li><p>Khi đó, port 5000 sẽ được listen. Mọi thao tác pull, push image sẽ được thực hiện trên port này.</p></li><li><p>Cấu hình docker để pull, push image từ registry vừa tạo: vi <code>/etc/default/docker</code></p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=<span class="string">"--insecure-registry 172.16.69.239:5000"</span></span></pre></td></tr></table></figure><ul><li>Trong đó, <code>172.16.69.239</code> là địa chỉ ip máy chứa registry tạo ở trên.</li><li>Sau khi cấu hình xong, ta khởi động lại docker<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">service docker restart</span></pre></td></tr></table></figure></li><li>Các thao tác pull và push image tương tự ở như là pull, push ở docker hub.</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2. Các ghi chép cần chú ý về docker</title>
      <link href="/2019/12/05/docker2/"/>
      <url>/2019/12/05/docker2/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Gioi-thieu-ve-Docker"><a href="#1-Gioi-thieu-ve-Docker" class="headerlink" title="1. Giới thiệu về Docker"></a>1. Giới thiệu về Docker</h1><hr><h1 id="Muc-luc"><a href="#Muc-luc" class="headerlink" title="Mục lục"></a>Mục lục</h1><ul><li><a href="#whatis">1.1 Docker là gì?</a></li><li><a href="#about">1.2 Chức năng, vai trò của Docker?</a></li><li><a href="#concepts">1.3 Các khái niệm cần biết khi sử dụng docker</a><ul><li><a href="#image">1.3.1 Image</a></li><li><a href="#registry">1.3.2 Registry</a></li><li><a href="#volume">1.3.3 Volume</a></li><li><a href="#container">1.3.4 Container</a></li><li><a href="#docker-file">1.3.5 Dockerfile</a></li></ul></li><li><a href="#compose">1.4 Các thành phần, kiến trúc trong Docker</a></li><li><a href="#workflow">1.5 Các trạng thái, thứ tự chuyển giao trạng thái của container trong Docker</a></li><li><a href="#network">1.6 Network trong Docker</a></li><li><a href="#volume">1.7 Volume trong Docker</a></li><li><a href="#content-others">Các nội dung khác</a></li></ul><hr><h1 id="Noi-dung"><a href="#Noi-dung" class="headerlink" title="Nội dung"></a><a name="content">Nội dung</a></h1><ul><li><h3 id="1-1-Docker-la-gi"><a href="#1-1-Docker-la-gi" class="headerlink" title="1.1 Docker là gì?"></a><a name="whatis">1.1 Docker là gì?</a></h3><ul><li><p>Docker là một ứng dụng mã nguồn mở cho phép độc lập triển khai giữa các ứng dụng và cơ sở hạ tầng đối với các nhà phát triển và mở ra tiềm năng tạo nên một mô hình cho sự hợp tác tốt và đổi mới hơn.</p></li><li><p>Docker giải quyết vấn đề khi mà các doanh nghiệp ngày nay đang chịu áp lực phải chuyển đổi kỹ thuật số nhưng bị hạn chế bởi các ứng dụng và cơ sở hạ tầng hiện tại đồng thời hợp lý hóa danh mục cloud, trung tâm dữ liệu và kiến trúc ứng dụng ngày càng đa dạng.</p></li></ul></li><li><h3 id="1-2-Chuc-nang-vai-tro-cua-Docker"><a href="#1-2-Chuc-nang-vai-tro-cua-Docker" class="headerlink" title="1.2 Chức năng, vai trò của Docker?"></a><a name="about">1.2 Chức năng, vai trò của Docker?</a></h3><ul><li><p>Cho phép phát triển, di chuyển và chạy các ứng dụng dựa vào công nghệ ảo hóa container trong Linux.</p></li><li><p>Tự động triển khai các ứng dụng bên trong các container bằng cách cung cấp thêm một lớp trừu tượng và tự động hóa việc ảo hóa “mức hệ điều hành”.</p></li><li><p>Docker có thể sử dụng được trên cả 3 hệ điều hành phổ biến: Windows, Linux và Mac OS.</p></li><li><p>Lợi ích của docker bao gồm:</p><ul><li>Nhanh trong việc triển khai, di chuyển, khởi động container</li><li>Bảo mật</li><li>Lightweight (tiết kiệm disk &amp; CPU)</li><li>Mã nguồn mở</li><li>Hỗ trợ APIs để giao tiếp với container</li><li>Phù hợp trong môi trường làm việc đòi hòi phải liên tục tích hợp và triển khai các dịch vụ, phát triển cục bộ, các ứng dụng multi-tier.</li></ul></li></ul></li><li><h3 id="1-3-Cac-khai-niem-can-biet-khi-su-dung-docker"><a href="#1-3-Cac-khai-niem-can-biet-khi-su-dung-docker" class="headerlink" title="1.3 Các khái niệm cần biết khi sử dụng docker"></a><a name="concepts">1.3 Các khái niệm cần biết khi sử dụng docker</a></h3><ul><li><h3 id="1-3-1-Image"><a href="#1-3-1-Image" class="headerlink" title="1.3.1 Image"></a><a name="image">1.3.1 Image</a></h3><ul><li><p>Image trong Docker hay còn gọi là Mirror. Là một template có sẵn (hoặc có thể tự tạo) với các chỉ dẫn dùng để tạo ra các container. </p></li><li><p>Được xây dựng từ một loạt các layers. Mỗi layer là một kết quả đại diện cho một lệnh trong Dockerfile.</p></li><li><p>Lưu trữ dưới dạng read-only template.</p></li></ul></li><li><h3 id="1-3-2-Registry"><a href="#1-3-2-Registry" class="headerlink" title="1.3.2 Registry"></a><a name="registry">1.3.2 Registry</a></h3><ul><li><p>Docker Registry là nơi lưu trữ các image với hai chế độ là private và public.</p></li><li><p>Là nơi cho phép chia sẻ các image template để sử dụng trong quá trình làm việc với Docker.</p></li></ul></li><li><h3 id="1-3-3-Volume"><a href="#1-3-3-Volume" class="headerlink" title="1.3.3 Volume"></a><a name="volume">1.3.3 Volume</a></h3><ul><li><p>Volume trong Docker là nơi dùng để chia sẻ dữ liệu cho các container.</p></li><li><p>Có thể thực hiện sử dụng Volume đối với 2 trường hợp:</p><ul><li>Chia sẻ giữa container với container.</li><li>Chia sẻ giữa container và host.</li></ul></li></ul></li><li><h3 id="1-3-4-Container"><a href="#1-3-4-Container" class="headerlink" title="1.3.4 Container"></a><a name="container">1.3.4 Container</a></h3><ul><li><p>Docker Container là một thể hiện của Docker Image với những thao tác cơ bản để sử dụng qua CLI như start, stop, restart hay delete, …</p></li><li><p>Container Image là một gói phần mềm thực thi lightweight, độc lập và có thể thực thi được bao gồm mọi thứ cần thiết để chạy được nó: code, runtime, system tools, system libraries, settings. Các ứng dụng có sẵn cho cả Linux và Windows, các container sẽ luôn chạy ổn định bất kể môi trường.</p><blockquote><p><img alt="docker-container-images" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-container-images.png" class="lazyload"></p></blockquote></li><li><p>Containers and virtual machines có sự cách ly và phân bổ tài nguyên tương tự, nhưng có chức năng khác vì các container ảo hóa hệ điều hành thay vì phần cứng. Các container có tính portable và hiệu quả hơn.</p><blockquote><p><img alt="docker-container-vms" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-container-vms.png" class="lazyload"></p></blockquote><ul><li><p>Container là một sự trừu tượng hóa ở lớp ứng dụng và code phụ thuộc vào nhau. Nhiều container có thể chạy trên cùng một máy và chia sẻ kernel của hệ điều hành với các container khác, mỗi máy đều chạy như các quá trình bị cô lập trong không gian người dùng. Các container chiếm ít không gian hơn các máy ảo (container image thường có vài trăm thậm chí là vài MB), và start gần như ngay lập tức.</p></li><li><p>Máy ảo (VM) là một sự trừu tượng của phần cứng vật lý chuyển tiếp từ một máy chủ sang nhiều máy chủ. Hypervisor cho phép nhiều máy ảo chạy trên một máy duy nhất. Mỗi máy ảo bao gồm một bản sao đầy đủ của một hệ điều hành, một hoặc nhiều ứng dụng, các chương trình và thư viện cần thiết - chiếm hàng chục GB. Máy ảo cũng có thể khởi động chậm.</p></li></ul></li></ul></li><li><h3 id="1-3-5-Dockerfile"><a href="#1-3-5-Dockerfile" class="headerlink" title="1.3.5 Dockerfile"></a><a name="docker-file">1.3.5 Dockerfile</a></h3><ul><li><p>Docker Image có thể được tạo ra một cách tự động bằng việc đọc các chỉ dẫn trong Dockerfile.</p></li><li><p>Dockerfile là một dữ liệu văn bản bao gồm các câu lệnh mà người sử dụng có thể gọi qua các dòng lệnh để tạo ra một image.</p></li><li><p>Bằng việc sử dụng <code>docker build</code> người dùng có thể tạo một tự động xây dựng thực hiện một số lệnh dòng lệnh liên tiếp.</p></li></ul></li></ul></li><li><h3 id="1-4-Cac-thanh-phan-kien-truc-trong-Docker"><a href="#1-4-Cac-thanh-phan-kien-truc-trong-Docker" class="headerlink" title="1.4 Các thành phần, kiến trúc trong Docker"></a><a name="compose">1.4 Các thành phần, kiến trúc trong Docker</a></h3><blockquote><p><img alt="engine-components-flow.png" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-engine-components-flow.png" class="lazyload"></p></blockquote><ul><li><p>Hình ảnh bên trên là mô tả về <code>Docker Engine</code>. Theo đó, <code>Docker Engine</code> là một ứng dụng client-server với các thành phần chính:</p><ul><li>Một máy chủ đảm nhiệm thực hiện quá trình daemon (chạy câu lệnh <code>dockerd</code>).</li><li>REST API xác định các giao diện mà các chương trình có thể sử dụng để nói chuyện với daemon và hướng dẫn nó phải làm gì.</li><li>Một CLI (chạy câu lệnh <code>docker</code>).</li></ul></li><li><p>CLI sẽ sử dụng Docker REST API để kiểm soát hoặc tương tác với Docker daemon thông qua kịch bản hoặc lệnh CLI trực tiếp.</p><blockquote><p><img alt="architecture.png" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-architecture.png" class="lazyload"></p></blockquote></li><li><p>Docker sử dụng kiến trúc client-server. Docker client sẽ giao tiếp với Docker daemon các công việc building, running và distributing các Docker Container.</p></li><li><p>Docker client và Docker daemon có thể chạy cùng trên một hệ thống hoặc ta có thể kết nối một Docker client tới một remote Docker daemon. Docker client và Docker daemon liên lạc với nhau bằng việc sử dụng REST API thông qua UNIX sockets hoặc network interfaces.</p></li><li><p>Docker daemon (dockerd ) sẽ lắng nghe các request từ Docker API và quản lý Docker objects bao gồm images, containers, networks và volumes. Một daemon cũng có thể liên lạc với các daemons khác để quản lý Docker services.</p></li><li><p>Docker client (docker ) là con đường chính để những người sử dụng Docker tương tác và giao tiếp với Docker. Khi sử dụng mộ câu lệnh chẳng hạn như <code>docker run</code> thì client sẽ gửi câu lệnh tới dockerd để thực hiện câu lệnh. Các câu lệnh từ Docker client sử dụng Docker API và có thể giao tiếp với nhiều Docker daemon.</p></li></ul></li><li><h3 id="1-5-Cac-trang-thai-su-chuyen-giao-trang-thai-cua-container-trong-Docker"><a href="#1-5-Cac-trang-thai-su-chuyen-giao-trang-thai-cua-container-trong-Docker" class="headerlink" title="1.5 Các trạng thái, sự chuyển giao trạng thái của container trong Docker"></a><a name="workflow">1.5 Các trạng thái, sự chuyển giao trạng thái của container trong Docker</a></h3><p>  Hình ảnh dưới đây mô tả cho một vòng đời của container trong Docker cùng với các trạng thái hoạt động:</p><blockquote><p><img alt="docker-state" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-state.png" class="lazyload"></p></blockquote></li><li><h3 id="1-6-Network-trong-Docker"><a href="#1-6-Network-trong-Docker" class="headerlink" title="1.6 Network trong Docker"></a><a name="network">1.6 Network trong Docker</a></h3><p>  Dưới đây là hình ảnh mô tả kiến trúc Network của Container hay còn gọi là Container Networking Model (CNM).</p><blockquote><p><img alt="docker-network-models" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-network-models.png" class="lazyload"></p></blockquote><p>  Đây là cấu trúc mức độ cao trong CNM. Theo đó, ta có:</p><ul><li><p>Sandbox - Chứa các cấu hình của ngăn xếp mạng container. Bao gồm quản lý network interface, route table và các thiết lập DNS. Một Sandbox có thể được coi là một namespace network và có thể chứa nhiều endpoit từ nhiều mạng.</p></li><li><p>Endpoint - Là điểm kết nối một Sandbox tới một mạng.</p></li><li><p>Network - CNM không chỉ định một mạng tuân theo mô hình OSI. Việc triển khai mạng có thể là VLAN, Bridge, … Các endpoint không kết nối với mạng thì không có kết nối trên mạng.</p></li></ul><ul><li><p>CNM cung cấp 2 interface có thể được sử dụng cho việc liên lạc, điều khiển, … container trong mạng:</p><ul><li><p><code>Network Drivers</code> - Cung cấp, thực hiện thực tế việc tạo ra một mạng hoạt động. Được sử dụng với các drivers khác và thay đổi một cách dễ dàng đối với các trường hợp cụ thể. Nhiều network driver có thể được sử dụng trong Docker nhưng mỗi một network chỉ là một khởi tạo từ một network driver duy nhất. Theo đó mà ta có 2 loại chính của CNM network drivers như sau:</p><ul><li><p><code>Native Network Drivers</code> - Là một phần của Docker Engine và được cung cấp bới Docker. Có nhiều drivers để dễ dàng lựa chọn cho khả năng của mạng như overlay networks hay local bridges.</p></li><li><p><code>Remote Network Drivers</code> - Là các network drivers được tạo ra bởi cộng đồng và các nhà cung cấp. Được sử dụng để tích hợp vào các phần mềm hoặc phần cứng đang hoạt động.</p></li></ul></li><li><p><code>IPAM Drivers</code>: Drivers quản lý các địa chỉ IP cung cấp mặc định cho các mạng con hoặc địa chỉ IP cho các mạng và endpoint nếu chúng không được chỉ định. Địa chỉ IP cũng có thể gán thủ công qua mạng, container, …</p></li></ul></li><li><p>Giao tiếp giữa docker engine - libnetwork - driver</p><blockquote><p><img alt="docker-ipam-network" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-ipam-network.png" class="lazyload"></p></blockquote></li><li><p><code>Docker Native Network Drivers</code> - là một phần của Docker Engine và không yêu cầu cần phải có nhiều modules. Được gọi và sử dụng thông qua các câu lệnh <code>docker network</code>. Dưới đây là native network hiện có:</p><table><thead><tr><th>Driver</th><th>Mô tả</th></tr></thead><tbody><tr><td>Host</td><td>Với host driver, một container sẽ sử dụng ngăn xếp mạng của host. Không có sự phân biệt giữa namespace, tất cả các interface trên host có thể được sử dụng trực tiếp bởi container</td></tr><tr><td>Bridge</td><td>Bridge driver tạo ra Linux bridges trên host và được quản lý bởi Docker. Mặc định, containers trên một bridge có thể liên lạc với nhau. Việc truy cập từ bên ngoài tới các container có thể được cấu hình thông qua bridge driver.</td></tr><tr><td>Overlay</td><td>Overlay driver tạo ra một overlay network hỗ trợ cho các mạng multi-host. Được sử dụng kết hợp với Linux bridges và VXLAN để che đi liên lạc giữa các container qua cơ sở mạng hạ tầng vật lý.</td></tr><tr><td>MACVLAN</td><td>MACVLAN driver sử dụng chế độ MACVLAN bridge để thiết lập kết nối giữa container interface và host interface (hoặc sub-interface). Nó có thể được sử dụng để cung cấp địa chỉ IP cho các container và định tuyến trên mạng vật lý. Ngoài ra VLANs có thể được trunked đến MACVLAN driver</td></tr><tr><td>None</td><td>None driver cho một ngăn xếp mạng riêng và namespace nhưng không cấu hình interfaces bên trong container. Nếu không có cấu hình bổ sung, container hoàn toàn bị cô lập khỏi mạng của host</td></tr></tbody></table></li><li><p>Đối với native driver network trong container. Ta có:</p><ul><li><p>Chiều outbound khi các container sử dụng trong container </p><blockquote><p><img alt="docker-native-network-out.png" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-native-network-out.png" class="lazyload"></p></blockquote></li><li><p>Chiều inbound khi các container sử dụng trong container </p><blockquote><p><img alt="docker-native-network-in.png" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-native-network-in.png" class="lazyload"></p></blockquote></li><li><p>Container kết nối với network thông quan docker0 interface:</p><blockquote><p><img alt="docker-native-network-inhost" data-src="https://github.com/hocchudong/ghichep-docker/raw/master/images/docker-native-network-inhost.png" class="lazyload"></p></blockquote></li></ul></li></ul></li></ul><ul><li><h3 id="1-7-Volume-trong-Docker"><a href="#1-7-Volume-trong-Docker" class="headerlink" title="1.7 Volume trong Docker"></a><a name="volume">1.7 Volume trong Docker</a></h3><ul><li><p>Volume là một thư mục đặc biệt được chỉ định trong một hoặc nhiều container.</p></li><li><p>Volumes được thiết kế để duy trì dữ liệu, độc lập với vòng đời của container.</p></li><li><p>Do đó, Docker sẽ không bao giờ tự động xóa volumes khi ta xóa bỏ containers. Còn được biết đến là <code>data volume</code>.</p></li></ul><ul><li><p>Có 3 kiểu volume đó là: host, anonymous, named:</p><ul><li><p><code>host volume</code> - tồn tại trên filesystem của Docker host và có thể được truy cập từ bên trong container.</p></li><li><p><code>named volume</code>- là volume được Docker quản lý và được đặt tên.</p></li><li><p><code>anonymous volume</code>- tương tự như <code>named volume</code>. Tuy nhiên rất khó để có thể tham vấn tới cùng một volume theo thời gian khi volume là một đối tượng vô danh. Lưu trữ các tập tin mà Docker xử lý.</p></li></ul></li></ul></li></ul><hr>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1. Cài đặt docker engine cơ bản (Cài đặt môi trường lab)</title>
      <link href="/2019/12/05/docker1/"/>
      <url>/2019/12/05/docker1/</url>
      
        <content type="html"><![CDATA[<h1 id="Huong-dan-cai-dat-Docker"><a href="#Huong-dan-cai-dat-Docker" class="headerlink" title="Hướng dẫn cài đặt Docker"></a>Hướng dẫn cài đặt Docker</h1><h2 id="MUC-LUC"><a href="#MUC-LUC" class="headerlink" title="MỤC LỤC"></a>MỤC LỤC</h2><ul><li>Cài đặt docker engine</li><li>Các thao tác cơ bản sau khi cài đặt docker.<ul><li>Thực thi một container.</li><li>Thao tác với một container với chế độ tương tác, sử dụng tùy chọn <code>-it</code>.</li><li>Tạo một container với chế độ deamon, sử dụng tùy chọn <code>-d</code>.</li><li>Tạo một container với port chỉ định, sử dụng tùy chọn <code>-p</code>.</li><li>Thao tác với một container đã tồn tại.</li><li>Chỉ định RAM và CPU cho một container.</li><li>Lệnh xem nội dung của một container, xem log và kiểm tra port</li><li>Các lệnh xóa các container.</li></ul></li></ul><h2 id="Cai-dat-docker-engine"><a href="#Cai-dat-docker-engine" class="headerlink" title="Cài đặt docker engine"></a>Cài đặt docker engine</h2><h3 id="Cai-ban-stable-moi-nhat"><a href="#Cai-ban-stable-moi-nhat" class="headerlink" title="Cài bản stable mới nhất"></a>Cài bản stable mới nhất</h3><ul><li><p>Các OS áp dụng: CentOS 7.3 64bit, Ubuntu 14.04 64bit, Ubuntu 16.04 64bit</p></li><li><p>Đăng nhập với quyên <code>root</code> và thực hiện lệnh dưới để cài đặt. Đảm bảo máy có kết nối internet.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">su - </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.docker.com/ | sudo sh</span></pre></td></tr></table></figure><ul><li>Kết quả của lệnh trên như bên dưới  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">If you would like to use Docker as a non-root user, you should now consider</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">adding your user to the <span class="string">"docker"</span> group with something like:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker your-user</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">Remember that you will have to <span class="built_in">log</span> out and back <span class="keyword">in</span> <span class="keyword">for</span> this to take effect!</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">WARNING: Adding a user to the <span class="string">"docker"</span> group will grant the ability to run</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"> containers <span class="built_in">which</span> can be used to obtain root privileges on the</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> docker host.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"> Refer to https://docs.docker.com/engine/security/security/<span class="comment">#docker-daemon-attack-surface</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"> <span class="keyword">for</span> more information.</span></pre></td></tr></table></figure></li></ul></li><li><p>Thực hiện lệnh dưới để phân quyền cho user hiện tại thuộc group <code>docker</code></p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker `whoami`</span></pre></td></tr></table></figure></li><li><p>Kích hoạt docker sau khi cài đặt xong và cho phép khởi động cùng OS</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl start docker.service</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker.service</span></pre></td></tr></table></figure></li><li><p>Kiểm tra trạng thái của docker sau khi khởi động</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl status docker.service</span></pre></td></tr></table></figure><ul><li>Kết quả lệnh trên như dưới là ok  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker.service - Docker Application Container Engine</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> Active: active (running) since Wed 2017-09-06 21:54:07 +07; 31s ago</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> Docs: https://docs.docker.com</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> Main PID: 2194 (dockerd)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> CGroup: /system.slice/docker.service</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> ├─2194 /usr/bin/dockerd</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> └─2200 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/<span class="keyword">do</span>...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">Sep 06 21:54:05 docker1 dockerd[2194]: time=<span class="string">"2017-09-06T21:54:05.324752580+07:00"</span> level=warning msg=<span class="string">"failed to rename /var/lib/docker/tmp for background...hronously"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">Sep 06 21:54:05 docker1 dockerd[2194]: time=<span class="string">"2017-09-06T21:54:05.421102352+07:00"</span> level=warning msg=<span class="string">"overlay: the backing xfs filesystem is formatted without d_ty...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:05 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:05.541746640+07:00<span class="string">" level=info msg="</span>Graph migration to content-addressability took 0.00 seconds<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:05 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:05.544930723+07:00<span class="string">" level=info msg="</span>Loading containers: start.<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:06 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:06.931709192+07:00<span class="string">" level=info msg="</span>Default bridge (docker0) is assigned with an IP addres...P address<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:07 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:07.880341611+07:00<span class="string">" level=info msg="</span>Loading containers: <span class="keyword">done</span>.<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:07 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:07.934858409+07:00<span class="string">" level=info msg="</span>Docker daemon<span class="string">" commit=8784753 graphdriver(s)=overlay v...17.07.0-ce</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:07 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:07.936237331+07:00<span class="string">" level=info msg="</span>Daemon has completed initialization<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:07 docker1 dockerd[2194]: time="</span>2017-09-06T21:54:07.983301268+07:00<span class="string">" level=info msg="</span>API listen on /var/run/docker.sock<span class="string">"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="string">Sep 06 21:54:07 docker1 systemd[1]: Started Docker Application Container Engine.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="string">Hint: Some lines were ellipsized, use -l to show in full.</span></span></pre></td></tr></table></figure></li></ul></li><li><p>Kiểm tra phiên bản của docker sau khi cài đặt, trong hướng dẫn này là bản 17.07.0-ce</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker version</span></pre></td></tr></table></figure><ul><li>Kết quả như sau:   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Client:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> Version:      17.07.0-ce</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> API version:  1.31</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> Go version:   go1.8.3</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> Git commit:   8784753</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> Built:        Tue Aug 29 17:42:01 2017</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> OS/Arch:      linux/amd64</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">Server:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> Version:      17.07.0-ce</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"> API version:  1.31 (minimum version 1.12)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"> Go version:   go1.8.3</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"> Git commit:   8784753</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"> Built:        Tue Aug 29 17:43:23 2017</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"> OS/Arch:      linux/amd64</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> Experimental: <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">``` </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">- Kiểm tra xem docker đã hoạt động hay chưa</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">```sh</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">docker pull hello-world</span></pre></td></tr></table></figure></li><li>Kết quả như sau:  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Using default tag: latest</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">latest: Pulling from library/hello-world</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">b04784fba78d: Pull complete</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Digest: sha256:f3b3b28a45160805bb16542c9531888519430e9e6d6ffc09d72261b0d26ff74f</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span></pre></td></tr></table></figure></li></ul></li><li><p>Thử tạo container đầu tiên</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run hello-world</span></pre></td></tr></table></figure><ul><li>Kết quả như sau:   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Hello from Docker!</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">This message shows that your installation appears to be working correctly.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">To generate this message, Docker took the following steps:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> 1. The Docker client contacted the Docker daemon.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> 2. The Docker daemon pulled the <span class="string">"hello-world"</span> image from the Docker Hub.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">executable that produces the output you are currently reading.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">to your terminal.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"> $ docker run -it ubuntu bash</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">Share images, automate workflows, and more with a free Docker ID:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> https://cloud.docker.com/</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">For more examples and ideas, visit:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"> https://docs.docker.com/engine/userguide/</span></pre></td></tr></table></figure></li></ul></li><li><p>Kết thúc việc cài đặt, nếu kết quả ổn thì bạn đã có thể bắt đầu tìm hiểu về docker.</p></li></ul><h3 id="Mot-so-thao-tac-de-trai-nghiem-docker-sau-khi-cai-dat"><a href="#Mot-so-thao-tac-de-trai-nghiem-docker-sau-khi-cai-dat" class="headerlink" title="Một số thao tác để trải nghiệm docker sau khi cài đặt"></a>Một số thao tác để trải nghiệm docker sau khi cài đặt</h3><p>Sau khi cài đặt docker xong, bạn nên trải nghiệm cách sử dụng docker với các thao tác cơ bản trước khi đi vào chi tiết của từng thành phần.</p><h4 id="Chay-mot-container"><a href="#Chay-mot-container" class="headerlink" title="Chạy một container"></a>Chạy một container</h4><p>Chạy một container tức là khởi chạy một ứng dụng nào đó trong container. Hãy thực hiện các lệnh dưới và cùng đối chiếu kết kết quả.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run busybox <span class="built_in">echo</span> <span class="string">'Xin chao'</span></span></pre></td></tr></table></figure><ul><li><p>Kết quả: Màn hình sẽ trả về dòng thông báo ở trên. </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Xin chao</span></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run busybox whoami</span></pre></td></tr></table></figure></li><li><p>Kết quả: Lệnh <code>whoami</code> sẽ được thực hiện trong container và đưa thông báo ra bên ngoài.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root</span></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run busybox route</span></pre></td></tr></table></figure></li><li><p>Kết quả:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Kernel IP routing table</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">default         172.17.0.1      0.0.0.0         UG    0      0        0 eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">172.17.0.0      *               255.255.0.0     U     0      0        0 eth0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment">#</span></span></pre></td></tr></table></figure></li></ul><ul><li><p>Chúng ta có thể thấy cú pháp của 03 lệnh trên là <code>docker run &lt;ten_image&gt; &lt;cau_lenh_duoc_thuc_hien&gt;</code>. Trong đó:</p><ul><li><code>docker</code>: là tên lệnh để máy cài docker thực hiện thao tác với docker bằng CLI.</li><li><code>run</code>: là tùy chọn để thực hiện, ngoài <code>run</code> còn nhất nhiều các tùy chọn khác như <code>images, pull, rmi ...</code>, chúng ta sẽ khám phá sau.</li><li><code>busybox</code>: là tên images dùng để tạo các container.</li><li><code>echo, whoami, route</code>: là các lệnh sẽ được truyền vào trong container thực hiện.</li></ul></li><li><p>Ta cũng để ý, khi thực hiện lệnh <code>docker run</code> thì máy sẽ tiến hành tìm kiếm images được chỉ định trong localhost, nếu không có thì mặc nó sẽ thực hiện <code>pulled</code> từ registry Docker Hub về máy cài docker. Registry Docker Hub là một <code>kho</code> lưu trữ các images. Ta cũng có thể sử dụng một registry local - tức là một registry offline trong nội bộ mạng LAN.</p></li></ul><h4 id="Thao-tac-voi-mot-container-voi-che-do-tuong-tac-su-dung-tuy-chon-it"><a href="#Thao-tac-voi-mot-container-voi-che-do-tuong-tac-su-dung-tuy-chon-it" class="headerlink" title="Thao tác với một container với chế độ tương tác, sử dụng tùy chọn -it"></a>Thao tác với một container với chế độ tương tác, sử dụng tùy chọn <code>-it</code></h4><ul><li><p>Trong các ví dụ trước ta mới thao tác để thực thi nhanh với các container, trong phần này ta sẽ sử dụng cách tương tác với một container. Có nghĩa là tạo ra các container và thao tác trực tiếp với chúng. Hãy chạy lệnh dưới.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -it busybox</span></pre></td></tr></table></figure></li></ul><p>Trong lệnh trên ta sử dụng tùy chọn <code>-it</code> - đây chính là tùy chọn cho phép tương tác trực tiếp trong container, kết quả ta sẽ nhận được cửa sổ thao tác trong container như sau.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># docker run -it busybox</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># echo "Chao cac ban"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Chao cac ban</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment">#</span></span></pre></td></tr></table></figure><ul><li>Trong mục trên các bạn có thể thấy ta đã thực hiện lệnh <code>echo &quot;Chao cac ban&quot;</code> và kết quả hiển thị ra màn hình. Để thoát khỏi chế độ tương tác với container ta dùng lệnh <code>exit</code>/<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># docker run -it busybox</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># echo "Chao cac ban"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Chao cac ban</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># exit</span></span></pre></td></tr></table></figure></li></ul><p>Trong phần trên ta đã sử dụng tùy chọn <code>-it</code>, trong đó <code>-i</code> là tùy chọn sử dụng để tạo container với chế độ tương tác, tùy chọn <code>-t</code> là tùy chọn mở ra một phiên làm việc. Nếu chỉ sử dụng tùy chọn <code>-i</code> thì chúng ta sẽ mở ra một section và đóng lại luôn. Nếu sử dụng chỉ tùy chọn <code>-t</code> thì sẽ mở ra một section và không thao tác được.</p><h4 id="Tao-mot-container-voi-che-do-deamon-su-dung-tuy-chon-d"><a href="#Tao-mot-container-voi-che-do-deamon-su-dung-tuy-chon-d" class="headerlink" title="Tạo một container với chế độ deamon, sử dụng tùy chọn -d"></a>Tạo một container với chế độ deamon, sử dụng tùy chọn <code>-d</code></h4><p>Thông thường, khi tạo một container với các tùy chọn trước thì sau khi tạo xong hoặc thoát container thì ngay lập tức container đó sẽ dừng hoạt động. Trong một số trường hợp ta sẽ cần các container chạy ngầm, trong trường hợp này ta sử dụng tùy chọn <code>-d</code>.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d httpd</span></pre></td></tr></table></figure><p>Sau khi chạy lệnh trên xong, ta có thể sử dụng lệnh <code>docker ps</code> để xem container này còn hoạt động hay không (nếu để quan sát cả container đã dừng thì dùng lệnh <code>docker ps -a</code>).</p><ul><li><p>Kết quả lệnh <code>docker ps</code>. Chú ý quan sát cột <code>STATUS</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS              PORTS               NAMES</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">4522587672e0        httpd               <span class="string">"httpd-foreground"</span>   4 seconds ago       Up 3 seconds        80/tcp              modest_perlman</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment">#</span></span></pre></td></tr></table></figure></li><li><p>Kết quả lệnh <code>docker ps -a</code>.Chú ý quan sát cột <code>STATUS</code>. Ta thấy trước đó có các container đã được tạo mà không có tùy chọn <code>-d</code> đang có status là <code>Exited</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># docker ps -a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                 CREATED             STATUS                           PORTS               NAMES</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">4522587672e0        httpd               <span class="string">"httpd-foreground"</span>      58 seconds ago      Up 57 seconds                    80/tcp              modest_perlman</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">30b7e0f132af        busybox             <span class="string">"sh"</span>                    33 minutes ago      Exited (0) 32 minutes ago                            cocky_leakey</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">a0075342c64f        busybox             <span class="string">"route"</span>                 41 minutes ago      Exited (0) 41 minutes ago                            youthful_lovelace</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">ab55d78fa2c9        httpd               <span class="string">"httpd-foreground"</span>      About an hour ago   Exited (0) About a minute ago                        elated_brahmagupta</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">6bf88da1f473        httpd               <span class="string">"httpd-foreground"</span>      About an hour ago   Exited (0) About a minute ago                        loving_curie</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">46fe544a7d20        httpd               <span class="string">"httpd-foreground"</span>      About an hour ago   Exited (0) About a minute ago                        compassionate_hugle</span></pre></td></tr></table></figure></li></ul><h4 id="Tao-mot-container-voi-port-chi-dinh-su-dung-tuy-chon-p"><a href="#Tao-mot-container-voi-port-chi-dinh-su-dung-tuy-chon-p" class="headerlink" title="Tạo một container với port chỉ định, sử dụng tùy chọn -p"></a>Tạo một container với port chỉ định, sử dụng tùy chọn <code>-p</code></h4><p>Nếu không chỉ định tùy chọn <code>-p</code> cho container thì thường container sinh ra sẽ có một port mặc định nào đó, lúc đó ta muốn sử dụng container đó thì phải đứng ở máy chứa container và thao tác, ví dụ như ta có một container chạy ứng dụng web, lúc đó ta có thể truy cập tới ứng dụng web trên máy cài đặt container với port của container được sinh ra mặc định.</p><p>Do vậy, để <code>phơi</code> một port của container ra bên ngoài - giúp các máy ngoài container có thể sử dụng được thì ta cần dùng tùy chọn <code>-p</code>. Ở ví dụ dưới ta sẽ tạo ra một container chạy web và ánh xạ port 4000 của máy host tới port 80 của container được sinh ra.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 4000:80 httpd</span></pre></td></tr></table></figure><ul><li><p>Sử dụng lệnh <code>docker ps</code>, ta có thể quan sát cột <code>PORTS</code> để thấy thông số ánh xạ port giữa host (Máy cái docker) và container </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS              PORTS                  NAMES</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">4594542ec71b        httpd               <span class="string">"httpd-foreground"</span>   40 seconds ago      Up 39 seconds       0.0.0.0:4000-&gt;80/tcp   goofy_euler</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">4522587672e0        httpd               <span class="string">"httpd-foreground"</span>   8 minutes ago       Up 8 minutes        80/tcp                 modest_perlman</span></pre></td></tr></table></figure></li></ul><p>Khi đó ta có thể đứng ở các máy bên ngoài và truy cập web với địa chỉ <code>http://ip_may_cai_docker:4000</code>, kết quả là ta sẽ thấy nội dung của web. Hoặc ta có thể đứng trên máy cài docker và sử dụng lệnh <code>ss -lan | grep 4000</code>, kết quả ta sẽ thấy port 4000 trên host cài docker.</p><pre><code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># ss -lan | grep 4000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">tcp    LISTEN     0      128      :::4000                 :::*</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment">#</span></span></pre></td></tr></table></figure></code></pre><p>Ngoài cách mở trình duyệt vào địa chỉ, ta có thể sử dụng lệnh <code>curl localhost:4000</code> trên ngay máy cài docker, ta sẽ có kết quả trả về như bên dưới.</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># curl localhost:4000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span></pre></td></tr></table></figure><ul><li><p>Trong trường hợp một container có nhiều port, ta cần sử dụng nhiều port thì có thể sử dùng tùy chọn <code>-p 4000:80 8081:3306</code>.</p></li><li><p>Trong trường hợp ta muốn ánh xạ port ngẫu nhiên cho toàn bộ các port có sẵn trong container, ta sử dụng tùy chọn <code>-P</code>, ví dụ</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -P nginx</span></pre></td></tr></table></figure><ul><li>Sử dụng lệnh <code>docker ps</code> để xem container đang được ánh xạ port nào.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@devstack01:~<span class="comment"># docker ps</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">8be19991391d        nginx               <span class="string">"nginx -g 'daemon of…"</span>   29 seconds ago      Up 27 seconds       0.0.0.0:32769-&gt;80/tcp   suspicious_bhaskara</span></pre></td></tr></table></figure></li></ul><h4 id="Thao-tac-voi-mot-container-da-ton-tai"><a href="#Thao-tac-voi-mot-container-da-ton-tai" class="headerlink" title="Thao tác với một container đã tồn tại"></a>Thao tác với một container đã tồn tại</h4><ul><li><p>Khi một container đang ở trạng thái <code>UP</code> thì ta có thể truy cập vào để thao thác, giả sử như ta có container với ID là <code>8be19991391d</code>, để truy cập vào trong container đó ta dùng lệnh <code>docker exec -it &lt;ID_Container&gt; /bin/bash</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it 8be19991391d /bin/bash</span></pre></td></tr></table></figure><ul><li>Kết quả: lưu ý ta có thể quan sát cửa sổ nhắc lệnh <code>root@8be19991391d</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@8be19991391d:/<span class="comment">#</span></span></pre></td></tr></table></figure>Để thoát khỏi container ta sử dụng lệnh <code>exit</code></li></ul></li></ul><h4 id="Chi-dinh-RAM-va-CPU-cho-mot-container"><a href="#Chi-dinh-RAM-va-CPU-cho-mot-container" class="headerlink" title="Chỉ định RAM và CPU cho một container"></a>Chỉ định RAM và CPU cho một container</h4><ul><li>Một container có thể chỉ định lượng RAM và CPU khi tạo.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker run -d -p 4000:80 --name webserver --memory 400m --cpus 0.5 httpd</span></pre></td></tr></table></figure></li></ul><p>Trong ví dụ trên:</p><ul><li><code>--memory</code>: là giá trị RAM gán cho container.</li><li><code>--cpus</code>: là giá trị CPU gán cho container.</li><li><code>--name</code>: tên của container. </li></ul><h4 id="Lenh-xem-noi-dung-cua-mot-container-xem-log-va-kiem-tra-port"><a href="#Lenh-xem-noi-dung-cua-mot-container-xem-log-va-kiem-tra-port" class="headerlink" title="Lệnh xem nội dung của một container, xem log và kiểm tra port"></a>Lệnh xem nội dung của một container, xem log và kiểm tra port</h4><ul><li><p>Container có thông tin có thể xem được, trong đó chứa rất nhiều tham số có thể khai thác được, để xem nội dung của container ta kiểm tra bằng lệnh <code>docker inspect &lt;ten_hoac_ID_Container&gt;</code>, ví dụ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker inspect 459c2c5f8d32</span></pre></td></tr></table></figure></li><li><p>Để xem log của một container ta sử dụng lệnh <code>docker logs -f &lt;ten_hoac_ID_Container&gt;</code>  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker logs -f 459c2c5f8d32</span></pre></td></tr></table></figure></li><li><p>Kiểm tra port của một container </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker port 459c2c5f8d32</span></pre></td></tr></table></figure></li></ul><h4 id="Cac-lenh-xoa-cac-container"><a href="#Cac-lenh-xoa-cac-container" class="headerlink" title="Các lệnh xóa các container."></a>Các lệnh xóa các container.</h4><ul><li><p>Để xóa các container ta sử dụng lệnh <code>docker rm &lt;ten_hoac_ID_Container&gt;</code> hoặc <code>docker rm -f &lt;ten_hoac_ID_Container&gt;</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rm 459c2c5f8d32</span></pre></td></tr></table></figure><p>hoặc </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rm 459c2c5f8d32</span></pre></td></tr></table></figure></li><li><p>Có thể sử dụng thủ thuật dưới để xóa toàn bộ các container </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">docker rm -f `docker ps -aq`</span></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Virtual Machine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5. Cài đặt và cấu hinh Wazuh agent</title>
      <link href="/2019/12/05/Wazuh5/"/>
      <url>/2019/12/05/Wazuh5/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Cai-dat-Wazuh-agent"><a href="#1-Cai-dat-Wazuh-agent" class="headerlink" title="1. Cài đặt Wazuh agent"></a>1. Cài đặt Wazuh agent</h2><h3 id="1-1-Cai-dat-Wazuh-agent-tren-Debian-Ubuntu"><a href="#1-1-Cai-dat-Wazuh-agent-tren-Debian-Ubuntu" class="headerlink" title="1.1. Cài đặt Wazuh agent trên Debian/Ubuntu"></a>1.1. Cài đặt Wazuh agent trên Debian/Ubuntu</h3><p>Thêm Wazuh repo </p><ul><li><p>Cài đặt các gói bổ trợ :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">apt-get install curl apt-transport-https lsb-release -y</span></pre></td></tr></table></figure></li><li><p>Install Wazuh repo GPG key :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | apt-key add -</span></pre></td></tr></table></figure></li><li><p>Tìm tên của OS và thêm vào repo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"deb https://packages.wazuh.com/3.x/apt/ stable main"</span> | tee /etc/apt/sources.list.d/wazuh.list</span></pre></td></tr></table></figure></li><li><p>Update thông tin package</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">apt-get update -y</span></pre></td></tr></table></figure></li><li><p>Install Wazuh agent</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">apt-get install wazuh-agent -y</span></pre></td></tr></table></figure></li></ul><h3 id="1-2-Cai-dat-Wazuh-agent-tren-Centos-RHEL"><a href="#1-2-Cai-dat-Wazuh-agent-tren-Centos-RHEL" class="headerlink" title="1.2. Cài đặt Wazuh-agent trên Centos/RHEL"></a>1.2. Cài đặt Wazuh-agent trên Centos/RHEL</h3><ul><li><p>Thêm repo với Centos :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/wazuh.repo &lt;&lt;\EOF</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[wazuh_repo]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">name=Wazuh repository</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">baseurl=https://packages.wazuh.com/3.x/yum/</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">protect=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Thêm repo với Centos-5 :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/wazuh.repo &lt;&lt;\EOF</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[wazuh_repo]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">gpgkey=http://packages.wazuh.com/key/GPG-KEY-WAZUH-5</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">name=Wazuh repository</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">baseurl=http://packages.wazuh.com/3.x/yum/5/</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">protect=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt Wazuh agent </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install wazuh-agent -y</span></pre></td></tr></table></figure></li></ul><h3 id="1-3-Voi-agent-la-Windows"><a href="#1-3-Voi-agent-la-Windows" class="headerlink" title="1.3. Với agent là Windows"></a>1.3. Với agent là Windows</h3><ul><li><p>Dowload package từ source : <a href="https://documentation.wazuh.com/current/installation-guide/packages-list/index.html" target="_blank" rel="noopener">https://documentation.wazuh.com/current/installation-guide/packages-list/index.html</a></p></li><li><p><strong>Cách 1</strong>: Sử dụng cmd để cài đặt :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">wazuh-agent-3.6.1-1.msi /q</span></pre></td></tr></table></figure></li><li><p><strong>Cách 2</strong> : Sử dụng GUI : Double-click vào file dowload và cài đặt với mặc định. Một khi cài đặt xong, agent sẽ có giao diện đồ họa để cấu hình, mở log file hoặc start/stop service :</p></li></ul><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-13.png" class="lazyload"></p><p>Mặc định tất cả file agent được đặt tại : <code>C:\Program Files(x86)\ossec-agent</code></p><h2 id="2-Tien-trinh-registration-tai-agent"><a href="#2-Tien-trinh-registration-tai-agent" class="headerlink" title="2. Tiến trình registration tại agent"></a>2. Tiến trình registration tại agent</h2><p>Mỗi khi Wazuh  Agent gửi dữ liệu tới Wazuh Manager thông qua một phương thức an toàn là gọi OSSEC message protocol, phương thức này sẽ mã hóa message bằng pre-shared key. Lúc đầu khi bạn cài đặt thành công Wazuh Agent sẽ không thể kết nối với Wazuh Manager vì thiếu pre-shared key.</p><p>Quá trình <strong>registration</strong> bao gồm việc tạo 1 mối quan hệ tin cậy giữa Manager và Agent. Điều này có thể thực hiện bởi chính Manager hoặc với registration service, service này sẽ lắng nghe trên Manager. Một Agent có thể yêu cầu pre-shared key bằng việc sử dụng 1 số thông tin xác thực và nó sẽ phản hồi pre-shared key và lưu trữ Agent mới trên local database.</p><p>Một cách tiếp cận khác là sử dụng RESTful API.</p><ul><li>Agent keys</li></ul><p>Manager sử dụng file <code>/var/ossec/etc/client.keys</code> để lưu trữ registration record cho mỗi agent, bao gồm <code>ID</code>, <code>name</code>, <code>IP</code> và <code>key</code>. VD :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">001 Server1 any e20e0394dca71bacdea57d4ca25d203f836eca12eeca1ec150c2e5f4309a653a</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">002 ServerProd 192.246.247.247 b0c5548beda537daddb4da698424d0856c3d4e760eaced803d58c07ad1a95f4c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">003 DBServer 192.168.0.1/24 8ec4843da9e61647d1ec3facab542acc26bd0e08ffc010086bb3a6fc22f6f65b</span></pre></td></tr></table></figure><p>Agent cũng có file <code>/var/ossec/etc/client.keys</code> chứa các registration record của riêng nó. VD với <code>Serrver1</code> agent :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">001 Server1 any e20e0394dca71bacdea57d4ca25d203f836eca12eeca1ec150c2e5f4309a653a</span></pre></td></tr></table></figure><ul><li>Basic data cho việc registing 1 agent</li></ul><p>Để register 1 agent, nó cần cung cấp tên và IP của agent :</p><p>Có 1 số cách để đặt agent IP :</p><ul><li><strong>Any IP</strong> : Cho phép agent kết nối từ bất từ IP nào. VD : <code>Server1</code> có <code>any</code> IP</li><li><strong>Fixed IP</strong> : Cho phép kết nối từ 1 IP chỉ định. VD : <code>ServerProd</code> có IP <code>192.246.247.247</code></li><li><strong>Range IP</strong> : Cho phép kết nối từ 1 range IP chỉ định. VD : <code>DBServer</code></li></ul><p>Một số phương thức registration tự động phát hiện IP của agent trong quá trình registration</p><h2 id="3-Register-cho-cac-Agent"><a href="#3-Register-cho-cac-Agent" class="headerlink" title="3. Register cho các Agent"></a>3. Register cho các Agent</h2><p>Trong phần này sẽ hướng dẫn cách register để giám sát các agent :</p><p><strong>Trên Manager server</strong> : </p><ul><li><p>Chạy lệnh <code>manage_agents</code> :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/ossec/bin/manage_agents</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">* Wazuh v3.2.1 Agent manager.            *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">* The following options are available: *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   (A)dd an agent (A).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   (E)xtract key <span class="keyword">for</span> an agent (E).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   (L)ist already added agents (L).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   (R)emove an agent (R).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   (Q)uit.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">Choose your action: A,E,L,R or Q:</span></pre></td></tr></table></figure></li><li><p>Chọn <code>A</code> để thêm 1 agent. Điền <code>hostname</code> và <code>IP</code> cho agent :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Choose your action: A,E,L,R or Q: A</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">- Adding a new agent (use <span class="string">'\q'</span> to <span class="built_in">return</span> to the main menu).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  Please provide the following:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   * A name <span class="keyword">for</span> the new agent: Example</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   * The IP Address of the new agent: 192.168.100.10</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   * An ID <span class="keyword">for</span> the new agent[001]:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">Agent information:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   ID:001</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   Name:Example</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   IP Address:any</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">Confirm adding it?(y/n): y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">Agent added with ID 001.</span></pre></td></tr></table></figure></li><li><p>Chọn <code>E</code> để tạo ra 1 key mới :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Choose your action: A,E,L,R or Q: E</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Available agents:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   ID: 001, Name: Example, IP: any</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">Provide the ID of the agent to extract the key (or <span class="string">'\q'</span> to quit): 001</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">Agent key information <span class="keyword">for</span> <span class="string">'001'</span> is:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">MDAxIDE4NWVlNjE1Y2YzYiBhbnkgMGNmMDFiYTM3NmMxY2JjNjU0NDAwYmFhZDY1ZWU1YjcyMGI2NDY3ODhkNGQzMjM5ZTdlNGVmNzQzMGFjMDA4Nw==</span></pre></td></tr></table></figure></li><li><p>Exit với <code>Q</code></p></li></ul><p><strong>Trên Agent</strong> : </p><ul><li><p>Chạy <code>manage_agents</code> : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/ossec/bin/manage_agents</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">* Wazuh v3.2.1 Agent manager.            *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">* The following options are available: *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   (I)mport key from the server (I).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   (Q)uit.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">Choose your action: I or Q:</span></pre></td></tr></table></figure></li><li><p>Chọn <code>I</code> để import key, paste key đã sinh từ máy manager : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Choose your action: I or Q: I</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">* Provide the Key generated by the server.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">* The best approach is to cut and paste it.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">*** OBS: Do not include spaces or new lines.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">Paste it here (or <span class="string">'\q'</span> to quit): MDAxIDE4NWVlNjE1Y2YzYiBhbnkgMGNmMDFiYTM3NmMxY2JjNjU0NDAwYmFhZDY1ZWU1YjcyMGI2NDY3ODhkNGQzMjM5ZTdlNGVmNzQzMGFjMDA4Nw=</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">Agent information:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   ID:013</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   Name:Example</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   IP Address:any</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">Confirm adding it?(y/n): y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">Added.</span></pre></td></tr></table></figure></li><li><p>Ấn <code>Q</code> để thoát</p></li><li><p>Chỉnh sửa IP của server Manager tại file <code>/var/ossec/etc/ossec.conf</code> : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;client&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">      &lt;server-ip&gt;MANAGE_IP&lt;/server-ip&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&lt;/client&gt;</span></pre></td></tr></table></figure></li><li><p>Restart lại agent :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/ossec/bin/ossec-control restart</span></span></pre></td></tr></table></figure></li></ul><p><strong>Chú ý</strong> : Register đè một agent </p><p>VD : Một agent tên là <code>Server</code> với IP 10.0.0.10 đã được install và có ID là 005. Giả sử agent được reinstall, chúng ta cần phải reinstall agent mới và kết nối lại với Manager. Sử dụng câu lệnh sau trên Manager : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">/var/ossec/bin/manage_agents -n Server1 -a 10.10.10.10 -F 0</span></pre></td></tr></table></figure><h2 id="4-List-cac-agent-duoc-cai-dat-va-remove-agent"><a href="#4-List-cac-agent-duoc-cai-dat-va-remove-agent" class="headerlink" title="4. List các agent được cài đặt và remove agent"></a>4. List các agent được cài đặt và remove agent</h2><ul><li><p>List các agent đã register trên Manager :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/ossec/bin/agent_control -l</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Wazuh agent_control. List of available agents:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   ID: 000, Name: vpc-ossec-manager (server), IP: 127.0.0.1, Active/Local</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   ID: 1040, Name: ip-10-0-0-76, IP: 10.0.0.76, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   ID: 003, Name: vpc-agent-debian, IP: 10.0.0.121, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   ID: 005, Name: vpc-agent-ubuntu-public, IP: 10.0.0.126, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   ID: 006, Name: vpc-agent-windows, IP: 10.0.0.124, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   ID: 1024, Name: ip-10-0-0-252, IP: 10.0.0.252, Never connected</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   ID: 1028, Name: vpc-debian-it, IP: any, Never connected</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   ID: 1030, Name: diamorphine-POC, IP: 10.0.0.59, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   ID: 015, Name: vpc-agent-centos, IP: 10.0.0.123, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   ID: 1031, Name: WIN-UENN0U6R5SF, IP: 10.0.0.124, Never connected</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">   ID: 1032, Name: vpc-agent-ubuntu, IP: 10.0.0.122, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">   ID: 1033, Name: vpc-agent-debian8, IP: 10.0.0.128, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   ID: 1034, Name: vpc-agent-redhat, IP: 10.0.0.127, Active</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">   ID: 1035, Name: vpc-agent-centos7, IP: 10.0.0.101, Never connected</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">   ID: 1041, Name: vpc-agent-centos-public, IP: 10.0.0.125, Active</span></pre></td></tr></table></figure></li><li><p>Remove agent với ID là 001 :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/ossec/bin/manage_agents -r 001</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">* Wazuh v3.2.1 Agent manager.          *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">* The following options are available: *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">****************************************</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   (A)dd an agent (A).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   (E)xtract key <span class="keyword">for</span> an agent (E).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   (L)ist already added agents (L).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   (R)emove an agent (R).</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   (Q)uit.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">Choose your action: A,E,L,R or Q:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">Available agents:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   ID: 001, Name: new, IP: any</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">Provide the ID of the agent to be removed (or <span class="string">'\q'</span> to quit): 001</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">Confirm deleting it?(y/n): y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">Agent <span class="string">'001'</span> removed.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">** You must restart OSSEC <span class="keyword">for</span> your changes to take effect.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">manage_agents: Exiting.</span></pre></td></tr></table></figure></li><li><p>Login vào Wazuh Interface với IP : <a href="http://MANAGER_IP:5601" target="_blank" rel="noopener">http://MANAGER_IP:5601</a> và kiểm tra các agent đã register :<br><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-17.png" class="lazyload"></p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-18.png" class="lazyload"></p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Wazuh </tag>
            
            <tag> SOC </tag>
            
            <tag> SIEM </tag>
            
            <tag> IDS/IPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4. Thực hành cài đặt Wazuh Server</title>
      <link href="/2019/12/05/Wazuh4/"/>
      <url>/2019/12/05/Wazuh4/</url>
      
        <content type="html"><![CDATA[<h2 id="Cai-dat-Wazuh"><a href="#Cai-dat-Wazuh" class="headerlink" title="Cài đặt Wazuh"></a>Cài đặt Wazuh</h2><p><strong>Cấu hình yêu cầu</strong> :</p><p>Với nhu cầu giám sát an ninh và thu thập log tập trung cho hệ thống từ 15-20 server. </p><p>Cấu hình yêu cầu như sau :</p><p> <img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-23.png" class="lazyload"></p><p>Mô hình triển khai : </p><p> <img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-24.png" class="lazyload"></p><h3 id="1-Cai-dat-Wazuh-server"><a href="#1-Cai-dat-Wazuh-server" class="headerlink" title="1. Cài đặt Wazuh server"></a>1. Cài đặt Wazuh server</h3><ul><li><p>Install java 8</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk -y</span></pre></td></tr></table></figure></li><li><p>Thêm repo :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/wazuh.repo &lt;&lt;\EOF</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[wazuh_repo]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">name=Wazuh repository</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">baseurl=https://packages.wazuh.com/3.x/yum/</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">protect=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt Wazuh manager :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install wazuh-manager -y</span></pre></td></tr></table></figure></li><li><p>Kiểm tra status của wazuh-manager :</p><ul><li><p>Với Systemd :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl status wazuh-manager</span></pre></td></tr></table></figure></li><li><p>Với SysV init :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">service wazuh-manager status</span></pre></td></tr></table></figure></li></ul></li></ul><h3 id="2-Cai-dat-Wazuh-API"><a href="#2-Cai-dat-Wazuh-API" class="headerlink" title="2. Cài đặt Wazuh API"></a>2. Cài đặt Wazuh API</h3><p>NodeJS &gt;= 4.6.1 là yêu cầu để chạy Wazuh API. Nếu không có NodeJS đã cài đặt, hoặc version &lt; 4.6.1, nên cài đặt NodeJS theo repo sau : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl --silent --location https://rpm.nodesource.com/setup_6.x | bash -</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">yum install nodejs -y</span></pre></td></tr></table></figure><ul><li><p>Cài đặt Wazuh API. Nó sẽ update NodeJS nếu nó được yêu cầu : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install wazuh-api -y</span></pre></td></tr></table></figure></li><li><p>Kiểm tra status của wazuh-api :</p><ul><li><p>Với Systemd :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl status wazuh-api</span></pre></td></tr></table></figure></li><li><p>Với SysV init :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">service wazuh-api status</span></pre></td></tr></table></figure></li></ul></li></ul><p>Python &gt;= 2.7 được yêu cầu. Nó được cài đặt theo mặc định.</p><p>Có thể set Python path cho API trên <code>/var/ossec/api/configuration/config.js</code>, trong TH nếu version của Python quá cũ : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">config.python = [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    // Default installation</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        bin: <span class="string">"python"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        lib: <span class="string">""</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    // Package <span class="string">'python27'</span> <span class="keyword">for</span> CentOS 6</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        bin: <span class="string">"/opt/rh/python27/root/usr/bin/python"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        lib: <span class="string">"/opt/rh/python27/root/usr/lib64"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">];</span></pre></td></tr></table></figure><p>Centos 6 và Red Hat 6 với Python 2.6, bạn có thể cài đặt Python 2.7 song song cùng với bản cũ :</p><ul><li><p>Với Centos 6 :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install -y centos-release-scl</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">yum install -y python27</span></pre></td></tr></table></figure></li><li><p>Với RHEL 6 :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install -y python27</span></pre></td></tr></table></figure></li><li><p>Mở port 1515 cho phép Wazuh agent kết nối : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=1515/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=1515/tcp --permanent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=55000/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=55000/tcp --permanent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=1514/udp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=1514/udp --permanent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=514/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=514/tcp --permanent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=514/udp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=514/udp --permanent</span></pre></td></tr></table></figure></li></ul><h3 id="3-Cai-dat-Filebeat"><a href="#3-Cai-dat-Filebeat" class="headerlink" title="3. Cài đặt Filebeat"></a>3. Cài đặt Filebeat</h3><p>Filebeat giúp Wazuh server vận chuyển các cảnh báo và archived event một cách an toàn tới Logstash service trên Elastic Stack server.</p><p><strong>Chú ý</strong> : Với mô hình all-in-one, có thể bỏ qua việc cài Filebeat vì Logstash có thể đọc event/alert trực tiếp từ local filesystem.</p><ul><li><p>Cài đặt GPG keys từ Elastic và thêm Elastic repo :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/elastic.repo &lt;&lt; EOF</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">[elasticsearch-6.x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">name=Elasticsearch repository <span class="keyword">for</span> 6.x packages</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">autorefresh=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>=rpm-md</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt Filebeat :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install filebeat-6.4.2 -y</span></pre></td></tr></table></figure></li><li><p>Download Filebeat config file từ Wazuh repo để cấu hình chỏ Wazuh alert tới Logstash :</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -so /etc/filebeat/filebeat.yml https://raw.githubusercontent.com/wazuh/wazuh/3.2/extensions/filebeat/filebeat.yml</span></pre></td></tr></table></figure><ul><li><p>Sửa file <code>/etc/filebeat/filebeat.yml</code> và thay thế <code>ELASTIC_SERVER_IP</code> với IP của máy Elastic stack.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">output:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  logstash:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    hosts: [<span class="string">"ELASTIC_SERVER_IP:5000"</span>]</span></pre></td></tr></table></figure></li><li><p>Enable và start filebeat </p><ul><li><p>Với Systemd</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> filebeat.service</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">systemctl start filebeat.service</span></pre></td></tr></table></figure></li><li><p>Với SysV init</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">chkconfig --add filebeat</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">service filebeat start</span></pre></td></tr></table></figure></li></ul></li></ul><p>Khi đã cấu hình xong manager, API và Filebeat (nếu cần thiết), bạn có thể cài đặt Elastic Stack.</p><h3 id="4-Cai-dat-Elasticsearch"><a href="#4-Cai-dat-Elasticsearch" class="headerlink" title="4. Cài đặt Elasticsearch"></a>4. Cài đặt Elasticsearch</h3><ul><li><p>Chú ý kiểm tra việc cài đặt java 8 ở bước đầu.</p></li><li><p>Thêm repo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">rpm --import http://packages.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr></table></figure></li><li><p>Thêm file repo</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/elasticsearch.repo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[elasticsearch-6.x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">name=Elasticsearch repository <span class="keyword">for</span> 6.x packages</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">autorefresh=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>=rpm-md</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt elastic</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install elasticsearch-6.4.2 -y</span></pre></td></tr></table></figure></li><li><p>Thêm rule firewall</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=9200/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=9200/tcp --permanent</span></pre></td></tr></table></figure></li><li><p>Start và enable service</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">systemctl start elasticsearch</span></pre></td></tr></table></figure></li><li><p>Kiểm tra dịch vụ Elasticsearch</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -X GET http://localhost:9200</span></pre></td></tr></table></figure></li><li><p>Load Wazuh Elasticsearch template : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/wazuh/wazuh/3.2/extensions/elasticsearch/wazuh-elastic6-template-alerts.json | curl -XPUT <span class="string">'http://localhost:9200/_template/wazuh'</span> -H <span class="string">'Content-Type: application/json'</span> -d @-</span></pre></td></tr></table></figure></li></ul><h3 id="5-Cai-dat-Logstash"><a href="#5-Cai-dat-Logstash" class="headerlink" title="5. Cài đặt Logstash"></a>5. Cài đặt Logstash</h3><ul><li><p>Thêm file repo :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /etc/yum.repos.d/logstash.repo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[logstash-6.x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">name=Elastic repository <span class="keyword">for</span> 6.x packages</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">autorefresh=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>=rpm-md</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt Logstash</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install logstash-6.4.2 -y</span></pre></td></tr></table></figure></li><li><p>Dowload Wazuh config và template file cho Logstash :</p></li></ul><p><strong>Mô hình All-in-one</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -so /etc/logstash/conf.d/01-wazuh.conf https://raw.githubusercontent.com/wazuh/wazuh/3.2/extensions/logstash/01-wazuh-local.conf</span></pre></td></tr></table></figure><ul><li>Thêm usermode<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">usermod -a -G ossec logstash</span></pre></td></tr></table></figure></li></ul><p><strong>Mô hình Distribute</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">curl -so /etc/logstash/conf.d/01-wazuh.conf https://raw.githubusercontent.com/wazuh/wazuh/3.2/extensions/logstash/01-wazuh-remote.conf</span></pre></td></tr></table></figure><p>Follow các bước sau nếu bạn sử dụng Centos6/RHEL6 hoặc Amazon AMI (logstash sử dụng Upstart như service manager và cần sửa, xem bug <a href="https://bugs.launchpad.net/upstart/+bug/812870/" target="_blank" rel="noopener">sau</a> )</p><pre><code>- Sửa file `/etc/logstash/startup.options` ở dòng 30 từ `LS_GROUP=logstash` thành `LS_GROUP=ossec`.- Update service với tham số mới bằng câu lệnh `/usr/share/logstash/bin/system-install`- Restart service</code></pre><ul><li><p>Start và enable service</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl start logstash</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> logstash</span></pre></td></tr></table></figure></li><li><p>Cấu hình firewall cho phép Logstash nhận log từ client (port 5044)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=5044/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=5044/tcp --permanent</span></pre></td></tr></table></figure></li></ul><h3 id="6-Cai-dat-Kibana"><a href="#6-Cai-dat-Kibana" class="headerlink" title="6. Cài đặt Kibana"></a>6. Cài đặt Kibana</h3><ul><li><p>Tạo repo cài đặt Kibana :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kibana.repo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[kibana-6.x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">name=Kibana repository <span class="keyword">for</span> 6.x packages</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">gpgcheck=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">enabled=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">autorefresh=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>=rpm-md</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">EOF</span></pre></td></tr></table></figure></li><li><p>Cài đặt Kibana :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">yum install kibana-6.4.2 -y</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">'s/#server.host: "localhost"/server.host: "0.0.0.0"/'</span>g /etc/kibana/kibana.yml</span></pre></td></tr></table></figure></li></ul><ul><li>Install Wazuh App plugin cho Kibana :</li></ul><p>Tăng giá trị mặc định <code>heap memory limit</code> của Node.js để bảo vệ memory khỏi lỗi khi install Wazuh APP. Set giá trị mặc định như sau :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NODE_OPTIONS=<span class="string">"--max-old-space-size=3072"</span></span></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sudo -u kibana /usr/share/kibana/bin/kibana-plugin install https://packages.wazuh.com/wazuhapp/wazuhapp-3.6.1_6.4.2.zip</span></pre></td></tr></table></figure><ul><li><p>Start và enable Kibana</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">systemctl start kibana</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kibana</span></pre></td></tr></table></figure></li><li><p>Cho phép truy cập Kibana web interface (port 5601)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=5601/tcp</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=5601/tcp --permanent</span></pre></td></tr></table></figure></li></ul><ul><li><p>Disable repo Elasticsearch để tránh việc update : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s/^enabled=1/enabled=0/"</span> /etc/yum.repos.d/elasticsearch.repo</span></pre></td></tr></table></figure><ul><li>Chạy Kibana : <a href="http://192.168.0.29:5601" target="_blank" rel="noopener">http://192.168.0.29:5601</a></li></ul></li></ul><h2 id="4-Ket-noi-Wazuh-App-voi-API"><a href="#4-Ket-noi-Wazuh-App-voi-API" class="headerlink" title="4. Kết nối Wazuh App với API"></a>4. Kết nối Wazuh App với API</h2><p>Chúng ta sẽ register Wazuh API (đã được install trên Wazuh server) tới Wazuh App trên Kibana :</p><ul><li>Mở Web browser và tới Elastic Stack server IP trên port 5601. Tới Wazuh App</li></ul><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-10.png" class="lazyload"></p><ul><li>Click vào <code>Add new API</code></li></ul><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-11.png" class="lazyload"></p><ul><li><p>Trước khi thêm các field, tới Wazuh server và sử dụng cmd với quyền root set thông tin bảo mật cho Wazuh API :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/ossec/api/configuration/auth</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">sudo node htpasswd -c user myUserName</span></pre></td></tr></table></figure></li><li><p>Restart service</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">systemctl restart wazuh-api</span></pre></td></tr></table></figure></li></ul><p>Các thông tin cần nhập như sau : </p><ul><li>user/password : Thông tin tạo bước trước.</li><li>URL : <a href="http://MANAGER_IP" target="_blank" rel="noopener">http://MANAGER_IP</a> . Với <code>MANAGER_IP</code> là IP của Wazuh server</li><li>Port : 55000</li></ul><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-12.png" class="lazyload"></p><p>Nếu bạn sử dụng Wazuh Documentation cho Nginx, URL phải là <code>https://localhost</code></p><ul><li>Click và <code>Save</code></li></ul><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-13.png" class="lazyload"></p><p>Sau khi cài đặt xong Wazuh server, cấu hình agent và kết nối.</p>]]></content>
      
      
      
        <tags>
            
            <tag> Wazuh </tag>
            
            <tag> SOC </tag>
            
            <tag> SIEM </tag>
            
            <tag> IDS/IPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3. Các usecase sử dụng của Wazuh</title>
      <link href="/2019/12/04/Wazuh3/"/>
      <url>/2019/12/04/Wazuh3/</url>
      
        <content type="html"><![CDATA[<h2 id="Cac-usecase-su-dung-cua-Wazuh"><a href="#Cac-usecase-su-dung-cua-Wazuh" class="headerlink" title="Các usecase sử dụng của Wazuh"></a>Các usecase sử dụng của Wazuh</h2><p>Wazuh thông thường được dùng để đáp ứng các yêu cầu tuân thủ an ninh (như PCI DSS hoặc HIPAA) và các tiêu chuẩn cấu hình (CIS hardening guide). Nó cũng phổ biến với các IaaS user (vd Amazon, Azure hoặc Google cloud), khi triển khai 1 host-based IDS trên 1 instance đang chạy có thể được tổ hợp với phân tích của các infrastructure event (được pull trực tiếp từ cloud provider API).</p><p>Sau đây là 1 số use case phổ biến :</p><ul><li>signature-based log analysis</li><li>file integrity monitoring</li><li>rootkits detection</li><li>security policy monitoring</li></ul><h2 id="2-Signature-based-log-analysis"><a href="#2-Signature-based-log-analysis" class="headerlink" title="2. Signature-based log analysis"></a>2. Signature-based log analysis</h2><p>Việc quản lý và phân tích log được tự đông hóa để giúp việc phát hiện các mối đe dọa nhanh hơn. Có rất nhiều case nơi các bằng chứng về việc tấn công có thể được tìm thấy trên các log của thiết bị, hệ thống và ứng dụng. Wazuh có thể dùng để tự động tổng hợp và phân tích dữ liệu log.</p><p>Wazuh agent (chạy trên host được giám sát) thông thường phụ trách việc đọc log message của OS và ứng dụng, sau đó chuyển tới Wazuh server, nơi việc phân tích diễn ra. Khi không có agent nào được triển khai, server có thể nhận dữ liệu thông qua syslog, từ các network device hoặc ứng dụng.</p><p>Wazuh dùng để giải mã để nhận dạng source app của các log message và sau đó phân tích chúng bằng các rule. Sau đây là 1 ví dụ về rule phát hiện đăng nhập SSH thật bại :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;rule id=<span class="string">"5716"</span> level=<span class="string">"5"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  &lt;if_sid&gt;5700&lt;/if_sid&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  &lt;match&gt;^Failed|^error: PAM: Authentication&lt;/match&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  &lt;description&gt;SSHD authentication failed.&lt;/description&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  &lt;group&gt;authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,&lt;/group&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&lt;/rule&gt;</span></pre></td></tr></table></figure><p>Rule bao gồm <code>match</code> field, được dùng để chỉ định pattern mà rule sẽ tìm kiếm. Nó cũng có <code>level</code> field để chỉ rõ mức độ ưu tiên của cảnh báo.</p><p>Manager sẽ tạo 1 cảnh báo mỗi lần event được thu thập được bởi agent  (hoặc qua syslog) ánh xạ với rule (với level cao hơn 0)</p><p>Một số ví dụ trong <code>/var/ossec/logs/alerts/alerts.json</code> :<br>``sh<br>{<br>  “agent”: {<br>      “id”: “1041”,<br>      “ip”: “10.0.0.125”,<br>      “name”: “vpc-agent-centos-public”<br>  },<br>  “decoder”: {<br>      “name”: “sshd”,<br>      “parent”: “sshd”<br>  },<br>  “dstuser”: “root”,<br>  “full_log”: “Mar  5 18:26:34 vpc-agent-centos-public sshd[9549]: Failed password for root from 58.218.199.116 port 13982 ssh2”,<br>  “location”: “/var/log/secure”,<br>  “manager”: {<br>      “name”: “vpc-ossec-manager”<br>  },<br>  “program_name”: “sshd”,<br>  “rule”: {<br>      “description”: “Multiple authentication failures.”,<br>      “firedtimes”: 349,<br>      “frequency”: 10,<br>      “groups”: [<br>          “syslog”,<br>          “attacks”,<br>          “authentication_failures”<br>      ],<br>      “id”: “40111”,<br>      “level”: 10,<br>      “pci_dss”: [<br>          “10.2.4”,<br>          “10.2.5”<br>      ]<br>  },<br>  “srcip”: “58.218.199.116”,<br>  “srcport”: “13982”,<br>  “timestamp”: “2017-03-05T10:26:59-0800”<br>}</p><p>Một khi cảnh báo được tạo bởi manager, các alert được gửi tới Elastic Stack để bổ sung thông tin như Goelocation, được lưu trữ và đánh index. Kibana sau đó được dùng để search, phân tích và hiển thị dữ liệu. Một alert được hiển thị như sau :</p><p><img alt="wazuh" data-src="https://raw.githubusercontent.com/hocchudong/ghichep-SOC/master/images/wazuh-06.png" class="lazyload"></p><p>Wazuh cung cấp ruleset mặc định, update theo định kỳ, với hơn 1600 rule cho các ứng dụng khác nhau.</p><h2 id="3-File-integrity-monitoring"><a href="#3-File-integrity-monitoring" class="headerlink" title="3. File integrity monitoring"></a>3. File integrity monitoring</h2><p>File integrity monitoring (FIM) - Giám sát sự toàn vẹn của file, phát hiện và cảnh báo khi các file của hệ thống và ứng dụng được sửa đổi. Khả năng này thường được dùng để phát hiện việc truy cập hoặc thay đổi các dữ liệu nhạy cảm. Thực tế, nếu server của bạn trong phạm vi với PCI DSS, yêu cầu 11.5 state, bạn sẽ phải cài đặt 1 FIM solution mới có thể pass qua sự kiểm tra.</p><p>VD sau là 1 cảnh báo, được tạo khi 1 file được giám sát bị thay đổi. Metadata bao gồm MD5 và SHA1 checksum, file size (trước và sau khi thay đổi), file permisssion, file owner và nội dung thay đổi :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"agent"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"003"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"ip"</span>: <span class="string">"10.0.0.121"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"vpc-agent-debian"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"decoder"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"syscheck_integrity_changed"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"full_log"</span>: <span class="string">"Integrity checksum changed for: '/root/hola.txt'\nSize changed from '3089' to '3213'\nOld md5sum was: '20db2c4c9bdd937975371bc5ca25af92'\nNew md5sum is : '3841e727a28f733e6d34413afd49d607'\nOld sha1sum was: 'a6c57142a6e6e7e55c58b3174ee52b4f8ec996e3'\nNew sha1sum is : '99aa4b60467a932c89f32603e410a6c194fb1ac3'\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"location"</span>: <span class="string">"syscheck"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"manager"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"vpc-ossec-manager"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"rule"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"description"</span>: <span class="string">"Integrity checksum changed."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"firedtimes"</span>: 8,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"groups"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"ossec"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"syscheck"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      ],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"550"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"level"</span>: 7,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"pci_dss"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"11.5"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">      ]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"syscheck"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"diff"</span>: <span class="string">"0a1,2\n&gt; Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua\n&gt; \n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"event"</span>: <span class="string">"modified"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"gid_after"</span>: <span class="string">"0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"gname_after"</span>: <span class="string">"root"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"inode_after"</span>: 398585,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"md5_after"</span>: <span class="string">"3841e727a28f733e6d34413afd49d607"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"md5_before"</span>: <span class="string">"20db2c4c9bdd937975371bc5ca25af92"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"mtime_after"</span>: <span class="string">"2017-03-05T13:47:32"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"mtime_before"</span>: <span class="string">"2017-03-05T13:44:15"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"path"</span>: <span class="string">"/root/hola.txt"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"perm_after"</span>: <span class="string">"100666"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"sha1_after"</span>: <span class="string">"99aa4b60467a932c89f32603e410a6c194fb1ac3"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"sha1_before"</span>: <span class="string">"a6c57142a6e6e7e55c58b3174ee52b4f8ec996e3"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"size_after"</span>: <span class="string">"3213"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"size_before"</span>: <span class="string">"3089"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"uid_after"</span>: <span class="string">"1000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"uname_after"</span>: <span class="string">"admin"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"timestamp"</span>: <span class="string">"2017-03-05T13:44:18-0800"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>Một ví dụ tổng hợp về sự thay đổi file : </p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-07.png" class="lazyload"></p><h2 id="3-Rootkits-detection"><a href="#3-Rootkits-detection" class="headerlink" title="3. Rootkits detection"></a>3. Rootkits detection</h2><p>Wazuh agent định kỳ quét các hệ thống được giám sát để phát hiện rootkits trên cả kernel và user level. Các dạng của malware này thông thường thay thế hoặc thay đổi các thành phần OS đã có sẵn để thay đổi hành vi của hệ thống, nó có thể giấu các process khác, file hoặc kết nối mạng như chính nó.</p><p>Wazu sử dụng các phương thức khác nhau để tìm kiếm các thay đổi bất thường của hệ thống hoặc các xâm nhập phổ biến. Việc này được thực hiện định kỳ bởi thành phần <code>Rootcheck</code> </p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-08.png" class="lazyload"></p><p>Dưới đây là ví dụ 1 cảnh báo được tạo khi tìm thấy 1 process ẩn. Ở TH này, hệ thống bị ảnh hưởng chạy trên Linux kernel-level rootkit (name là Diamorphine) :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"agent"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"1030"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"ip"</span>: <span class="string">"10.0.0.59"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"diamorphine-POC"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"decoder"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"rootcheck"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"full_log"</span>: <span class="string">"Process '562' hidden from /proc. Possible kernel level rootkit."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"location"</span>: <span class="string">"rootcheck"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"manager"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"vpc-ossec-manager"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"rule"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"description"</span>: <span class="string">"Host-based anomaly detection event (rootcheck)."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"firedtimes"</span>: 4,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"groups"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"ossec"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"rootcheck"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      ],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"510"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"level"</span>: 7</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"timestamp"</span>: <span class="string">"2017-03-05T15:13:04-0800"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"title"</span>: <span class="string">"Process '562' hidden from /proc."</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><h3 id="4-Security-policy-monitoring"><a href="#4-Security-policy-monitoring" class="headerlink" title="4. Security policy monitoring"></a>4. Security policy monitoring</h3><p>SCAP là giải pháp kiểm tra các tuân thủ an ninh tiêu chuẩn cho hạ tầng với enterprise-level. Nó là 1 dòng thông số kỹ thuật với NIST với mục tiêu là duy trì các tiêu chuẩn an nình của hệ thống enterprise.</p><p>OpenSCAP là 1 tool kiểm tra dùng Extensible Configuration Checklist Description Format (XCCDF). XCCDF là một phương thức tiêu chuẩn kiểm tra nhanh chóng nội dung checklist và định rõ các security checklist. Nó là tổ hợp với các đặc điểm kỹ thuật khác như CPE, CVE, CCE và OVAL, để tạo SCAP-express checklist được thực hiện bởi SCAP validate product.</p><p>Wazuh agent sử dụng OpenSCAP bên trong để kiểm định rằng hệ thống đã tuân thủ theo chuẩn CIS hardening hay chưa. Dưới đây là ví dụ của SCAP rule được dùng để kiểm tra nếu SSH daemon được cấu hình để cho phép password trống :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;ns10:Rule id=<span class="string">"xccdf_org.ssgproject.content_rule_sshd_disable_empty_passwords"</span> selected=<span class="string">"false"</span> severity=<span class="string">"high"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:title xml:lang=<span class="string">"en-US"</span>&gt;Disable SSH Access via Empty Passwords&lt;/ns10:title&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:description xml:lang=<span class="string">"en-US"</span>&gt;To explicitly disallow remote login from accounts with empty passwords, add or correct the following line <span class="keyword">in</span> &lt;html:code&gt;/etc/ssh/sshd_config&lt;/html:code&gt;: &lt;html:pre&gt;PermitEmptyPasswords no&lt;/html:pre&gt; Any accounts with empty passwords should be disabled immediately, and PAM configuration should prevent users from being able to assign themselves empty passwords.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  &lt;/ns10:description&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:reference href=<span class="string">"http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf"</span>&gt;AC-3&lt;/ns10:reference&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:reference href=<span class="string">"http://iase.disa.mil/stigs/cci/Pages/index.aspx"</span>&gt;765&lt;/ns10:reference&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:reference href=<span class="string">"http://iase.disa.mil/stigs/cci/Pages/index.aspx"</span>&gt;766&lt;/ns10:reference&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:rationale xml:lang=<span class="string">"en-US"</span>&gt;Configuring this setting <span class="keyword">for</span> the SSH daemon provides additional assurance that remote login via SSH will require a password, even <span class="keyword">in</span> the event of misconfiguration elsewhere.&lt;/ns10:rationale&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:fix complexity=<span class="string">"low"</span> disruption=<span class="string">"low"</span> id=<span class="string">"sshd_disable_empty_passwords"</span> reboot=<span class="string">"false"</span> strategy=<span class="string">"enable"</span> system=<span class="string">"urn:xccdf:fix:script:sh"</span>&gt;grep -q ^PermitEmptyPasswords /etc/ssh/sshd_config &amp;amp;&amp;amp; \ sed -i <span class="string">"s/PermitEmptyPasswords.*/PermitEmptyPasswords no/g"</span> /etc/ssh/sshd_config; <span class="keyword">if</span> ! [ $? -eq 0 ]; <span class="keyword">then</span>; <span class="built_in">echo</span> <span class="string">"PermitEmptyPasswords no"</span> &amp;gt;&amp;gt; /etc/ssh/sshd_config; <span class="keyword">fi</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  &lt;/ns10:fix&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:check system=<span class="string">"http://oval.mitre.org/XMLSchema/oval-definitions-5"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &lt;ns10:check-content-ref href=<span class="string">"ssg-rhel6-oval.xml"</span> name=<span class="string">"oval:ssg-sshd_disable_empty_passwords:def:1"</span> /&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  &lt;/ns10:check&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  &lt;ns10:check system=<span class="string">"http://scap.nist.gov/schema/ocil/2"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &lt;ns10:check-content-ref href=<span class="string">"ssg-rhel6-ocil.xml"</span> name=<span class="string">"ocil:ssg-sshd_disable_empty_passwords_ocil:questionnaire:1"</span> /&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  &lt;/ns10:check&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&lt;/ns10:Rule&gt;</span></pre></td></tr></table></figure><p>SCAP check chạy định kỳ (mặc định là một lần mỗi ngày), và kết quả được chỏ tới Wazuh server nơi mà chúng được xử lý thông qua OpenSCAP decoder và rule. Dưới đây là các ví dụ về một cảnh báo, được tạo khi Linux audit policy (auditd) không được cấu hình để giám sát các user action : </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"agent"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"1040"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"ip"</span>: <span class="string">"10.0.0.76"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"ip-10-0-0-76"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"decoder"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"oscap"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"parent"</span>: <span class="string">"oscap"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"full_log"</span>: <span class="string">"oscap: msg: \"xccdf-result\", scan-id: \"10401488754797\", content: \"ssg-centos-7-ds.xml\", title: \"Ensure auditd Collects System Administrator Actions\", id: \"xccdf_org.ssgproject.content_rule_audit_rules_sysadmin_actions\", result: \"fail\", severity: \"low\", description: \"At a minimum the audit system should collect administrator actions for all users and root. If the auditd daemon is configured to use the augenrules program to read audit rules during daemon startup (the default), add the following line to a file with suffix .rules in the directory /etc/audit/rules.d: -w /etc/sudoers -p wa -k actions If the auditd daemon is configured to use the auditctl utility to read audit rules during daemon startup, add the following line to /etc/audit/audit.rules file: -w /etc/sudoers -p wa -k actions\", rationale: \"The actions taken by system administrators should be audited to keep a record of what was executed on the system, as well as, for accountability purposes.\" references: \"AC-2(7)(b) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AC-17(7) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-1(b) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(a) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(c) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(d) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-12(a) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-12(c) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), IR-5 (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), 126 (http://iase.disa.mil/stigs/cci/Pages/index.aspx), Test attestation on 20121024 by DS (https://github.com/OpenSCAP/scap-security-guide/wiki/Contributors)\", identifiers: \"CCE-RHEL7-CCE-TBD (http://cce.mitre.org)\", oval-id: \"oval:ssg:def:370\", benchmark-id: \"xccdf_org.ssgproject.content_benchmark_RHEL-7\", profile-id: \"xccdf_org.ssgproject.content_profile_common\", profile-title: \"Common Profile for General-Purpose Systems\"."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"location"</span>: <span class="string">"wodle_open-scap"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"manager"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"name"</span>: <span class="string">"vpc-ossec-manager"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"oscap"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"check"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"description"</span>: <span class="string">"At a minimum the audit system should collect administrator actions for all users and root. If the auditd daemon is configured to use the augenrules program to read audit rules during daemon startup (the default), add the following line to a file with suffix .rules in the directory /etc/audit/rules.d: -w /etc/sudoers -p wa -k actions If the auditd daemon is configured to use the auditctl utility to read audit rules during daemon startup, add the following line to /etc/audit/audit.rules file: -w /etc/sudoers -p wa -k actions"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"id"</span>: <span class="string">"xccdf_org.ssgproject.content_rule_audit_rules_sysadmin_actions"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"identifiers"</span>: <span class="string">"CCE-RHEL7-CCE-TBD (http://cce.mitre.org)"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"oval"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">              <span class="string">"id"</span>: <span class="string">"oval:ssg:def:370"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">          &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"rationale"</span>: <span class="string">"The actions taken by system administrators should be audited to keep a record of what was executed on the system, as well as, for accountability purposes."</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"references"</span>: <span class="string">"AC-2(7)(b) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AC-17(7) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-1(b) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(a) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(c) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-2(d) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-12(a) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), AU-12(c) (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), IR-5 (http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-53r4.pdf), 126 (http://iase.disa.mil/stigs/cci/Pages/index.aspx), Test attestation on 20121024 by DS (https://github.com/OpenSCAP/scap-security-guide/wiki/Contributors)"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"result"</span>: <span class="string">"fail"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"severity"</span>: <span class="string">"low"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"title"</span>: <span class="string">"Ensure auditd Collects System Administrator Actions"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"scan"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"benchmark"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">              <span class="string">"id"</span>: <span class="string">"xccdf_org.ssgproject.content_benchmark_RHEL-7"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">          &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"content"</span>: <span class="string">"ssg-centos-7-ds.xml"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"id"</span>: <span class="string">"10401488754797"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"profile"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">              <span class="string">"id"</span>: <span class="string">"xccdf_org.ssgproject.content_profile_common"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">              <span class="string">"title"</span>: <span class="string">"Common Profile for General-Purpose Systems"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">          &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"rule"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"description"</span>: <span class="string">"OpenSCAP: Ensure auditd Collects System Administrator Actions (not passed)"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"firedtimes"</span>: 3,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"groups"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"oscap"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"oscap-result"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">      ],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="string">"81529"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"level"</span>: 5,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"pci_dss"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">          <span class="string">"2.2"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">      ]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"timestamp"</span>: <span class="string">"2017-03-05T15:00:03-0800"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure><p>Thêm vào, Wazuh WUI có thể dùng để hiển hiện và phân tích policy dựa vào kết quả quét. Ví dụ sau hiển thị dữ liệu của hệ thống Centos khi quét sử dụng <code>Server baseline</code> và <code>PCI DSS v3</code> pre-defined profiles : </p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-09.png" class="lazyload"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Wazuh </tag>
            
            <tag> SOC </tag>
            
            <tag> SIEM </tag>
            
            <tag> IDS/IPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2. Kiến trúc và cơ chế hoạt động của Wazuh</title>
      <link href="/2019/12/04/Wazuh2/"/>
      <url>/2019/12/04/Wazuh2/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Kien-truc-cua-Wazuh"><a href="#1-Kien-truc-cua-Wazuh" class="headerlink" title="1. Kiến trúc của Wazuh"></a>1. Kiến trúc của Wazuh</h2><p>Mô hình kiến trúc của Wazuh được chia thành 2 dạng : </p><ul><li>Multi-node deployment</li><li>Single node deployment</li></ul><h3 id="Multi-node-deployment"><a href="#Multi-node-deployment" class="headerlink" title="Multi-node deployment"></a>Multi-node deployment</h3><p>Khi Wazuh server và Elasticsearch cluster chạy trên các host khác nhau, Filebeat được dùng để truyền một cách an toàn các cảnh báo, archived event tới Elasticsarch server sử dụng TLS.<br>Chú ý rằng multi-node cluster sẽ là multiple Elastic stack sererver.</p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-03.png" class="lazyload"></p><h3 id="Single-node-deployment"><a href="#Single-node-deployment" class="headerlink" title="Single-node deployment"></a>Single-node deployment</h3><p>Wazuh và Elastic stack chạy với 1 single-node Elasticsearch cluster (số lượng agent &lt; 50), có thể triển khai trên một single server. Ở triển khai này, Logstash sẽ đọc các cảnh báo, event từ Wazuh trực tiếp từ local file system và đẩy chúng tới local Elasticsearch instance.</p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-04.png" class="lazyload"></p><h2 id="2-Phuong-thuc-lien-lac-va-luong-du-lieu"><a href="#2-Phuong-thuc-lien-lac-va-luong-du-lieu" class="headerlink" title="2. Phương thức liên lạc và luồng dữ liệu"></a>2. Phương thức liên lạc và luồng dữ liệu</h2><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-05.png" class="lazyload"></p><h3 id="2-1-Agent-server-communication"><a href="#2-1-Agent-server-communication" class="headerlink" title="2.1. Agent-server communication"></a>2.1. Agent-server communication</h3><p>Wazuh agent sử dụng OESSEC message protocol để gửi các event thu thập được tới Wazhu server thông qua port 1514 (UDP hoặc TCP). Wazuh server giải mã và thực hiện rule-check với các event nhận được với công cụ phân tích. Các event ứng với các rule được bổ sung dữ liệu cảnh báo như rule-id và rule-name. Các event có thể được đẩy tới 1 hoặc cả 2 file sau, dựa vào việc có được event có tương ứng với rule hay không :</p><ul><li>File <code>/var/ossec/logs/archives/archives.json</code> chứa tất cả các event dù có tương ứng với rule hay không.</li><li>File <code>/var/ossec/logs/alerts/alerts.json</code> chỉ chứa các event tương ứng với rule đã đặt ra.</li></ul><p>OSSEC message protocol dùng 1 mã hóa 192-bit Blowfish với full 16-round implemetation.</p><h3 id="2-2-Wazuh-elastic-communication"><a href="#2-2-Wazuh-elastic-communication" class="headerlink" title="2.2. Wazuh-elastic communication"></a>2.2. Wazuh-elastic communication</h3><p>Trên mô hình triển khai diện rộng, Wazuh server sử dụng Filebeat để chuyển dữ liệu về cảnh báo và event tới Logstash (5000/TCP) trên Elastic Stack server, sử dụng TLS. Với kiến trúc single-host, Logstash đọc trực tiếp từ local file system mà không cần dùng Filebeat.</p><p>Logstash định hình incoming data, và có thể là GeoIP, trước gửi tới Elasticsearch (port 9200/TCP). Một khi dữ liệu được index tới Elasticsearch, Kibana (port 5601/TCP) được dùng để khai thác và hiển thị thông tin.</p><p>Wazuh App chạy bên trong Kibana liên tục truy vấn tới RESTful API (port 55000/TCP trên Wazuh manager) để hiển thị cấu hình và thông tin trạng thái liên quan của server và agent, cũng như restart agent theo yêu cầu. Liên lạc này được mã hóa với TLS và được xác thực với username và password.</p><h2 id="3-Luu-tru-du-lieu"><a href="#3-Luu-tru-du-lieu" class="headerlink" title="3. Lưu trữ dữ liệu"></a>3. Lưu trữ dữ liệu</h2><p>Các event về alert và non-alert được lưu trữ cùng nhau trong file trên Wazuh server và sau để gửi tới Elasticsearch. Các file này được viết với dạng JSON hoặc với plain text format. Các file này được nén hàng ngày và được đánh dấu với MD5 và SHA1 checksums. Cấu trúc thư mục và tên file như sau :</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">root@wazuh-server:/var/ossec/logs/archives/2017/Jan<span class="comment"># ls -l</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">total 176</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 234350 Jan  2 00:00 ossec-archive-01.json.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    350 Jan  2 00:00 ossec-archive-01.json.sum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 176221 Jan  2 00:00 ossec-archive-01.log.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    346 Jan  2 00:00 ossec-archive-01.log.sum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 224320 Jan  2 00:00 ossec-archive-02.json.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    350 Jan  2 00:00 ossec-archive-02.json.sum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 151642 Jan  2 00:00 ossec-archive-02.log.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    346 Jan  2 00:00 ossec-archive-02.log.sum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 315251 Jan  2 00:00 ossec-archive-03.json.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    350 Jan  2 00:00 ossec-archive-03.json.sum</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec 156296 Jan  2 00:00 ossec-archive-03.log.gz</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">-rw-r----- 1 ossec ossec    346 Jan  2 00:00 ossec-archive-03.log.sum</span></pre></td></tr></table></figure><p>Việc Rotation và backup các file nén được khuyến khích, tùy theo khả năng lưu trữ của Wazuh Manger server. Sử dụng <code>cron</code> job để rà soát các file nén.</p><p>Ngoài ra, bạn có thể lựa chọn việc bỏ qua việc lưu trữ các file nén, và sử dụng Elasticsearch cho các tài liệu lưu trữ, đặc biệt nếu bạn chạy Elasticsearch snapshot backup hoặc multi-node Elasticsearch cluster cho shard replica. Bạn có thể sử dụng <code>cron</code> job để di chuyển các index đã được snapshot tới một server lưu trữ và đánh dấu chúng với MD5 và SHA1.</p>]]></content>
      
      
      
        <tags>
            
            <tag> Wazuh </tag>
            
            <tag> SOC </tag>
            
            <tag> SIEM </tag>
            
            <tag> IDS/IPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1. Tổng quan giới thiệu về Wazuh</title>
      <link href="/2019/12/04/Wazuh/"/>
      <url>/2019/12/04/Wazuh/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Gioi-thieu-ve-Wazuh"><a href="#1-Gioi-thieu-ve-Wazuh" class="headerlink" title="1. Giới thiệu về Wazuh"></a>1. Giới thiệu về Wazuh</h2><p>Wazuh là 1 project mã nguồn dùng cho việc bảo vệ an ninh. Được xây dựng từ các thành phần : OSSEC HIDS, OpenSCAP và Elastic Stack.</p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-00.png" class="lazyload"></p><ul><li><p>OSSEC HIDS : host-based Intrusion Detection System (HIDS) được dùng cho việc phát hiện xâm nhập, hiển thị và giám stas. Nó dựa vào 1 multi-platform agent cho việc đẩy dữ liệu hệ thống (log message, file hash và phát hiện bất thường) tới 1 máy quản lý trung tâm, nơi sẽ phân tích và xử lý, dựa trên các cảnh báo an ninh. Các agent truyền event data event data tới máy quản lý trung tâm thông qua kênh được bảo mật và xác thực.<br>OSSEC HIDS cung cấp syslog server trung tâm và hệ thống giám sát không cần agent, cung cấp việc giám sát tới các event và thay đổi trên các thiết bị không cài được agent như firewall, switch, router, access point, thiết bị mạng….</p></li><li><p>OpenSCAP<br>OpenSCAP là 1 OVAL (Open Vulnerability Assesment Language) và XCCDF (Extensible Configuration Checklist Description Format) được dùng để kiểm tra cấu hình hệ thống và phát hiện các ứng dụng dễ bị tấn công.<br>Nó được biết đến như là một công cụ được thiết kế để kiểm tra việc tuân thủ an ninh của hệ thống sử dụng các tiêu chuẩn an ninh dùng cho môi trường doanh nghiệp</p></li><li><p>ELK Stack<br>Sử dụng cho việc thu thập, phân tihcs, index, store, search và hiển thị dữ liệu log. </p></li></ul><h2 id="2-Cac-thanh-phan"><a href="#2-Cac-thanh-phan" class="headerlink" title="2. Các thành phần"></a>2. Các thành phần</h2><h3 id="2-1-Wazuh-agent"><a href="#2-1-Wazuh-agent" class="headerlink" title="2.1. Wazuh agent"></a>2.1. Wazuh agent</h3><p>Chạy trên : Windows, Linux, Solaris, BSD hoặc MAC OS. Dùng thu thập các dạng khác nhau của dữ liệu hệ thống và ứng dụng. Dữ liệu được chuyển tới Wazuh server thông qua 1 kênh được mã hóa và xác thực. Để thiết lập kênh này, 1 quá trình đăng ký bao gồm pre-shared key duy nhất được thiết lập.</p><p>Các agent có thể dùng để giám sát server vật lý, máy ảo, cloud instance (AWS, Azure hoặc Google cloud). Các các cài đặt pre-compile agent có sẵn cho các OS : Linux, AIX, Solaris, Windows và Darwin (Mac OS X).</p><p>Trên các OS Unix-based, agent chạy trên multiple process, các process này liên lạc với nhau thông qua local Unix domain socket. 1 trong các process này phụ trách việc liên lạc và gửi dữ liệu tới Wazuh server. Trên Windows, chỉ có 1 agent process chạy trên multiple task sử dụng mutexes.</p><p>Các agent task hoặc process khác nhau được dùng để giám sát hệ thống theo các cách khác nhau (giám sát sự thay đổi về file, đọc log, quét các thay đổi hệ thống).</p><p>Sơ đồ sau thể hiện các internal task và process diễn ra trên các agent level.</p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-01.png" class="lazyload"></p><p>Tất cả các process agent có mục tiêu và thiết lập khác nhau. </p><ul><li><strong>Rootcheck</strong> : Thực hiện các task liên quan đến phát hiện về <code>Rootkits</code>, <code>malware</code> và các bất thường của hệ thống. Nó chạy 1 số công cụ kiểm tra an ninh cơ bản dựa vào các file cấu hình hệ thống.</li><li><strong>Log Collector</strong>: Dùng để đọc và thu thập các log message, bao gồm các các file flat log như Windows event log và thậm chí là Windows Event Channel. Nó cũng được cấu hình để chạy định kỳ và bắt 1 số output của các câu lệnh cụ thể.</li><li><strong>Syscheck</strong> : Process này thực hiện file integrity monitoring (FIM) (Giám sát tính toàn vẹn của file). Nó cũng có thể giám sát registry key trên Windows. Nó sẽ bắt các thay đổi về nội dung file, quyền và các thuộc tính khác, cũng như phát hiện việc tạo và xóa file.</li><li><strong>OpenSCAP</strong> : Được dùng để publish OVAL và XCCDF dựa vào các hồ sơ bảo mật cơ bản, định kỳ quét hệ thống, nó sẽ phát hiện được các ứng dụng và cấu hình sẽ bị tấn công, không tuân theo các chuẩn được xác định theo CIS (Center of Internet Security)</li><li><strong>Agent Daemon</strong> : Process nhận dữ liệu được tạo hoặc được thu thập bởi tất cả các thành phần agent khác. Nó nén, mã hóa và phân phối dữ liệu tới server thông qua kênh được xác thực. Process này chạy trên “chroot” enviroment được cô lập, có nghĩa rằng nó sẽ hạn chế truy cập tới các hệ thống được giám sát. Điều này cải thiện được an toàn cho agent vì process đó là process duy nhất kết nối tới mạng.</li></ul><p>Chú giải : </p><ul><li>Rootkits : Phần mềm hoặc công cụ phần mềm che giấu sự tồn tại của 1 phần mềm khác, thường là virus xâm nhập vào hệ thống.</li><li>Malware : Mọi loại mã gây hại trên máy tính người dùng : spyware, trojan, virus…</li></ul><h3 id="2-2-Wazuh-server"><a href="#2-2-Wazuh-server" class="headerlink" title="2.2. Wazuh server"></a>2.2. Wazuh server</h3><p>Thành phần server phụ trách việc phân tích dữ liệu nhận từ agent, tạo các ngưỡng cảnh báo khi 1 event ánh xạ với rule (phát hiện xâm nhập, thay đổi file, cấu hình không tương thích với policy, rootfit…)</p><p><img alt="wazuh" data-src="https://github.com/hocchudong/ghichep-SOC/raw/master/images/wazuh-02.png" class="lazyload"></p><p>Server thông thường chạy các thành phần agent với mục tiêu giám sát chính nó. Một số thành phần server chính là : </p><ul><li><strong>Registration service</strong> : Được dùng để register agent mới được việc cung cấp và phân phối các key xác thực pre-shared, các key này là độc nhất với mỗi agent. Process này chạy như 1 network service và hỗ trợ việc xác thực qua TLS/SSL với 1 fixed password.</li><li><strong>Remote daemon service</strong> : Service này nhận dữ liệu từ agent. Nó sử dụng pre-shared key để xác thực định danh của mỗi agent và mã hóa giao tiếp với chúng.</li><li><strong>Analysis daemon</strong> : Process này thực hiện việc phân tích dữ liệu. Nó sử dụng các bộ giải mã để nhận dạng thông tin được xử lý (các Windows event, SSHD logs…) và sau đó giải nén các yếu tố dữ liệu thích hợp từ log message (source ip, event id, user…) Sau đó, bằng cách sử dụng các rule được định nghĩa bằng cách pattern đặc biệt trên bộ giải mã, nó sẽ tạo các ngưỡng cảnh báo thậm chí ra lệnh để thực hiện các biện pháp đối phó như chặn IP trên firewall.</li><li><strong>RESTful API</strong> : Cung cấp interface để quản lý và giám sát cấ hình và trạng thái triển khai của các agent. Nó cũng được dùng bởi Wazuh web interface (Kibana)</li></ul><p>Wazuh tích hợp với Elastic stack để cung cấp các log message đã được giải mã và đánh index bởi Elasticsearch, cũng như là 1 web console real-time cho việc cảnh báo và phân tích log. Wazuh web interface (chạy trên Kibana) có thể dùng để quản lý và giám sát hạ tầng Wazuh</p><p>Một Elasticsearch index là một tập hợp các document có một chút các đặc trưng tương tự nhau (như các trường chung hoặc các yêu cầu về data retention được chia sẻ). Wazuh sử dụng 3 index khác nhau, được tạo hàng ngày và lưu trữ các dạng event khác nhau : </p><ul><li><strong>Wazuh-alert</strong> : Index cho các cảnh báo được sinh ra bởi Wazun server mỗi khi một event ứng với rule tạo ra.</li><li><strong>Wazuh-events</strong> : Index cho tất cả các event (archive data) được nhận từ các agent, bất kể có ứng với rule hay không.</li><li><strong>Wazuh-monitoring</strong>: Index cho dữ liệu liên quan đến trạng thái agent. Nó được dùng bởi web interface cho việc hiển thị agent đã hoặc đang “Active”, “Disconnect” hoặc “Never connected”</li></ul><p>Với các index trên, document là các cảnh báo, archived event hoặc status event riêng lẻ.</p><p>Một Elasticsearcg index được chia tới 1 hoặc nhiều shard, và mỗi shard có thể có 1 hoặc nhiều replica. Mỗi primary và replica shard là 1 Lucene index đơn lẻ. Vì vậy 1 Elasticsearch index được tạo bởi nhiều Lucene index. Khi 1 tìm kiếm chạy trên 1 Elasticsearch index, search đó được xử lý trên các shard song song, và kết quả được merge lại. Việc chia nhỏ các Elasticsearch tới nhiều shard và replica cũng được dùng với Elasticsearch cluster với mục tiêu là mở rộng việc tìm kiếm và HA. Một Elasticsearch cluster single-node thường chỉ có 1 shard mỗi index và không có replica.</p>]]></content>
      
      
      
        <tags>
            
            <tag> Wazuh </tag>
            
            <tag> SOC </tag>
            
            <tag> SIEM </tag>
            
            <tag> IDS/IPS </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
